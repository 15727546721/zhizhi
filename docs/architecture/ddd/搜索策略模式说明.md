# 帖子搜索策略模式说明

## 概述

本项目实现了帖子搜索的策略模式，支持在Elasticsearch和MySQL之间灵活切换，提供了高可用性和灵活性的搜索方案。

## 架构设计

### 策略接口

```java
public interface PostSearchStrategy {
    Page<PostEntity> search(String keyword, Pageable pageable);
    boolean isAvailable();
    String getStrategyName();
}
```

### 策略实现

1. **ElasticsearchSearchStrategy**：基于Elasticsearch的全文搜索
2. **MysqlSearchStrategy**：基于MySQL的简单搜索（兜底方案）

### 策略工厂

`PostSearchStrategyFactory` 负责：
- 根据配置选择默认策略
- 管理所有可用的策略实现
- 提供策略获取和切换功能

## 配置方式

### 1. 启用Elasticsearch（可选）

```yaml
spring:
  elasticsearch:
    enabled: true  # 启用Elasticsearch
    uris: 127.0.0.1:9200  # Elasticsearch地址
```

### 2. 配置搜索策略

```yaml
app:
  post:
    query:
      strategy: elasticsearch  # 可选值: elasticsearch, mysql
```

**策略说明**：
- `elasticsearch`：使用Elasticsearch进行全文搜索（推荐）
- `mysql`：使用MySQL进行简单搜索（兜底方案）

## 策略选择逻辑

### 自动选择逻辑

1. **首选策略**：使用配置文件中的 `app.post.query.strategy` 指定的策略
2. **降级策略**：如果首选策略不可用，按以下优先级自动选择：
   - Elasticsearch（如果启用且可用）
   - MySQL（始终可用，作为最终兜底）

### 运行时降级

如果搜索过程中Elasticsearch失败，系统会自动降级到MySQL进行搜索，确保搜索功能不会中断。

## 使用示例

### 在PostService中使用

```java
@Resource
private PostSearchStrategyFactory searchStrategyFactory;

public Page<PostEntity> searchPostsByTitle(String title, Pageable pageable) {
    PostSearchStrategy strategy = searchStrategyFactory.getStrategy();
    return strategy.search(title, pageable);
}
```

### 手动指定策略

```java
// 使用Elasticsearch策略
PostSearchStrategy esStrategy = searchStrategyFactory.getStrategy("elasticsearch");

// 使用MySQL策略
PostSearchStrategy mysqlStrategy = searchStrategyFactory.getStrategy("mysql");
```

## 策略特点对比

### Elasticsearch策略

**优点**：
- 支持中文分词（IK分词器）
- 支持相关性排序
- 支持高亮显示
- 性能优秀，适合大数据量搜索
- 支持复杂的搜索查询

**缺点**：
- 需要额外的Elasticsearch服务
- 需要维护索引同步
- 配置相对复杂

### MySQL策略

**优点**：
- 无需额外服务
- 实现简单，稳定可靠
- 数据实时性高（无需同步）

**缺点**：
- 使用LIKE查询，性能相对较低
- 不支持分词和相关性排序
- 不适合大数据量搜索

## 最佳实践

### 1. 生产环境

推荐使用Elasticsearch策略，配置如下：

```yaml
spring:
  elasticsearch:
    enabled: true
    uris: your-es-server:9200

app:
  post:
    query:
      strategy: elasticsearch
```

### 2. 开发/测试环境

如果不需要ES功能，可以使用MySQL策略：

```yaml
spring:
  elasticsearch:
    enabled: false

app:
  post:
    query:
      strategy: mysql
```

### 3. 高可用场景

即使配置了Elasticsearch，系统也会自动降级到MySQL，确保搜索功能始终可用。

## 扩展新的搜索策略

如果需要添加新的搜索策略（如Solr、Meilisearch等），只需：

1. 实现 `PostSearchStrategy` 接口
2. 使用 `@Component` 注解注册为Spring Bean
3. 在策略工厂中会自动识别并注册

示例：

```java
@Component
public class SolrSearchStrategy implements PostSearchStrategy {
    @Override
    public Page<PostEntity> search(String keyword, Pageable pageable) {
        // 实现Solr搜索逻辑
    }
    
    @Override
    public boolean isAvailable() {
        // 检查Solr是否可用
    }
    
    @Override
    public String getStrategyName() {
        return "solr";
    }
}
```

## 注意事项

1. **索引同步**：使用Elasticsearch时，需要确保索引数据与数据库保持同步
2. **性能监控**：建议监控搜索性能，根据实际情况选择合适的策略
3. **数据一致性**：ES索引可能存在延迟，对于实时性要求高的场景，可以考虑使用MySQL策略

## 故障排查

### Elasticsearch不可用

如果Elasticsearch不可用，系统会：
1. 记录警告日志
2. 自动降级到MySQL策略
3. 继续提供搜索服务

### 搜索性能问题

如果搜索性能不佳，可以：
1. 检查Elasticsearch集群状态
2. 优化索引配置
3. 考虑使用缓存
4. 切换到MySQL策略进行对比测试

## 相关文件

- 策略接口：`cn.xu.domain.post.model.policy.PostSearchStrategy`
- ES策略：`cn.xu.domain.post.model.policy.impl.ElasticsearchSearchStrategy`
- MySQL策略：`cn.xu.domain.post.model.policy.impl.MysqlSearchStrategy`
- 策略工厂：`cn.xu.domain.post.model.policy.PostSearchStrategyFactory`
- 使用示例：`cn.xu.domain.post.service.PostService.searchPostsByTitle()`
