# 小系统推荐优化方案

## 问题分析

对于小社区系统（用户量 < 1万，日活 < 1000），创建5张用户画像表可能**过度设计**：

### 小系统的特点
- ✅ 用户量少，数据量小
- ✅ 查询性能压力不大
- ✅ 资源有限（服务器、维护成本）
- ✅ 需要快速迭代，简单实现

### 大系统 vs 小系统

| 维度 | 大系统 | 小系统 |
|------|--------|--------|
| 用户量 | > 10万 | < 1万 |
| 日活 | > 1万 | < 1000 |
| 数据量 | 百万级 | 万级 |
| 查询压力 | 高 | 低 |
| 推荐频率 | 高频 | 低频 |
| 画像表 | **必要** | **可选** |

## 推荐方案（按复杂度递增）

### 方案一：Redis缓存优化（推荐⭐）

**最适合小系统**，无需创建新表，只需优化缓存策略。

#### 实现思路
1. 将用户行为数据缓存到Redis
2. 定期刷新缓存（如每天一次）
3. 推荐时优先从缓存读取

#### 优点
- ✅ 无需创建新表
- ✅ 实现简单，改动小
- ✅ 性能提升明显
- ✅ 维护成本低

#### 实现示例

```java
// 缓存用户偏好标签（1小时过期）
String key = "user:profile:tags:" + userId;
List<Long> preferredTags = redisService.get(key);
if (preferredTags == null) {
    // 从数据库计算
    preferredTags = calculateUserPreferredTags(userId);
    redisService.set(key, preferredTags, 3600); // 缓存1小时
}
```

### 方案二：单表简化版（中等复杂度）

只创建**1张核心表**：`user_profile`，存储最关键的画像数据。

#### 表结构（简化版）

```sql
CREATE TABLE `user_profile` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `user_id` BIGINT UNSIGNED NOT NULL,
  `preferred_tags` JSON COMMENT '偏好标签ID列表',
  `preferred_topics` JSON COMMENT '偏好话题ID列表',
  `last_update_time` DATETIME COMMENT '最后更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_id` (`user_id`)
) COMMENT='用户画像表（简化版）';
```

#### 优点
- ✅ 只有1张表，维护简单
- ✅ 存储核心偏好数据
- ✅ 可以逐步扩展

### 方案三：保持现状 + 查询优化（最简单）

不创建新表，只优化现有查询。

#### 优化措施
1. **添加数据库索引**（最重要）
   ```sql
   -- 为推荐查询添加索引
   CREATE INDEX idx_like_user_type ON `like`(user_id, type, status);
   CREATE INDEX idx_favorite_user_type ON `favorite`(user_id, target_type, status);
   ```

2. **使用Redis缓存查询结果**
   ```java
   // 缓存推荐结果（30分钟）
   String cacheKey = "recommend:posts:" + userId;
   List<PostEntity> cached = getFromCache(cacheKey);
   if (cached != null) return cached;
   ```

3. **限制查询范围**
   ```java
   // 只查询最近3个月的交互数据
   WHERE create_time > DATE_SUB(NOW(), INTERVAL 3 MONTH)
   ```

#### 优点
- ✅ 零成本，无需改动数据库
- ✅ 立竿见影的性能提升
- ✅ 适合数据量很小的系统

## 渐进式实施建议

### 阶段一：当前（小系统初期）
- ✅ **使用方案三**：保持现状 + 查询优化
- ✅ 添加必要的数据库索引
- ✅ 使用Redis缓存推荐结果（30分钟-1小时）

### 阶段二：用户量增长（5000-10000用户）
- ✅ **升级到方案一**：Redis缓存用户偏好数据
- ✅ 定时任务每天计算一次用户偏好
- ✅ 推荐时优先从缓存读取

### 阶段三：用户量较大（> 1万用户）
- ✅ **考虑方案二**：创建简化的用户画像表
- ✅ 异步更新画像数据
- ✅ 支持更复杂的推荐算法

### 阶段四：大规模系统（> 10万用户）
- ✅ **使用完整画像表方案**：5张表
- ✅ 实时更新 + 定时批量计算
- ✅ 机器学习推荐算法

## 具体实施建议

### 对于你的小系统，建议：

1. **当前阶段**：使用**方案三**（查询优化 + Redis缓存）
   - 添加数据库索引
   - 缓存推荐结果
   - 限制查询时间范围

2. **如果性能还是不够**：升级到**方案一**（Redis缓存用户偏好）
   - 每天定时计算一次用户偏好
   - 缓存到Redis（1-24小时）
   - 推荐时从缓存读取

3. **暂时不要**创建用户画像表
   - 等用户量增长到一定程度再考虑
   - 避免过早优化

## 性能对比

假设有1000个活跃用户，每天100次推荐请求：

| 方案 | 数据库查询次数 | 响应时间 | 维护成本 |
|------|---------------|---------|---------|
| 现状（无优化） | 500次/请求 | 200-500ms | 低 |
| 方案三（索引+缓存） | 50次/请求 | 50-100ms | 低 |
| 方案一（Redis缓存偏好） | 10次/请求 | 20-50ms | 中 |
| 方案二（画像表） | 5次/请求 | 10-30ms | 中 |
| 完整画像表 | 2次/请求 | 5-15ms | 高 |

**结论**：对于小系统，方案三或方案一已经足够，性价比最高。

