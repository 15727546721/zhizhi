# 积分流水表与会员表设计说明

## 1. 概述

本文档详细描述了知之社区系统中积分流水表与会员表的设计，旨在为后续系统维护和功能扩展提供清晰的技术文档支持。该设计优化了原有的积分系统，提供了更详细的积分变动记录和更完善的会员信息管理。

## 2. 核心设计理念

### 2.1 设计原则
- **完整性**：详细记录每一次积分变动，便于审计和回滚
- **可追溯性**：完整记录积分获取和消费历史
- **透明性**：用户可清楚了解积分来源和用途
- **可扩展性**：支持未来规则调整和功能扩展

### 2.2 系统目标
- 激励用户积极参与社区活动
- 通过等级制度增强用户归属感
- 提供积分消费和兑换机制
- 支持积分规则的灵活调整
- 提供完整的积分变动审计功能

## 3. 核心概念

### 3.1 积分流水（Point Transaction）
积分流水记录用户每次积分变动的详细信息，包括积分的获得和消费，用于审计和回滚操作。

### 3.2 会员（Member）
会员信息存储用户当前的积分余额、历史总获得积分和等级信息。

### 3.3 积分变动类型配置（Point Change Type Config）
积分变动类型配置用于管理不同积分变动类型的规则，包括默认积分值和每日限制次数。

## 4. 数据库设计

### 4.1 积分流水表（point_transaction）
用来记录每一次积分变动，方便审计和回滚。

主要字段：
- `id`：主键ID
- `user_id`：用户ID
- `change_amount`：积分变动数量，正负数
- `change_type`：变动类型：签到、下单、退款、手动调整等
- `order_id`：关联订单ID，可空
- `description`：变动描述
- `balance_after`：变动后余额
- `status`：状态：1-成功，2-失败，3-补偿中
- `related_id`：关联ID（如评论ID、文章ID等）
- `create_time`：变动时间
- `update_time`：更新时间

### 4.2 会员表（member）
存储用户当前积分余额和等级。

主要字段：
- `id`：主键ID
- `user_id`：用户ID
- `current_points`：当前积分余额
- `total_earned_points`：历史总获得积分
- `level`：会员等级
- `level_name`：等级名称
- `current_exp`：当前经验值
- `next_level_exp`：下一级所需经验值
- `status`：状态：1-正常，2-冻结
- `level_updated_at`：等级更新时间
- `last_earned_at`：最后获得积分时间
- `create_time`：创建时间
- `update_time`：更新时间

### 4.3 积分变动类型配置表（point_change_type_config）
存储积分变动类型的配置信息。

主要字段：
- `id`：主键ID
- `change_type`：变动类型编码
- `change_name`：变动类型名称
- `point_value`：默认积分值
- `daily_limit`：每日限制次数，-1表示无限制
- `description`：描述
- `is_active`：是否启用：1-启用，0-禁用
- `create_time`：创建时间
- `update_time`：更新时间

## 5. 积分规则

### 5.1 获取积分规则

#### 平台活跃值
| 动作 | 积分值 | 单日积分上限 | 备注 |
|------|--------|--------------|------|
| 点赞 | 1 | 上限1次 | 点赞文章/交流/问题/评论/回复可获得 |
| 收藏 | 1 | 上限1次 | 收藏文章/交流/问题可获得 |
| 发布 | 5 | 上限2次 | 发布文章/交流/问题/评论/回复可获得 |
| 关注 | 3 | 上限1次 | 关注其他用户，本人可获得 |
| 信息完善 | 5 | 仅第一次可获取 | 绑定手机号、上传头像、修改个人昵称 |
| 成为会员 | 10 | 无上限 | 成为/续费会员可获得 |
| 邀请推广 | 10 | 无上限 | 邀请好友成为会员可获得 |
| 购买/兑换课程 | 5 | 无上限 | 购买/兑换单个课程加分 |

#### 平台影响力
| 动作 | 积分值 | 单日积分上限 | 备注 |
|------|--------|--------------|------|
| 被点赞 | 1 | 无上限 | 文章/交流/问题/评论/回复被点赞可获得 |
| 被收藏 | 1 | 无上限 | 文章/交流/问题被收藏可获得 |
| 帖子被精选 | 20 | 无上限 | 文章/交流/问题被精选 |
| 评论被精选 | 10 | 无上限 | 评论/回复被精选 |
| 被关注 | 3 | 无上限 | 被其他用户关注可获得 |
| 回答被采纳 | 10 | 无上限 | 「问题」板块的回答被采纳 |
| 被推荐 | 5 | 无上限 | 文章/交流/问题被推荐可获得 |

### 5.2 积分变动类型定义
- LIKE_GIVE（点赞）
- LIKE_RECEIVE（被点赞）
- FAVORITE_GIVE（收藏）
- FAVORITE_RECEIVE（被收藏）
- PUBLISH（发布）
- FOLLOW_GIVE（关注）
- FOLLOW_RECEIVE（被关注）
- INFO_COMPLETE（信息完善）
- VIP_JOIN（成为会员）
- INVITE（邀请推广）
- BUY_COURSE（购买课程）
- POST_FEATURED（帖子被精选）
- COMMENT_FEATURED（评论被精选）
- ANSWER_ACCEPTED（回答被采纳）
- POST_RECOMMENDED（被推荐）

## 6. 等级规则

| 等级 | 所需积分 |
|------|----------|
| 1 | 0 |
| 2 | 25 |
| 3 | 200 |
| 4 | 500 |
| 5 | 1000 |
| 6 | 2000 |
| 7 | 4000 |

## 7. 系统特性

### 7.1 积分管理
- 实时记录积分获取和消费
- 支持积分余额查询
- 提供积分变动历史查询
- 提供积分变动审计功能

### 7.2 等级计算
- 基于历史总获得积分计算用户等级
- 自动升级机制
- 等级权益展示

### 7.3 数据统计
- 用户积分排行榜
- 积分获取途径统计
- 积分消费情况分析

## 8. 技术实现要点

### 8.1 数据一致性
- 使用事务确保积分变动和记录的一致性
- 积分余额与记录总和保持一致

### 8.2 性能优化
- 积分查询使用索引优化
- 批量操作支持

### 8.3 扩展性设计
- 积分规则可配置化
- 动作类型可扩展
- 等级规则可调整

## 9. 后续维护建议

### 9.1 规则调整
- 积分获取规则可根据运营需要调整
- 等级门槛可根据用户成长情况优化

### 9.2 功能扩展
- 积分商城功能
- 等级专属权益
- 积分赠送和转账功能

### 9.3 数据分析
- 定期分析积分获取和消费数据
- 优化积分规则以提高用户活跃度
- 监控异常积分变动情况