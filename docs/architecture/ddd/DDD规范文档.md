# DDD架构规范文档

## 1. 概述

本文档定义了知之项目中领域驱动设计（DDD）的实施规范，旨在确保项目各模块遵循统一的架构原则和编码规范，提高代码质量和可维护性。

## 2. 架构分层规范

### 2.1 分层结构
项目遵循标准的DDD四层架构：
- **用户接口层（User Interface Layer）**：负责向用户展示信息和处理用户交互
- **应用层（Application Layer）**：负责业务流程编排和事务管理
- **领域层（Domain Layer）**：负责核心业务逻辑处理
- **基础设施层（Infrastructure Layer）**：负责技术细节实现

### 2.2 依赖倒置原则
- 应用层必须通过领域层定义的仓储接口进行依赖，禁止直接依赖基础设施层的具体实现类
- 领域层不应依赖基础设施层的具体实现
- 基础设施层可以依赖领域层

## 3. 命名规范

### 3.1 方法命名规范
- **查询单个实体**: `findById`
- **查询多个实体**: `findAll` 或 `findByXxx`
- **保存/更新实体**: `save`
- **删除实体**: `deleteById` 或 `deleteByXxx`

### 3.2 返回类型规范
- 查询单个实体时返回`Optional<T>`类型（更好的空值处理）
- 查询多个实体时返回`List<T>`类型
- 保存操作返回实体ID（Long类型）
- 更新和删除操作返回void或影响行数

## 4. CRUD操作规范

### 4.1 Create（创建）
- 使用`save`方法处理实体创建
- 方法签名：`T save(T entity)`

### 4.2 Read（读取）
- 使用`findById`、`findAll`等方法处理查询
- 方法签名：
  - `Optional<T> findById(Long id)`
  - `List<T> findAll()`
  - `List<T> findByXxx(parameters)`

### 4.3 Update（更新）
- 使用`save`方法处理实体更新
- 方法签名：`T save(T entity)`

### 4.4 Delete（删除）
- 使用`deleteById`等方法处理删除
- 方法签名：
  - `void deleteById(Long id)`
  - `void deleteByXxx(parameters)`

## 5. 仓储接口规范

### 5.1 接口定义
仓储接口应定义在领域层，遵循以下规范：
```java
public interface IRepository {
    /**
     * 保存实体
     */
    T save(T entity);
    
    /**
     * 根据ID查找实体
     */
    Optional<T> findById(Long id);
    
    /**
     * 查询所有实体
     */
    List<T> findAll();
    
    /**
     * 根据ID删除实体
     */
    void deleteById(Long id);
}
```

### 5.2 实现类规范
仓储实现类应定义在基础设施层，遵循以下规范：
- 类名以`RepositoryImpl`或`Repository`结尾
- 使用`@Repository`注解标记
- 实现领域层定义的仓储接口
- 所有接口方法必须使用`@Override`注解

## 6. 服务分层职责规范

### 6.1 应用服务层
- 负责业务流程编排和事务管理
- 协调多个领域服务完成复杂业务操作
- 不包含核心业务逻辑

### 6.2 领域服务层
- 负责核心业务逻辑处理
- 生成和处理领域事件
- 包含业务规则验证

### 6.3 监听器
- 不得直接操作数据库
- 领域事件处理应通过领域服务完成
- 确保事务一致性

## 7. 编码规范

### 7.1 变量命名
- 使用驼峰命名法
- 变量名应具有业务含义

### 7.2 时间字段命名
- 时间字段采用`create_time`格式，而不是`created_at`

### 7.3 资源连接管理
- 所有资源连接操作必须正确管理连接生命周期
- 推荐使用try-with-resources等机制确保连接正确关闭
- 避免使用原生连接API和可能导致连接泄漏的方法

## 8. 缓存操作规范

### 8.1 Redis缓存更新
- 采用增量更新方式
- 避免每次都清空再重建
- 确保缓存仓储类与业务层的协同一致性

## 9. HTTP方法使用规范

### 9.1 帖子领域接口
- 所有帖子领域接口必须使用POST或GET作为请求方式
- POST方法用于创建、更新、删除操作
- GET方法用于查询和获取数据
- 其他HTTP方法一律不支持

## 10. 参数校验规范

### 10.1 帖子查询校验
- 分页参数校验：确保页码和页面大小在有效范围内
- 参数边界保护：防止无效参数导致异常或性能问题
- 数据一致性保证

### 10.2 分页参数规则
- 页码必须大于0
- 页面大小在1-100之间

## 11. 异常处理规范

### 11.1 业务异常
- 使用自定义业务异常类
- 异常信息应包含业务含义

### 11.2 系统异常
- 统一异常处理机制
- 详细的错误日志记录

## 12. 代码注释规范

### 12.1 接口注释
- 所有公共方法必须包含JavaDoc注释
- 注释应包含方法说明、参数说明和返回值说明

### 12.2 类注释
- 类注释应包含类的业务职责说明
- 标明作者信息

## 13. 测试规范

### 13.1 单元测试
- 每个领域服务应有对应的单元测试
- 测试覆盖率应达到80%以上

### 13.2 集成测试
- 关键业务流程应有集成测试
- 数据库操作应有集成测试验证

## 14. 版本控制规范

### 14.1 提交信息
- 提交信息应包含功能说明
- 遵循统一的提交格式

### 14.2 分支管理
- 功能开发应在独立分支进行
- 合并前应通过代码审查

## 15. 部署规范

### 15.1 环境配置
- 不同环境应有独立的配置文件
- 敏感信息应通过环境变量配置

### 15.2 部署流程
- 部署应通过自动化脚本完成
- 部署后应进行健康检查