# 搜索领域架构说明

## 📋 概述

搜索业务已经按照DDD（领域驱动设计）原则，**独立划分为一个独立的领域（Search Domain）**，与其他领域（如Post、User等）解耦，便于维护和扩展。

## 🏗️ 领域架构

### 1. 领域层（Domain Layer）

**包路径**：`cn.xu.domain.search`

#### 1.1 领域模型（Model）

```
domain/search/model/
├── entity/              # 实体
│   └── SearchQuery.java          # 搜索查询实体
├── valobj/              # 值对象
│   ├── SearchFilter.java         # 搜索筛选条件值对象
│   └── SearchResult.java         # 搜索结果值对象
└── policy/              # 策略/规约
    ├── ISearchStrategy.java      # 搜索策略接口（领域层定义）
    └── SearchStrategyFactory.java # 搜索策略工厂（领域层定义）
```

**核心模型**：
- **SearchQuery**：封装搜索查询信息（关键词、筛选条件、分页参数）
- **SearchFilter**：搜索筛选条件值对象（类型、时间范围、排序方式）
- **SearchResult**：搜索结果值对象
- **ISearchStrategy**：搜索策略接口（策略模式）

#### 1.2 领域服务（Service）

```
domain/search/service/
├── ISearchDomainService.java              # 搜索领域服务接口
├── ISearchStatisticsService.java          # 搜索统计服务接口
└── impl/
    └── SearchDomainServiceImpl.java       # 搜索领域服务实现
```

**核心服务**：
- **ISearchDomainService**：搜索领域服务，负责执行搜索和记录搜索行为
- **ISearchStatisticsService**：搜索统计服务，负责记录搜索统计、热门搜索词等

### 2. 应用层（Application Layer）

**包路径**：`cn.xu.application.service`

```
application/service/
└── SearchApplicationService.java  # 搜索应用服务
```

**职责**：
- 协调搜索领域服务和用户服务
- 转换领域对象为API响应对象（PostSearchResponse）
- 处理搜索结果的业务逻辑（如生成摘要、获取用户信息）

### 3. 基础设施层（Infrastructure Layer）

**包路径**：`cn.xu.infrastructure.search`

```
infrastructure/search/
├── strategy/                    # 搜索策略实现
│   ├── ElasticsearchSearchStrategy.java   # ES搜索策略
│   ├── MysqlSearchStrategy.java           # MySQL搜索策略
│   └── CachedSearchStrategy.java          # 缓存搜索策略（装饰器）
├── service/                     # 服务实现
│   └── SearchStatisticsServiceImpl.java   # 搜索统计服务实现
└── util/                        # 工具类
    └── SearchKeywordNormalizer.java       # 关键词规范化工具
```

**职责**：
- 实现搜索策略接口（ISearchStrategy）
- 实现搜索统计服务（ISearchStatisticsService）
- 提供搜索相关的工具类

### 4. 接口层（Interface Layer）

**包路径**：`cn.xu.api.web.controller`

```
api/web/controller/
├── PostController.java          # 帖子控制器（包含搜索接口）
└── PostSearchController.java    # 搜索专用控制器
```

**职责**：
- 提供RESTful API接口
- 参数校验和转换
- 限流和安全性检查

## 🔄 领域依赖关系

### 依赖方向

```
接口层 (Controller)
    ↓ 依赖
应用层 (Application Service)
    ↓ 依赖
领域层 (Domain Service)
    ↑ 实现
基础设施层 (Infrastructure)
```

### 领域间依赖

**Search领域依赖Post领域**：
- `SearchDomainService` 返回 `PostEntity`（搜索结果）
- 这是合理的，因为搜索的业务对象是Post

**Search领域不依赖User领域**：
- 搜索领域只负责搜索逻辑
- 用户信息的获取在应用层处理（SearchApplicationService）

## 📦 领域独立性

### ✅ 独立性体现

1. **独立的领域模型**：
   - SearchFilter、SearchQuery、SearchResult都是搜索领域特有的
   - 不依赖其他领域的内部实现

2. **独立的领域服务**：
   - ISearchDomainService：专注于搜索逻辑
   - ISearchStatisticsService：专注于搜索统计

3. **独立的策略模式**：
   - ISearchStrategy接口定义在领域层
   - 具体实现（ES、MySQL）在基础设施层
   - 可以通过配置切换搜索策略

4. **清晰的边界**：
   - 搜索领域只负责搜索相关的业务逻辑
   - 不包含帖子管理、用户管理等其他业务逻辑

### 🔗 与其他领域的交互

**与Post领域的交互**：
- 搜索领域返回PostEntity（这是合理的依赖）
- 搜索领域不直接操作Post领域的数据
- 通过事件监听Post领域的事件（PostCreatedEvent、PostUpdatedEvent等）来同步索引

**与User领域的交互**：
- 搜索领域不直接依赖User领域
- 在应用层（SearchApplicationService）中获取用户信息
- 保持领域间的解耦

## 🛠️ 维护优势

### 1. 单一职责
- 搜索领域只负责搜索相关的业务逻辑
- 代码职责清晰，易于理解

### 2. 易于扩展
- 可以轻松添加新的搜索策略（如Solr、Meilisearch等）
- 可以独立扩展搜索统计功能
- 可以独立优化搜索性能

### 3. 易于测试
- 领域服务可以独立测试
- 策略可以独立测试
- 不依赖其他领域的具体实现

### 4. 易于维护
- 搜索相关的代码都在独立的包中
- 修改搜索逻辑不影响其他领域
- 问题定位更容易

### 5. 符合DDD原则
- 领域模型清晰
- 领域服务职责明确
- 基础设施关注点分离

## 📊 领域模型关系图

```
┌─────────────────────────────────────────┐
│           Search Domain                  │
│                                         │
│  ┌──────────────────────────────────┐  │
│  │     SearchDomainService          │  │
│  │  - executeSearch()               │  │
│  │  - recordSearch()                │  │
│  └──────────────────────────────────┘  │
│              │                          │
│              ▼                          │
│  ┌──────────────────────────────────┐  │
│  │     ISearchStrategy              │  │
│  │  (策略接口，定义在领域层)        │  │
│  └──────────────────────────────────┘  │
│              │                          │
│  ┌──────────────────────────────────┐  │
│  │  SearchStatisticsService         │  │
│  │  - recordSearch()                │  │
│  │  - getHotKeywords()              │  │
│  │  - getSearchSuggestions()        │  │
│  └──────────────────────────────────┘  │
│                                         │
│  ┌──────────────────────────────────┐  │
│  │     Value Objects                │  │
│  │  - SearchFilter                  │  │
│  │  - SearchResult                  │  │
│  │  - SearchQuery                   │  │
│  └──────────────────────────────────┘  │
└─────────────────────────────────────────┘
              │
              │ 返回 PostEntity
              ▼
┌─────────────────────────────────────────┐
│           Post Domain                    │
│  (搜索的业务对象)                        │
└─────────────────────────────────────────┘
```

## 🎯 总结

### ✅ 搜索领域已独立划分

1. **领域层**：定义了搜索领域的核心模型和服务
2. **应用层**：协调搜索领域和其他领域（如User领域）
3. **基础设施层**：实现搜索策略和统计服务
4. **接口层**：提供RESTful API

### ✅ 维护优势

1. **代码组织清晰**：搜索相关代码都在独立包中
2. **职责单一**：搜索领域只负责搜索逻辑
3. **易于扩展**：可以轻松添加新的搜索策略
4. **易于测试**：领域服务可以独立测试
5. **符合DDD原则**：领域模型清晰，关注点分离

### 📝 后续维护建议

1. **保持领域独立性**：
   - 不要在搜索领域中加入其他业务逻辑
   - 保持与其他领域的清晰边界

2. **扩展搜索功能**：
   - 新增搜索策略：在基础设施层实现ISearchStrategy
   - 新增搜索功能：在领域层添加新的领域服务方法

3. **优化搜索性能**：
   - 优化缓存策略：修改CachedSearchStrategy
   - 优化搜索算法：修改具体的搜索策略实现

4. **监控和维护**：
   - 监控搜索性能和错误率
   - 定期检查搜索统计和热门搜索词
   - 关注ES索引同步状态

## 📚 相关文档

- 搜索功能使用指南：`docs/搜索功能使用指南.md`
- 搜索功能实现总结：`docs/搜索功能实现总结.md`
- DDD规范文档：`docs/architecture/ddd/DDD规范文档.md`

