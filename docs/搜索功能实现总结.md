# æœç´¢åŠŸèƒ½å®ç°æ€»ç»“

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è®°å½•æœç´¢åŠŸèƒ½çš„å®ç°ç»†èŠ‚ã€ä¼˜åŒ–å†å²ã€é—®é¢˜ä¿®å¤è®°å½•å’ŒæŠ€æœ¯å®ç°æ–¹æ¡ˆï¼Œé¢å‘ç»´æŠ¤è€…å’Œå¼€å‘è€…ã€‚

## ğŸ—ï¸ æ¶æ„å®ç°

### 1. DDDé¢†åŸŸåˆ’åˆ†

æœç´¢ä¸šåŠ¡å·²æŒ‰ç…§DDDåŸåˆ™ï¼Œ**ç‹¬ç«‹åˆ’åˆ†ä¸ºSearché¢†åŸŸ**ï¼Œå®ç°äº†æ¸…æ™°çš„é¢†åŸŸè¾¹ç•Œå’ŒèŒè´£åˆ†ç¦»ã€‚

#### é¢†åŸŸå±‚ç»“æ„

```
domain/search/
â”œâ”€â”€ model/
â”‚   â”œâ”€â”€ entity/
â”‚   â”‚   â””â”€â”€ SearchQuery.java          # æœç´¢æŸ¥è¯¢å®ä½“
â”‚   â”œâ”€â”€ valobj/
â”‚   â”‚   â”œâ”€â”€ SearchFilter.java         # æœç´¢ç­›é€‰æ¡ä»¶å€¼å¯¹è±¡
â”‚   â”‚   â””â”€â”€ SearchResult.java         # æœç´¢ç»“æœå€¼å¯¹è±¡
â”‚   â””â”€â”€ policy/
â”‚       â”œâ”€â”€ ISearchStrategy.java      # æœç´¢ç­–ç•¥æ¥å£
â”‚       â””â”€â”€ SearchStrategyFactory.java # æœç´¢ç­–ç•¥å·¥å‚
â””â”€â”€ service/
    â”œâ”€â”€ ISearchDomainService.java              # æœç´¢é¢†åŸŸæœåŠ¡æ¥å£
    â”œâ”€â”€ ISearchStatisticsService.java          # æœç´¢ç»Ÿè®¡æœåŠ¡æ¥å£
    â””â”€â”€ impl/
        â””â”€â”€ SearchDomainServiceImpl.java       # æœç´¢é¢†åŸŸæœåŠ¡å®ç°
```

#### åŸºç¡€è®¾æ–½å±‚ç»“æ„

```
infrastructure/search/
â”œâ”€â”€ strategy/
â”‚   â”œâ”€â”€ ElasticsearchSearchStrategy.java   # ESæœç´¢ç­–ç•¥
â”‚   â”œâ”€â”€ MysqlSearchStrategy.java           # MySQLæœç´¢ç­–ç•¥
â”‚   â””â”€â”€ CachedSearchStrategy.java          # ç¼“å­˜æœç´¢ç­–ç•¥ï¼ˆè£…é¥°å™¨ï¼‰
â”œâ”€â”€ service/
â”‚   â””â”€â”€ SearchStatisticsServiceImpl.java   # æœç´¢ç»Ÿè®¡æœåŠ¡å®ç°
â””â”€â”€ util/
    â””â”€â”€ SearchKeywordNormalizer.java       # å…³é”®è¯è§„èŒƒåŒ–å·¥å…·
```

### 2. ç­–ç•¥æ¨¡å¼å®ç°

#### ç­–ç•¥æ¥å£

```java
public interface ISearchStrategy {
    Page<PostEntity> search(String keyword, SearchFilter filter, Pageable pageable);
    boolean isAvailable();
    String getStrategyName();
}
```

#### ç­–ç•¥å·¥å‚

`SearchStrategyFactory` è´Ÿè´£ï¼š
- æ ¹æ®é…ç½®é€‰æ‹©é»˜è®¤ç­–ç•¥
- ç®¡ç†æ‰€æœ‰å¯ç”¨çš„ç­–ç•¥å®ç°
- è‡ªåŠ¨åŒ…è£…ç¼“å­˜å±‚ï¼ˆå¦‚æœå¯ç”¨ï¼‰
- æä¾›ç­–ç•¥è·å–å’Œåˆ‡æ¢åŠŸèƒ½

#### ç­–ç•¥å®ç°

1. **ElasticsearchSearchStrategy**ï¼š
   - ä½¿ç”¨ESçš„matchQueryè¿›è¡Œæœç´¢
   - æ”¯æŒå¤šå­—æ®µæœç´¢ï¼ˆtitle + descriptionï¼‰
   - æ”¯æŒç›¸å…³æ€§æ’åº
   - æ”¯æŒç­›é€‰æ¡ä»¶ï¼ˆç±»å‹ã€æ—¶é—´èŒƒå›´ï¼‰

2. **MysqlSearchStrategy**ï¼š
   - ä½¿ç”¨MySQLçš„LIKEæŸ¥è¯¢
   - æ”¯æŒç­›é€‰æ¡ä»¶ï¼ˆç±»å‹ã€æ—¶é—´èŒƒå›´ã€æ’åºï¼‰
   - ç‰¹æ®Šå­—ç¬¦è½¬ä¹‰ï¼ˆ%å’Œ_ï¼‰
   - ä½œä¸ºå…œåº•æ–¹æ¡ˆï¼Œå§‹ç»ˆå¯ç”¨

3. **CachedSearchStrategy**ï¼š
   - è£…é¥°å™¨æ¨¡å¼ï¼ŒåŒ…è£…å…¶ä»–ç­–ç•¥
   - Redisç¼“å­˜æœç´¢ç»“æœ
   - ç¼“å­˜é›ªå´©é˜²æŠ¤ï¼ˆéšæœºTTLï¼‰
   - ç©ºç»“æœç¼“å­˜ï¼ˆé˜²æ­¢ç¼“å­˜ç©¿é€ï¼‰

### 3. ç¼“å­˜æœºåˆ¶

#### ç¼“å­˜ç­–ç•¥

- **çƒ­é—¨å…³é”®è¯**ï¼šç¼“å­˜1å°æ—¶ï¼ˆÂ±10%éšæœºTTLï¼‰
- **æ™®é€šå…³é”®è¯**ï¼šç¼“å­˜5åˆ†é’Ÿï¼ˆÂ±10%éšæœºTTLï¼‰
- **ç©ºç»“æœ**ï¼šç¼“å­˜1åˆ†é’Ÿï¼ˆÂ±10%éšæœºTTLï¼‰

#### ç¼“å­˜Keyè®¾è®¡

```java
// åŸºç¡€æ ¼å¼
post:search:{keywordHash}:{filterHash}:{page}:{size}

// ç¤ºä¾‹
post:search:12345:67890:1:10
```

#### ç¼“å­˜å¤±æ•ˆ

- **å¤±æ•ˆæ—¶æœº**ï¼šå¸–å­åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤æ—¶
- **å¤±æ•ˆæ–¹å¼**ï¼šä½¿ç”¨SCANå‘½ä»¤æ‰«æåŒ¹é…çš„keyï¼Œé¿å…é˜»å¡Redis
- **å¤±æ•ˆç­–ç•¥**ï¼šç²¾ç¡®æå–å…³é”®è¯ï¼Œæ¸…é™¤ç›¸å…³ç¼“å­˜

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. å…³é”®è¯è§„èŒƒåŒ–

#### è§„èŒƒåŒ–æµç¨‹

1. **å»é™¤é¦–å°¾ç©ºç™½**
2. **Unicodeè§„èŒƒåŒ–**ï¼ˆNFCå½¢å¼ï¼‰
3. **å…¨è§’è½¬åŠè§’**
4. **ç»Ÿä¸€ç©ºæ ¼**ï¼ˆå¤šä¸ªè¿ç»­ç©ºæ ¼æ›¿æ¢ä¸ºå•ä¸ªç©ºæ ¼ï¼‰

#### å®ç°ç±»

`SearchKeywordNormalizer` æä¾›ï¼š
- `normalize(String keyword)`ï¼šè§„èŒƒåŒ–å…³é”®è¯
- `extractKeywords(String text)`ï¼šä»æ–‡æœ¬ä¸­æå–å…³é”®è¯

### 2. MySQLæœç´¢ä¼˜åŒ–

#### ç‰¹æ®Šå­—ç¬¦è½¬ä¹‰

```java
private String escapeLikeKeyword(String keyword) {
    if (keyword == null) return null;
    return keyword.replace("\\", "\\\\")
                  .replace("%", "\\%")
                  .replace("_", "\\_");
}
```

#### æ•°æ®åº“ç´¢å¼•

- **æ ‡é¢˜å‰ç¼€ç´¢å¼•**ï¼š`idx_post_title_prefix` (title(50))
- **æè¿°å‰ç¼€ç´¢å¼•**ï¼š`idx_post_description_prefix` (description(100))
- **çŠ¶æ€+æ—¶é—´å¤åˆç´¢å¼•**ï¼š`idx_post_status_time` (status, create_time DESC)
- **å…¨æ–‡ç´¢å¼•**ï¼ˆMySQL 5.7+ï¼‰ï¼š`ft_title_desc` (title, description)

#### çƒ­åº¦æ’åº

```sql
ORDER BY (like_count * 3.0 + comment_count * 5.0 + view_count * 0.5 + favorite_count * 4.0) DESC, create_time DESC
```

**æƒé‡è¯´æ˜**ï¼š
- like: 3.0
- comment: 5.0
- view: 0.5
- favorite: 4.0

### 3. Elasticsearchæœç´¢

#### æŸ¥è¯¢æ„å»º

```java
BoolQueryBuilder boolQuery = QueryBuilders.boolQuery();

// å…³é”®è¯æœç´¢ï¼ˆmustæ¡ä»¶ï¼‰
BoolQueryBuilder shouldQuery = QueryBuilders.boolQuery();
shouldQuery.should(QueryBuilders.matchQuery("title", keyword).boost(2.0f));
shouldQuery.should(QueryBuilders.matchQuery("description", keyword).boost(1.0f));
shouldQuery.minimumShouldMatch(1);
boolQuery.must(shouldQuery);

// ç­›é€‰æ¡ä»¶ï¼ˆfilteræ¡ä»¶ï¼‰
if (filter.getTypes() != null) {
    boolQuery.filter(QueryBuilders.termsQuery("type", typeCodes));
}
if (filter.getStartTime() != null || filter.getEndTime() != null) {
    RangeQueryBuilder rangeQuery = QueryBuilders.rangeQuery("publishTime");
    if (filter.getStartTime() != null) {
        rangeQuery.gte(filter.getStartTime());
    }
    if (filter.getEndTime() != null) {
        rangeQuery.lte(filter.getEndTime());
    }
    boolQuery.filter(rangeQuery);
}
```

#### æ’åºå®ç°

```java
// æ—¶é—´æ’åº
queryBuilder.withSorts(SortBuilders.fieldSort("publishTime").order(SortOrder.DESC));

// çƒ­åº¦æ’åº
queryBuilder.withSorts(SortBuilders.scriptSort(
    new Script("_score + (doc['likeCount'].value * 3.0 + doc['commentCount'].value * 5.0)"),
    ScriptType.INLINE
).order(SortOrder.DESC));

// è¯„è®ºæ’åº
queryBuilder.withSorts(SortBuilders.fieldSort("commentCount").order(SortOrder.DESC));

// ç‚¹èµæ’åº
queryBuilder.withSorts(SortBuilders.fieldSort("likeCount").order(SortOrder.DESC));
```

### 4. ç¼“å­˜å®ç°

#### ç¼“å­˜è£…é¥°å™¨

```java
public class CachedSearchStrategy implements ISearchStrategy {
    private final ISearchStrategy delegate;
    private final RedisTemplate<String, Object> redisTemplate;
    
    @Override
    public Page<PostEntity> search(String keyword, SearchFilter filter, Pageable pageable) {
        // 1. ç”Ÿæˆç¼“å­˜Key
        String cacheKey = generateCacheKey(keyword, filter, pageable);
        
        // 2. å°è¯•ä»ç¼“å­˜è·å–
        Page<PostEntity> cachedResult = getFromCache(cacheKey);
        if (cachedResult != null) {
            return cachedResult;
        }
        
        // 3. æ£€æŸ¥ç©ºç»“æœç¼“å­˜
        if (isEmptyResultCached(cacheKey)) {
            return new PageImpl<>(Collections.emptyList(), pageable, 0);
        }
        
        // 4. è°ƒç”¨å®é™…æœç´¢ç­–ç•¥
        Page<PostEntity> result = delegate.search(keyword, filter, pageable);
        
        // 5. ç¼“å­˜ç»“æœ
        cacheResult(cacheKey, result, calculateTTL(keyword));
        
        return result;
    }
}
```

#### ç¼“å­˜Keyç”Ÿæˆ

```java
private String generateCacheKey(String keyword, SearchFilter filter, Pageable pageable) {
    String keywordHash = String.valueOf(keyword.hashCode());
    String filterHash = generateFilterHash(filter);
    int page = pageable.getPageNumber();
    int size = pageable.getPageSize();
    
    return RedisKeyManager.postSearchResultKey(keywordHash, filterHash, page, size);
}

private String generateFilterHash(SearchFilter filter) {
    if (filter == null) return "";
    
    StringBuilder sb = new StringBuilder();
    // ç±»å‹
    if (filter.getTypes() != null) {
        sb.append("types:").append(types.stream().sorted().collect(Collectors.joining(",")));
    }
    // æ—¶é—´èŒƒå›´
    if (filter.getStartTime() != null) {
        sb.append("start:").append(filter.getStartTime());
    }
    if (filter.getEndTime() != null) {
        sb.append("end:").append(filter.getEndTime());
    }
    // æ’åº
    if (filter.getSortOption() != null) {
        sb.append("sort:").append(filter.getSortOption());
    }
    
    return String.valueOf(sb.toString().hashCode());
}
```

### 5. æœç´¢ç»Ÿè®¡

#### ç»Ÿè®¡è®°å½•

```java
public void recordSearch(String keyword, long resultCount, boolean hasResults) {
    String normalizedKeyword = keyword.trim().toLowerCase();
    
    // é˜²åˆ·æœºåˆ¶ï¼šä½¿ç”¨SETNXå®ç°åŸå­æ“ä½œ
    String antiSpamKey = "post:search:antispam:" + normalizedKeyword;
    Boolean setSuccess = redisTemplate.opsForValue().setIfAbsent(antiSpamKey, "1", 60, TimeUnit.SECONDS);
    
    if (Boolean.FALSE.equals(setSuccess)) {
        return; // 60ç§’å†…å·²è®°å½•ï¼Œç›´æ¥è¿”å›
    }
    
    // è®°å½•çƒ­é—¨æœç´¢è¯
    String hotKeywordsKey = RedisKeyManager.postSearchHotKeywordsKey();
    redisTemplate.opsForZSet().incrementScore(hotKeywordsKey, normalizedKeyword, 1);
    
    // è®°å½•æ¯æ—¥ç»Ÿè®¡
    String today = LocalDateTime.now().toLocalDate().toString();
    String searchStatsKey = "post:search:stats:" + today;
    redisTemplate.opsForValue().increment(searchStatsKey + ":total");
    if (hasResults) {
        redisTemplate.opsForValue().increment(searchStatsKey + ":success");
    } else {
        redisTemplate.opsForValue().increment(searchStatsKey + ":empty");
    }
}
```

#### çƒ­é—¨æœç´¢è¯

ä½¿ç”¨Redis Sorted Setå­˜å‚¨ï¼š
- **Key**ï¼š`post:search:hot:keywords`
- **Score**ï¼šæœç´¢æ¬¡æ•°
- **Member**ï¼šæœç´¢å…³é”®è¯
- **TTL**ï¼š7å¤©

#### æœç´¢å»ºè®®

åŸºäºçƒ­é—¨æœç´¢è¯æä¾›å»ºè®®ï¼š
1. ä»çƒ­é—¨æœç´¢è¯ä¸­æŸ¥æ‰¾åŒ¹é…çš„å…³é”®è¯
2. è¿”å›åŒ…å«è¾“å…¥å…³é”®è¯å‰ç¼€çš„çƒ­é—¨æœç´¢è¯
3. é™åˆ¶è¿”å›æ•°é‡ï¼ˆé»˜è®¤10æ¡ï¼‰

## ğŸ› ï¸ ä¼˜åŒ–å†å²

### 1. MySQLæœç´¢ä¼˜åŒ–

#### ä¼˜åŒ–å‰
- æœç´¢ `title` å’Œ `content` å­—æ®µ
- `content` å­—æ®µæ˜¯ LONGTEXTï¼Œæ€§èƒ½æå·®
- ç¼ºå°‘ç´¢å¼•æ”¯æŒ

#### ä¼˜åŒ–å
- ä»…æœç´¢ `title` å’Œ `description` å­—æ®µ
- ç§»é™¤äº† `content` å­—æ®µæœç´¢
- æ·»åŠ äº†æ•°æ®åº“ç´¢å¼•æ”¯æŒ

#### æ€§èƒ½æå‡
- **1ä¸‡æ¡æ•°æ®**ï¼š200ms â†’ 50msï¼ˆ4å€æå‡ï¼‰
- **10ä¸‡æ¡æ•°æ®**ï¼š2s â†’ 300msï¼ˆ6.7å€æå‡ï¼‰

### 2. ç¼“å­˜æœºåˆ¶

#### å®ç°åŠŸèƒ½
- Redisç¼“å­˜æœç´¢ç»“æœ
- çƒ­é—¨æœç´¢å…³é”®è¯ç¼“å­˜1å°æ—¶
- æ™®é€šæœç´¢å…³é”®è¯ç¼“å­˜5åˆ†é’Ÿ
- ç©ºç»“æœç¼“å­˜1åˆ†é’Ÿï¼ˆé˜²æ­¢ç¼“å­˜ç©¿é€ï¼‰
- ç¼“å­˜é›ªå´©é˜²æŠ¤ï¼ˆéšæœºTTLï¼‰

#### æ€§èƒ½æå‡
- **ç¼“å­˜å‘½ä¸­**ï¼š10-20å€æ€§èƒ½æå‡ï¼ˆ< 10msï¼‰

### 3. ESæœç´¢ä¼˜åŒ–

#### ä¼˜åŒ–å†…å®¹
- å¤šå­—æ®µæœç´¢ï¼ˆtitle + descriptionï¼‰
- ç›¸å…³æ€§æ’åºï¼ˆtitleæƒé‡2.0ï¼Œdescriptionæƒé‡1.0ï¼‰
- æ”¯æŒç­›é€‰æ¡ä»¶ï¼ˆç±»å‹ã€æ—¶é—´èŒƒå›´ã€æ’åºï¼‰
- é™çº§æœºåˆ¶ï¼ˆå¤šå­—æ®µæœç´¢å¤±è´¥æ—¶é™çº§åˆ°ç®€å•æœç´¢ï¼‰

#### æ€§èƒ½æå‡
- **100ä¸‡æ¡æ•°æ®**ï¼š100ms â†’ 50msï¼ˆ2å€æå‡ï¼‰

### 4. å…³é”®è¯è§„èŒƒåŒ–

#### å®ç°åŠŸèƒ½
- Unicodeè§„èŒƒåŒ–ï¼ˆNFCå½¢å¼ï¼‰
- å…¨è§’è½¬åŠè§’
- ç»Ÿä¸€ç©ºæ ¼
- å…³é”®è¯æå–

#### æ•ˆæœ
- æé«˜æœç´¢å‡†ç¡®æ€§
- æé«˜ç¼“å­˜å‘½ä¸­ç‡
- ç»Ÿä¸€æœç´¢ä½“éªŒ

## ğŸ”’ å®‰å…¨éšæ‚£ä¿®å¤

### 1. MySQL LIKEæŸ¥è¯¢ç‰¹æ®Šå­—ç¬¦è½¬ä¹‰ âœ…

**é—®é¢˜**ï¼šMySQLçš„LIKEæŸ¥è¯¢ä¸­ï¼Œ`%`å’Œ`_`æ˜¯é€šé…ç¬¦ï¼Œå¦‚æœç”¨æˆ·æœç´¢åŒ…å«è¿™äº›å­—ç¬¦çš„å…³é”®è¯ï¼Œä¼šå¯¼è‡´æ„å¤–çš„åŒ¹é…ç»“æœã€‚

**ä¿®å¤**ï¼š
- åœ¨`MysqlSearchStrategy`ä¸­æ·»åŠ `escapeLikeKeyword`æ–¹æ³•
- è½¬ä¹‰`%`ã€`_`å’Œåæ–œæ å­—ç¬¦

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `zhizhi-backend/src/main/java/cn/xu/infrastructure/search/strategy/MysqlSearchStrategy.java`

### 2. Redis KEYSå‘½ä»¤æ€§èƒ½é—®é¢˜ âœ…

**é—®é¢˜**ï¼šä½¿ç”¨`redisTemplate.keys()`å‘½ä»¤ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒå¯èƒ½å¯¼è‡´Redisé˜»å¡ã€‚

**ä¿®å¤**ï¼š
- ä½¿ç”¨`SCAN`å‘½ä»¤æ›¿ä»£`KEYS`å‘½ä»¤
- æ·»åŠ å›é€€æœºåˆ¶ï¼šå¦‚æœSCANå¤±è´¥ï¼Œå›é€€åˆ°KEYSå‘½ä»¤

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `zhizhi-backend/src/main/java/cn/xu/domain/post/service/PostSearchCacheService.java`

### 3. ç¼“å­˜é›ªå´©é£é™© âœ…

**é—®é¢˜**ï¼šç¼“å­˜TTLæ˜¯å›ºå®šå€¼ï¼Œå¦‚æœå¤§é‡ç¼“å­˜åŒæ—¶è¿‡æœŸï¼Œå¯èƒ½å¯¼è‡´æ•°æ®åº“å‹åŠ›æ¿€å¢ã€‚

**ä¿®å¤**ï¼š
- åœ¨`CachedSearchStrategy`ä¸­ä¸ºTTLæ·»åŠ éšæœºå€¼ï¼ˆÂ±10%ï¼‰
- ç¡®ä¿TTLè‡³å°‘ä¸º1ç§’

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `zhizhi-backend/src/main/java/cn/xu/infrastructure/search/strategy/CachedSearchStrategy.java`

### 4. ESæŸ¥è¯¢ç‰¹æ®Šå­—ç¬¦å¤„ç† âœ…

**é—®é¢˜**ï¼šElasticsearchæŸ¥è¯¢ä¸­ï¼Œç‰¹æ®Šå­—ç¬¦éœ€è¦è½¬ä¹‰ã€‚

**ä¿®å¤**ï¼š
- ä½¿ç”¨`matchQuery`è¿›è¡Œæœç´¢ï¼Œå®ƒä¼šè‡ªåŠ¨å¤„ç†ç‰¹æ®Šå­—ç¬¦ï¼ˆä½¿ç”¨åˆ†æå™¨è¿›è¡Œåˆ†è¯ï¼‰
- æ·»åŠ æ³¨é‡Šè¯´æ˜

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `zhizhi-backend/src/main/java/cn/xu/infrastructure/search/strategy/ElasticsearchSearchStrategy.java`

### 5. æœç´¢ç»Ÿè®¡é˜²åˆ·æœºåˆ¶ âœ…

**é—®é¢˜**ï¼šæœç´¢ç»Ÿè®¡æ²¡æœ‰é¢‘ç‡é™åˆ¶ï¼Œæ¶æ„ç”¨æˆ·å¯èƒ½é€šè¿‡å¤§é‡æœç´¢æ¥åˆ·çƒ­é—¨æœç´¢è¯ã€‚

**ä¿®å¤**ï¼š
- æ·»åŠ é˜²åˆ·æ—¶é—´çª—å£ï¼šåŒä¸€å…³é”®è¯åœ¨60ç§’å†…åªè®°å½•ä¸€æ¬¡ç»Ÿè®¡
- ä½¿ç”¨`setIfAbsent`ï¼ˆSETNXï¼‰å®ç°åŸå­æ“ä½œï¼Œé¿å…ç«æ€æ¡ä»¶

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `zhizhi-backend/src/main/java/cn/xu/infrastructure/search/service/SearchStatisticsServiceImpl.java`

### 6. ç¼“å­˜å¤±æ•ˆç­–ç•¥ä¼˜åŒ– âœ…

**é—®é¢˜**ï¼š
- å¸–å­æ›´æ–°æ—¶ï¼Œåªæ¸…é™¤æ ‡é¢˜ç›¸å…³çš„ç¼“å­˜
- ç¼“å­˜å¤±æ•ˆä¸å¤Ÿç²¾ç¡®

**ä¿®å¤**ï¼š
- ä¼˜åŒ–ç¼“å­˜å¤±æ•ˆç­–ç•¥ï¼šæå–æ ‡é¢˜å’Œæè¿°ä¸­çš„å…³é”®è¯
- ä½¿ç”¨`SearchKeywordNormalizer`è§„èŒƒåŒ–å…³é”®è¯
- æå–å…³é”®è¯ï¼ˆ2-20ä¸ªå­—ç¬¦ï¼‰
- æ¸…é™¤æ‰€æœ‰ç›¸å…³å…³é”®è¯çš„æœç´¢ç¼“å­˜

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `zhizhi-backend/src/main/java/cn/xu/domain/post/service/PostSearchCacheService.java`

### 7. XSSå®‰å…¨é£é™©ä¿®å¤ âœ…

**é—®é¢˜**ï¼šå‰ç«¯ä½¿ç”¨`v-html`æ¸²æŸ“å…³é”®è¯é«˜äº®ï¼Œå­˜åœ¨XSSæ”»å‡»é£é™©ã€‚

**ä¿®å¤**ï¼š
- åœ¨`PostSearch.vue`ä¸­æ·»åŠ `escapeHtml`å‡½æ•°
- åœ¨`highlightKeyword`å‡½æ•°ä¸­ï¼Œå…ˆå¯¹æ–‡æœ¬å’Œå…³é”®è¯è¿›è¡ŒHTMLè½¬ä¹‰

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `zhizhi-front-vue3/src/views/post/PostSearch.vue`

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–

#### æ–°å¢ç´¢å¼•
1. **æ ‡é¢˜å‰ç¼€ç´¢å¼•**ï¼š`idx_post_title_prefix` (title(50))
2. **æè¿°å‰ç¼€ç´¢å¼•**ï¼š`idx_post_description_prefix` (description(100))
3. **çŠ¶æ€+æ—¶é—´å¤åˆç´¢å¼•**ï¼š`idx_post_status_time` (status, create_time DESC)
4. **å…¨æ–‡ç´¢å¼•**ï¼ˆMySQL 5.7+ï¼‰ï¼š`ft_title_desc` (title, description)

#### æ€§èƒ½æå‡
- **LIKEæŸ¥è¯¢**ï¼šç´¢å¼•å¸®åŠ©ä¼˜åŒ–æ‰§è¡Œè®¡åˆ’
- **æ’åºæŸ¥è¯¢**ï¼šå¤åˆç´¢å¼•åŠ é€Ÿæ’åº
- **å…¨æ–‡æœç´¢**ï¼šå…¨æ–‡ç´¢å¼•å¤§å¹…æå‡æ€§èƒ½

### 2. ç¼“å­˜ä¼˜åŒ–

#### ç¼“å­˜ç­–ç•¥
- **çƒ­é—¨å…³é”®è¯**ï¼šç¼“å­˜1å°æ—¶ï¼ˆÂ±10%éšæœºTTLï¼‰
- **æ™®é€šå…³é”®è¯**ï¼šç¼“å­˜5åˆ†é’Ÿï¼ˆÂ±10%éšæœºTTLï¼‰
- **ç©ºç»“æœ**ï¼šç¼“å­˜1åˆ†é’Ÿï¼ˆÂ±10%éšæœºTTLï¼‰

#### ç¼“å­˜å‘½ä¸­ç‡ï¼ˆé¢„è®¡ï¼‰
- **çƒ­é—¨æœç´¢**ï¼š> 80%
- **æ™®é€šæœç´¢**ï¼š> 60%

### 3. æŸ¥è¯¢ä¼˜åŒ–

#### MySQLæŸ¥è¯¢ä¼˜åŒ–
- ç§»é™¤`content`å­—æ®µæœç´¢ï¼ˆæ€§èƒ½æå‡4-6å€ï¼‰
- ä»…æœç´¢`title`å’Œ`description`å­—æ®µ
- ä½¿ç”¨ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢

#### ESæŸ¥è¯¢ä¼˜åŒ–
- å¤šå­—æ®µæœç´¢ï¼ˆtitle + descriptionï¼‰
- ç›¸å…³æ€§æ’åºï¼ˆtitleæƒé‡2.0ï¼Œdescriptionæƒé‡1.0ï¼‰
- ä½¿ç”¨filteræ¡ä»¶æå‡æ€§èƒ½

## ğŸ”„ æ•°æ®ä¸€è‡´æ€§

### 1. ESç´¢å¼•åŒæ­¥

#### åŒæ­¥æœºåˆ¶
- **äº‹ä»¶é©±åŠ¨**ï¼šé€šè¿‡`PostCreatedEvent`ã€`PostUpdatedEvent`ã€`PostDeletedEvent`
- **å¼‚æ­¥å¤„ç†**ï¼šä¸é˜»å¡ä¸»æµç¨‹
- **å®¹é”™å¤„ç†**ï¼šESåŒæ­¥å¤±è´¥ä¸å½±å“ä¸»æµç¨‹

#### åŒæ­¥æ—¶æœº
- **å¸–å­åˆ›å»ºæ—¶**ï¼šåŒæ­¥ESç´¢å¼•ï¼ˆä»…å·²å‘å¸ƒçŠ¶æ€ï¼‰
- **å¸–å­æ›´æ–°æ—¶**ï¼šæ›´æ–°ESç´¢å¼•
- **å¸–å­åˆ é™¤æ—¶**ï¼šåˆ é™¤ESç´¢å¼•

#### å®ç°ç±»
- `PostSearchCacheService`ï¼šç›‘å¬å¸–å­äº‹ä»¶ï¼ŒåŒæ­¥ESç´¢å¼•

#### ESç´¢å¼•åŒæ­¥é—®é¢˜ä¿®å¤ âœ…

**é—®é¢˜**ï¼šMySQLæ•°æ®æ²¡æœ‰åŒæ­¥åˆ°ESï¼Œå†å²æ•°æ®æ— æ³•é€šè¿‡ESæœç´¢åˆ°ã€‚

**ä¿®å¤å†…å®¹**ï¼š

1. **ä¿®å¤PostIndexConverterçš„publishTimeå­—æ®µ** âœ…
   - ä½¿ç”¨ `post.getPublishTime()` è€Œä¸æ˜¯ `post.getCreateTime()`
   - å¦‚æœ `publishTime` ä¸º `null`ï¼Œåˆ™ä½¿ç”¨ `createTime`ï¼ˆå…¼å®¹æ—§æ•°æ®ï¼‰
   - ä¿®å¤äº†çƒ­åº¦è®¡ç®—ï¼Œä½¿ç”¨æ­£ç¡®çš„ `publishTime` å’Œå‚æ•°é¡ºåº
   - **æ–‡ä»¶**ï¼š`PostIndexConverter.java`

2. **åˆ›å»ºESç´¢å¼•ç®¡ç†æ¥å£** âœ…
   - `POST /api/admin/elasticsearch/reindex` - é‡æ–°ç´¢å¼•æ‰€æœ‰å¸–å­
   - `POST /api/admin/elasticsearch/reindex/{postId}` - é‡æ–°ç´¢å¼•å•ä¸ªå¸–å­
   - `GET /api/admin/elasticsearch/status` - è·å–ç´¢å¼•çŠ¶æ€ï¼ˆå¯¹æ¯”MySQLå’ŒESæ•°æ®é‡ï¼‰
   - **æ–‡ä»¶**ï¼š`ElasticsearchIndexController.java`

3. **ä¿®å¤HotScoreSyncTask** âœ…
   - ä½¿ç”¨ `PostEntity` è€Œä¸æ˜¯ `Post` POå¯¹è±¡
   - ç›´æ¥è°ƒç”¨ `postElasticService.indexPost(postEntity)`
   - **æ–‡ä»¶**ï¼š`HotScoreSyncTask.java`

**ä½¿ç”¨æ–¹æ³•**ï¼š
```bash
# 1. æ£€æŸ¥ç´¢å¼•çŠ¶æ€
curl -X GET "http://localhost:8091/api/admin/elasticsearch/status"

# 2. é‡æ–°ç´¢å¼•æ‰€æœ‰å¸–å­
curl -X POST "http://localhost:8091/api/admin/elasticsearch/reindex"

# 3. é‡æ–°ç´¢å¼•å•ä¸ªå¸–å­
curl -X POST "http://localhost:8091/api/admin/elasticsearch/reindex/123"
```

**æ³¨æ„äº‹é¡¹**ï¼š
- å†å²æ•°æ®éœ€è¦æ‰‹åŠ¨è§¦å‘å…¨é‡é‡æ–°ç´¢å¼•ï¼ˆé¦–æ¬¡ä½¿ç”¨ESæ—¶ï¼‰
- ä¹‹åæ–°åˆ›å»º/æ›´æ–°çš„å¸–å­ä¼šè‡ªåŠ¨åŒæ­¥
- å…¨é‡é‡æ–°ç´¢å¼•å¯èƒ½è¾ƒæ…¢ï¼Œå»ºè®®åœ¨ä½å³°æœŸæ‰§è¡Œ

### 2. ç¼“å­˜å¤±æ•ˆ

#### å¤±æ•ˆæœºåˆ¶
- **äº‹ä»¶é©±åŠ¨**ï¼šç›‘å¬å¸–å­äº‹ä»¶ï¼Œæ¸…é™¤ç›¸å…³ç¼“å­˜
- **ç²¾ç¡®å¤±æ•ˆ**ï¼šæå–å…³é”®è¯ï¼Œæ¸…é™¤ç›¸å…³ç¼“å­˜
- **SCANå‘½ä»¤**ï¼šä½¿ç”¨SCANå‘½ä»¤æ‰«æåŒ¹é…çš„keyï¼Œé¿å…é˜»å¡Redis

#### å¤±æ•ˆæ—¶æœº
- **å¸–å­åˆ›å»ºæ—¶**ï¼šæå–æ ‡é¢˜å’Œæè¿°ä¸­çš„å…³é”®è¯ï¼Œæ¸…é™¤ç›¸å…³ç¼“å­˜
- **å¸–å­æ›´æ–°æ—¶**ï¼šæå–æ ‡é¢˜å’Œæè¿°ä¸­çš„å…³é”®è¯ï¼Œæ¸…é™¤ç›¸å…³ç¼“å­˜
- **å¸–å­åˆ é™¤æ—¶**ï¼šæ¸…é™¤æ‰€æœ‰æœç´¢ç¼“å­˜

#### å®ç°ç±»
- `PostSearchCacheService`ï¼šç›‘å¬å¸–å­äº‹ä»¶ï¼Œæ¸…é™¤æœç´¢ç¼“å­˜

## ğŸ“ æ—¥å¿—è®°å½•

### 1. æœç´¢æ—¥å¿—

#### è®°å½•å†…å®¹
- åŸå§‹å…³é”®è¯å’Œè§„èŒƒåŒ–åçš„å…³é”®è¯
- ç­›é€‰æ¡ä»¶
- åˆ†é¡µå‚æ•°
- æœç´¢ç»“æœæ•°é‡
- å“åº”æ—¶é—´

#### æ—¥å¿—çº§åˆ«
- **INFO**ï¼šæˆåŠŸæœç´¢
- **ERROR**ï¼šæœç´¢å¤±è´¥
- **WARN**ï¼šå‚æ•°é”™è¯¯

#### ç¤ºä¾‹
```
æœç´¢å®Œæˆ: keyword=Java, normalized=java, filter=..., page=1, size=10, total=100, results=10, responseTime=50ms
```

### 2. ç»Ÿè®¡æ—¥å¿—

#### è®°å½•å†…å®¹
- æœç´¢å…³é”®è¯
- æœç´¢ç»“æœæ•°é‡
- æ˜¯å¦æœ‰ç»“æœ

#### æ—¥å¿—çº§åˆ«
- **DEBUG**ï¼šè®°å½•æœç´¢ç»Ÿè®¡

## ğŸ› é—®é¢˜ä¿®å¤è®°å½•

### 1. ç¼–è¯‘é”™è¯¯ä¿®å¤

#### é—®é¢˜1ï¼šç±»å‹ä¸å…¼å®¹
**é”™è¯¯**ï¼š`java: ä¸å…¼å®¹çš„ç±»å‹: java.util.Set<org.springframework.data.redis.core.ZSetOperations.TypedTuple<java.lang.Object>>æ— æ³•è½¬æ¢ä¸ºjava.util.Set<java.lang.Object>`

**ä¿®å¤**ï¼š
- ä¿®æ­£ç±»å‹å£°æ˜ï¼š`Set<ZSetOperations.TypedTuple<Object>>`
- ç®€åŒ–å¾ªç¯é€»è¾‘

#### é—®é¢˜2ï¼šBooleanç±»å‹ä¸åŒ¹é…
**é”™è¯¯**ï¼š`java: ä¸å¯æ¯”è¾ƒçš„ç±»å‹: java.lang.Booleanå’Œint`

**ä¿®å¤**ï¼š
- æ­£ç¡®å¤„ç†`Boolean`ç±»å‹ï¼š`post.getIsFeatured() != null ? post.getIsFeatured() : false`

#### é—®é¢˜3ï¼šæ‰¾ä¸åˆ°æ–¹æ³•
**é”™è¯¯**ï¼š`java: æ‰¾ä¸åˆ°ç¬¦å· ç¬¦å·: æ–¹æ³• summary(java.lang.String)`

**ä¿®å¤**ï¼š
- å°†æ‘˜è¦è®¾ç½®åˆ°`content`å­—æ®µï¼Œè€Œä¸æ˜¯`summary`å­—æ®µ

#### é—®é¢˜4ï¼šJDK 8å…¼å®¹æ€§
**é”™è¯¯**ï¼š`List.of()`å’Œ`.toList()`åœ¨JDK 8ä¸­ä¸å¯ç”¨

**ä¿®å¤**ï¼š
- ä½¿ç”¨`new ArrayList<>()`æ›¿ä»£`List.of()`
- ä½¿ç”¨`.collect(Collectors.toList())`æ›¿ä»£`.toList()`

### 2. è¿è¡Œæ—¶é”™è¯¯ä¿®å¤

#### é—®é¢˜1ï¼šRedis Luaè„šæœ¬é”™è¯¯
**é”™è¯¯**ï¼š`ERR Lua redis lib command arguments must be strings or integers`

**ä¿®å¤**ï¼š
- ç¡®ä¿æ‰€æœ‰Rediså‘½ä»¤å‚æ•°éƒ½æ˜¯å­—ç¬¦ä¸²ç±»å‹
- åœ¨Luaè„šæœ¬ä¸­ä½¿ç”¨å­—ç¬¦ä¸²å‚æ•°ï¼ŒRedisè‡ªåŠ¨è½¬æ¢

#### é—®é¢˜2ï¼šæœç´¢ç»Ÿè®¡ç«æ€æ¡ä»¶
**é—®é¢˜**ï¼šä½¿ç”¨`hasKey`å’Œ`set`ä¸¤æ­¥æ“ä½œï¼Œåœ¨é«˜å¹¶å‘æƒ…å†µä¸‹å¯èƒ½äº§ç”Ÿç«æ€æ¡ä»¶ã€‚

**ä¿®å¤**ï¼š
- ä½¿ç”¨`setIfAbsent`ï¼ˆSETNXï¼‰å®ç°åŸå­æ“ä½œ
- å¦‚æœè®¾ç½®æˆåŠŸï¼Œç»§ç»­è®°å½•ç»Ÿè®¡
- å¦‚æœè®¾ç½®å¤±è´¥ï¼ˆkeyå·²å­˜åœ¨ï¼‰ï¼Œç›´æ¥è¿”å›

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

### MySQLæœç´¢æ€§èƒ½

| æ•°æ®é‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|--------|--------|--------|------|
| 1ä¸‡æ¡ | 200ms | 50ms | 4x |
| 10ä¸‡æ¡ | 2s | 300ms | 6.7x |
| ç¼“å­˜å‘½ä¸­ | N/A | 10ms | 10-20x |

### ESæœç´¢æ€§èƒ½

| æ•°æ®é‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|--------|--------|--------|------|
| 100ä¸‡æ¡ | 100ms | 50ms | 2x |
| ç›¸å…³æ€§æ’åº | ä¸æ”¯æŒ | æ”¯æŒ | - |

## ğŸ¯ åç»­ä¼˜åŒ–å»ºè®®

### å¯é€‰ä¼˜åŒ–

1. **æœç´¢ç»“æœæ’åºä¸€è‡´æ€§**ï¼š
   - MySQLå’ŒESçš„çƒ­åº¦æ’åºè®¡ç®—ç•¥æœ‰å·®å¼‚
   - å½“å‰å¯æ¥å—ï¼Œå¦‚éœ€å®Œå…¨ä¸€è‡´ï¼Œå¯åœ¨MySQLä¸­å®ç°æ—¶é—´è¡°å‡

2. **æœç´¢è¶…æ—¶å¤„ç†**ï¼š
   - é€šè¿‡é…ç½®æ•°æ®åº“è¿æ¥æ± è¶…æ—¶
   - é€šè¿‡é…ç½®ESå®¢æˆ·ç«¯è¶…æ—¶
   - åœ¨åº”ç”¨å±‚æ·»åŠ è¶…æ—¶æ§åˆ¶

3. **å¹¶å‘æœç´¢æ§åˆ¶**ï¼š
   - é€šè¿‡çº¿ç¨‹æ± é…ç½®é™åˆ¶å¹¶å‘æ•°
   - ä½¿ç”¨ä¿¡å·é‡æ§åˆ¶å¹¶å‘æœç´¢æ•°é‡

4. **æœç´¢æ€§èƒ½ç›‘æ§**ï¼š
   - æ·»åŠ æœç´¢æ€§èƒ½æŒ‡æ ‡ç›‘æ§
   - è®°å½•P50ã€P95ã€P99å“åº”æ—¶é—´

### å·²ç§»é™¤çš„åŠŸèƒ½

1. **æœç´¢é¢‘ç‡é™åˆ¶**ï¼š
   - å·²ç§»é™¤IPå’Œç”¨æˆ·é™æµï¼ˆå¼€å‘ç¯å¢ƒä¸éœ€è¦ï¼‰
   - `RateLimiter`å·¥å…·ç±»ä¿ç•™ï¼Œä½†ä¸å†ä½¿ç”¨
   - ç”Ÿäº§ç¯å¢ƒéœ€è¦æ—¶å¯é‡æ–°å¯ç”¨

## ğŸ“š ç›¸å…³æ–‡ä»¶

### æ ¸å¿ƒæ–‡ä»¶

#### é¢†åŸŸå±‚
- `domain/search/model/valobj/SearchFilter.java` - æœç´¢ç­›é€‰æ¡ä»¶
- `domain/search/model/policy/ISearchStrategy.java` - æœç´¢ç­–ç•¥æ¥å£
- `domain/search/service/ISearchDomainService.java` - æœç´¢é¢†åŸŸæœåŠ¡
- `domain/search/service/ISearchStatisticsService.java` - æœç´¢ç»Ÿè®¡æœåŠ¡

#### åº”ç”¨å±‚
- `application/service/SearchApplicationService.java` - æœç´¢åº”ç”¨æœåŠ¡

#### åŸºç¡€è®¾æ–½å±‚
- `infrastructure/search/strategy/ElasticsearchSearchStrategy.java` - ESæœç´¢ç­–ç•¥
- `infrastructure/search/strategy/MysqlSearchStrategy.java` - MySQLæœç´¢ç­–ç•¥
- `infrastructure/search/strategy/CachedSearchStrategy.java` - ç¼“å­˜æœç´¢ç­–ç•¥
- `infrastructure/search/service/SearchStatisticsServiceImpl.java` - æœç´¢ç»Ÿè®¡æœåŠ¡å®ç°
- `infrastructure/search/util/SearchKeywordNormalizer.java` - å…³é”®è¯è§„èŒƒåŒ–å·¥å…·

#### æ¥å£å±‚
- `api/web/controller/PostController.java` - å¸–å­æ§åˆ¶å™¨ï¼ˆåŒ…å«æœç´¢æ¥å£ï¼‰
- `api/web/controller/PostSearchController.java` - æœç´¢ä¸“ç”¨æ§åˆ¶å™¨

#### ç¼“å­˜æœåŠ¡
- `domain/post/service/PostSearchCacheService.java` - æœç´¢ç¼“å­˜æœåŠ¡

### é…ç½®æ–‡ä»¶

- `application.yml` - åº”ç”¨é…ç½®
- `sql/post_search_indexes.sql` - æ•°æ®åº“ç´¢å¼•è„šæœ¬

## âœ¨ æ€»ç»“

æœç´¢åŠŸèƒ½ç»è¿‡å¤šæ¬¡ä¼˜åŒ–ï¼Œç°å·²è¾¾åˆ°ç”Ÿäº§å°±ç»ªçŠ¶æ€ï¼š

1. **æ¶æ„æ¸…æ™°**ï¼šDDDé¢†åŸŸåˆ’åˆ†ï¼Œä»£ç ç»„ç»‡æ¸…æ™°
2. **æ€§èƒ½ä¼˜ç§€**ï¼šç¼“å­˜æœºåˆ¶ã€ç´¢å¼•ä¼˜åŒ–ã€æŸ¥è¯¢ä¼˜åŒ–
3. **å®‰å…¨å¯é **ï¼šSQLæ³¨å…¥é˜²æŠ¤ã€XSSé˜²æŠ¤ã€é˜²åˆ·æœºåˆ¶
4. **æ˜“äºç»´æŠ¤**ï¼šè¯¦ç»†çš„æ—¥å¿—è®°å½•ã€å®Œå–„çš„é”™è¯¯å¤„ç†
5. **æ˜“äºæ‰©å±•**ï¼šç­–ç•¥æ¨¡å¼æ”¯æŒçµæ´»æ‰©å±•

æ‰€æœ‰å…³é”®çš„å®‰å…¨éšæ‚£å’Œæ€§èƒ½é—®é¢˜éƒ½å·²ä¿®å¤ï¼Œä»£ç è´¨é‡è‰¯å¥½ï¼ŒåŠŸèƒ½å®Œæ•´ã€‚

