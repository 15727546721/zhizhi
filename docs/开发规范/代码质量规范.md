# 代码质量规范

## 1. 代码风格规范

### 1.1 缩进和格式
- 使用4个空格进行缩进，不使用Tab字符
- 大括号遵循Java标准格式（左大括号不换行）
- 每行代码不超过120个字符

### 1.2 空行规范
- 类成员之间空一行
- 方法之间空一行
- 逻辑代码块之间可根据需要空行

### 1.3 注释规范
- 类注释使用JavaDoc格式
- 公共方法必须包含JavaDoc注释
- 复杂业务逻辑应添加行内注释
- 注释应使用中文

## 2. 异常处理规范

### 2.1 异常分类
- **业务异常**：使用`BusinessException`
- **系统异常**：使用`SystemException`
- **参数校验异常**：使用`ValidationException`

### 2.2 异常处理原则
- 不捕获不处理的异常
- 异常信息应包含业务含义
- 记录详细的异常日志
- 向用户返回友好的错误信息

### 2.3 异常日志记录
```java
@Slf4j
public class PostService {
    public PostEntity getPostById(Long postId) {
        try {
            // 业务逻辑
            return postRepository.findById(postId);
        } catch (Exception e) {
            log.error("查询帖子失败，帖子ID: {}", postId, e);
            throw new BusinessException("查询帖子失败");
        }
    }
}
```

## 3. 事务管理规范

### 3.1 事务边界
- 事务应在应用服务层进行管理
- 领域服务不应包含事务注解
- 事务范围应尽可能小

### 3.2 事务传播行为
- 默认使用`REQUIRED`传播行为
- 只读事务使用`@Transactional(readOnly = true)`

### 3.3 事务回滚
- 默认回滚运行时异常
- 明确指定需要回滚的异常类型

## 4. 日志规范

### 4.1 日志级别使用
- **ERROR**：系统错误、业务异常
- **WARN**：警告信息、可预期的异常
- **INFO**：重要的业务流程、系统状态
- **DEBUG**：调试信息、详细的操作记录

### 4.2 日志格式
```java
// 正确示例
log.info("用户登录成功，用户ID: {}, 登录时间: {}", userId, loginTime);
log.error("数据库连接失败，URL: {}", dbUrl, e);

// 错误示例
log.info("登录成功" + userId);
log.error(e.getMessage());
```

### 4.3 敏感信息处理
- 不在日志中记录密码、密钥等敏感信息
- 敏感信息应进行脱敏处理

## 5. 性能优化规范

### 5.1 数据库查询优化
- 避免N+1查询问题
- 合理使用索引
- 批量操作代替循环单条操作

### 5.2 缓存使用规范
- 读多写少的数据应使用缓存
- 缓存更新采用增量更新方式
- 设置合理的过期时间

### 5.3 对象创建优化
- 避免在循环中创建大量对象
- 合理使用对象池
- 及时释放资源

## 6. 安全规范

### 6.1 输入校验
- 所有外部输入必须进行校验
- 使用注解方式进行参数校验
- 防止SQL注入和XSS攻击

### 6.2 权限控制
- 接口访问必须进行权限校验
- 数据访问应进行权限检查
- 敏感操作需要二次确认

### 6.3 数据加密
- 密码等敏感数据必须加密存储
- 传输过程中的敏感数据应加密
- 使用标准的加密算法

## 7. 测试规范

### 7.1 单元测试
- 每个公共方法都应有单元测试
- 测试覆盖率应达到80%以上
- 使用Mockito进行依赖模拟

### 7.2 集成测试
- 关键业务流程应有集成测试
- 数据库操作应有集成测试验证
- 外部服务调用应有集成测试

### 7.3 测试数据管理
- 测试数据应独立于生产数据
- 测试数据应可重复初始化
- 测试完成后应清理测试数据

## 8. 代码复用规范

### 8.1 工具类设计
- 工具类应为静态方法
- 工具类不应包含业务逻辑
- 工具类应有完善的单元测试

### 8.2 公共组件设计
- 公共组件应具有通用性
- 公共组件应有详细的文档说明
- 公共组件应遵循开闭原则

### 8.3 代码重构
- 发现重复代码应及时重构
- 重构前应有充分的测试覆盖
- 重构后应保证功能不变

## 9. 版本控制规范

### 9.1 提交信息规范
- 提交信息应包含功能说明
- 使用统一的提交格式
- 提交前应确保代码可编译通过

### 9.2 分支管理
- 功能开发应在独立分支进行
- 合并前应通过代码审查
- 发布版本应打标签

### 9.3 代码审查
- 所有代码合并前必须经过审查
- 审查应关注代码质量、性能和安全性
- 审查发现问题应及时修改

## 10. 文档规范

### 10.1 API文档
- 所有对外API应有详细文档
- API文档应包含请求参数和返回值说明
- API文档应包含使用示例

### 10.2 架构文档
- 系统架构应有详细说明
- 关键设计决策应有文档记录
- 架构文档应及时更新

### 10.3 部署文档
- 部署流程应有详细说明
- 环境配置应有文档记录
- 故障处理应有应急预案