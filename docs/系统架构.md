# 系统架构

## 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                         前端应用                             │
│              Vue3 + Element Plus + Pinia                    │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      Controller 层                           │
│     ┌─────────────────┐         ┌─────────────────┐        │
│     │   Web API       │         │   Admin API     │        │
│     │  /api/*         │         │  /api/system/*  │        │
│     └─────────────────┘         └─────────────────┘        │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      Service 层                              │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐       │
│  │  Post    │ │  User    │ │ Comment  │ │  Tag     │       │
│  │  Service │ │  Service │ │  Service │ │  Service │       │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘       │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐       │
│  │ Follow   │ │ Favorite │ │  Like    │ │ Message  │       │
│  │ Service  │ │  Service │ │  Service │ │  Service │       │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘       │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    Repository 层                             │
│     ┌─────────────┐    ┌─────────────┐    ┌─────────────┐   │
│     │   Mapper    │    │    Impl     │    │    Read     │   │
│     │  (MyBatis)  │    │ (仓储实现)   │    │  (ES读模型) │   │
│     └─────────────┘    └─────────────┘    └─────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
          ┌───────────────────┼───────────────────┐
          ▼                   ▼                   ▼
    ┌──────────┐        ┌──────────┐        ┌──────────┐
    │  MySQL   │        │  Redis   │        │    ES    │
    │  主存储   │        │   缓存   │        │  搜索    │
    └──────────┘        └──────────┘        └──────────┘
```

## 核心设计原则

### 1. 实用主义架构
- 直接使用PO（实体类）承载业务逻辑
- 移除过度抽象（Entity、Aggregate层）
- 单一Service实现，避免接口冗余

### 2. 标签即一切
- 系统以 **Post + Tag** 为核心
- 标签替代传统分类（Category）和话题（Topic）
- 灵活的内容组织方式

### 3. 缓存策略
- 使用 Cache Invalidation 模式
- 事务提交后更新缓存
- 缓存自愈机制

## 包结构说明

```
cn.xu/
├── controller/          # 接口层
│   ├── admin/          # 后台管理 (/api/system/*)
│   │   ├── SysUserController
│   │   ├── SysPostController
│   │   └── SysTagController
│   └── web/            # 前台接口 (/api/*)
│       ├── HomeController
│       ├── PostController
│       ├── UserController
│       └── ...
│
├── service/            # 业务层（按模块划分）
│   ├── post/           # 帖子模块
│   ├── user/           # 用户模块
│   ├── comment/        # 评论模块
│   ├── tag/            # 标签模块
│   ├── follow/         # 关注模块
│   ├── favorite/       # 收藏模块
│   ├── like/           # 点赞模块
│   ├── message/        # 私信模块
│   ├── notification/   # 通知模块
│   └── search/         # 搜索模块
│
├── repository/         # 数据访问层
│   ├── mapper/         # MyBatis Mapper接口
│   ├── impl/           # 仓储实现
│   └── read/           # ES读模型
│       └── elastic/
│
├── model/              # 数据模型
│   ├── entity/         # 实体类（对应数据库表）
│   ├── dto/            # 请求/传输对象
│   ├── vo/             # 响应视图对象
│   └── converter/      # 对象转换器
│
├── cache/              # 缓存服务
├── config/             # 配置类
├── event/              # 事件发布/监听
├── task/               # 定时任务
├── support/            # 基础支撑
│   ├── exception/      # 异常处理
│   ├── response/       # 统一响应
│   └── util/           # 工具类
│
└── integration/        # 外部集成
    ├── file/           # 文件存储（MinIO）
    ├── mail/           # 邮件服务
    └── search/         # 搜索策略
```

## 核心模块说明

### Post（帖子）
- 草稿/发布/删除状态管理
- 热度计算与排行
- 与Tag多对多关联

### User（用户）
- 注册/登录（Sa-Token）
- 个人资料管理
- 关注/粉丝统计

### Comment（评论）
- 支持多级回复
- 热度排序
- 点赞统计

### Notification（通知）
- 系统通知
- 互动通知（点赞、评论、关注等）

### PrivateMessage（私信）
- 用户间私信
- 会话管理
- 消息状态

## 数据库表概览

| 表名 | 说明 |
|------|------|
| user | 用户表 |
| post | 帖子表 |
| tag | 标签表 |
| post_tag | 帖子标签关联 |
| comment | 评论表 |
| follow | 关注表 |
| favorite | 收藏表 |
| favorite_folder | 收藏夹 |
| like_record | 点赞记录 |
| notification | 通知表 |
| private_message | 私信表 |
| private_message_session | 私信会话 |
| user_settings | 用户设置 |
| role/menu/user_role | 权限相关 |
