# 聚合搜索功能

## 概述

聚合搜索功能支持同时搜索帖子、用户、标签三种类型的数据，使用Java 8 CompletableFuture实现异步并行搜索，提高搜索效率。

## API接口

### 聚合搜索

**路径**：`GET /api/search/aggregate`

**参数**：
| 参数 | 类型 | 必填 | 默认值 | 说明 |
|-----|------|-----|--------|------|
| keyword | String | 是 | - | 搜索关键词 |
| postLimit | Integer | 否 | 10 | 帖子数量限制（最大50） |
| userLimit | Integer | 否 | 10 | 用户数量限制（最大50） |
| tagLimit | Integer | 否 | 10 | 标签数量限制（最大50） |

**响应示例**：
```json
{
  "code": 20000,
  "info": "搜索成功",
  "data": {
    "keyword": "Java",
    "posts": {
      "list": [
        {
          "id": 1,
          "title": "Java并发编程入门",
          "description": "本文介绍Java并发编程基础...",
          "coverUrl": "https://...",
          "userId": 1,
          "authorName": "张三",
          "authorAvatar": "https://...",
          "viewCount": 1000,
          "likeCount": 50,
          "commentCount": 10,
          "tags": ["Java", "并发"],
          "createTime": "2025-11-30 10:00:00"
        }
      ],
      "total": 100,
      "hasMore": true
    },
    "users": {
      "list": [
        {
          "id": 1,
          "username": "zhangsan",
          "nickname": "张三",
          "avatar": "https://...",
          "description": "Java开发者",
          "fansCount": 500,
          "postCount": 20,
          "isOfficial": false
        }
      ],
      "total": 5,
      "hasMore": false
    },
    "tags": {
      "list": [
        {
          "id": 1,
          "name": "Java",
          "description": "Java编程语言相关",
          "usageCount": 1000,
          "isRecommended": true
        }
      ],
      "total": 3,
      "hasMore": false
    },
    "costTime": 156
  }
}
```

### 单类型搜索

| 接口 | 路径 | 说明 |
|-----|------|------|
| 搜索帖子 | `GET /api/search/posts` | 仅搜索帖子 |
| 搜索用户 | `GET /api/search/users` | 仅搜索用户 |
| 搜索标签 | `GET /api/search/tags` | 仅搜索标签 |

## 技术实现

### 异步编排

使用`CompletableFuture`实现并行搜索，显著提升响应速度：

```java
// 并行搜索三种类型
CompletableFuture<SearchResultGroup<PostSearchItem>> postsFuture = 
    CompletableFuture.supplyAsync(() -> searchPosts(keyword, limit), searchExecutor);

CompletableFuture<SearchResultGroup<UserSearchItem>> usersFuture = 
    CompletableFuture.supplyAsync(() -> searchUsers(keyword, limit), searchExecutor);

CompletableFuture<SearchResultGroup<TagSearchItem>> tagsFuture = 
    CompletableFuture.supplyAsync(() -> searchTags(keyword, limit), searchExecutor);

// 等待所有搜索完成（5秒超时）
CompletableFuture.allOf(postsFuture, usersFuture, tagsFuture)
    .get(5, TimeUnit.SECONDS);
```

### 性能优化

1. **并行执行**：3个搜索任务并行执行，总耗时约等于最慢的单个查询
2. **超时保护**：设置5秒超时，避免单个查询阻塞整体响应
3. **批量查询**：批量获取作者信息和帖子标签，减少数据库查询次数
4. **线程池**：使用固定大小线程池（3个线程），避免频繁创建线程

### 文件结构

```
后端:
├── controller/web/controller/AggregateSearchController.java  # 搜索API
├── application/service/AggregateSearchService.java           # 聚合搜索服务
└── model/vo/search/AggregateSearchResponse.java              # 响应VO

前端:
├── api/search.js                              # API封装
└── views/search/
    ├── SearchPage.vue                         # 搜索页面
    └── components/
        ├── PostCard.vue                       # 帖子卡片
        ├── UserCard.vue                       # 用户卡片
        └── TagCard.vue                        # 标签卡片
```

## 前端使用

### API调用

```javascript
import { aggregateSearch } from '@/api/search'

// 聚合搜索
const result = await aggregateSearch({
  keyword: 'Java',
  postLimit: 10,
  userLimit: 10,
  tagLimit: 10
})

// 处理结果
console.log(result.data.posts.list)  // 帖子列表
console.log(result.data.users.list)  // 用户列表
console.log(result.data.tags.list)   // 标签列表
```

### 路由配置

| 路由 | 页面 | 说明 |
|-----|------|------|
| `/search` | SearchPage.vue | 聚合搜索页面 |
| `/search?q=关键词` | SearchPage.vue | 带关键词的搜索 |

## 扩展说明

### 搜索逻辑

- **帖子搜索**：匹配标题和内容（使用MySQL全文索引）
- **用户搜索**：匹配用户名和昵称（LIKE模糊匹配）
- **标签搜索**：匹配标签名称（LIKE模糊匹配）

### 后续优化建议

1. **Elasticsearch集成**：大数据量时迁移到ES提升搜索性能
2. **搜索建议**：添加搜索自动补全功能
3. **搜索历史**：记录用户搜索历史
4. **热门搜索**：展示热门搜索词
