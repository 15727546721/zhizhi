# 后台管理权限系统

## 概述

知之社区后台管理系统采用基于用户类型（userType）的简化权限模型，配合前端的角色验证实现权限控制。

## 用户类型定义

| userType | 角色标识 | 角色名称 | 说明 |
|----------|----------|----------|------|
| 1 | USER | 普通用户 | 无后台管理权限 |
| 2 | ADMIN | 管理员 | 部分后台管理权限 |
| 3+ | ROOT | 超级管理员 | 全部后台管理权限 |

## 权限规则

### ROOT 超级管理员（userType >= 3）

- **菜单权限**：获取全部菜单，不做过滤
- **按钮权限**：显示全部操作按钮
- **接口权限**：`*:*:*`（全部权限）

### ADMIN 管理员（userType = 2）

- **菜单权限**：根据角色配置过滤
- **按钮权限**：根据 perms 配置过滤
- **接口权限**：
  - `system:post:*` - 帖子管理
  - `system:comment:*` - 评论管理
  - `system:tag:*` - 标签管理
  - `system:user:query` - 用户查询
  - `system:statistics:view` - 数据统计

### USER 普通用户（userType = 1）

- 无后台管理权限，无法登录后台

## 后端实现

### 登录接口

**路径**：`POST /api/system/login`

**请求参数**：
```json
{
  "username": "admin",
  "password": "123456"
}
```

**响应**：
```json
{
  "code": 20000,
  "data": "token字符串",
  "info": "登录成功"
}
```

**验证逻辑**：
1. 验证用户名密码
2. 检查 `userType >= 2`（否则拒绝登录）
3. 检查用户状态（status = 1）
4. 返回 Sa-Token 令牌

### 用户信息接口

**路径**：`GET /api/system/user/info/roles`

**响应**：
```json
{
  "code": 20000,
  "data": {
    "id": 1,
    "username": "admin",
    "nickname": "管理员",
    "avatar": "...",
    "roles": ["ROOT"],
    "perms": ["*:*:*"]
  }
}
```

## 前端实现

### 菜单权限过滤

```typescript
// permission.ts
const filterAsyncRoutes = (routes, roles) => {
  const isRoot = roles.includes("ROOT") || roles.includes("super_admin");
  
  routes.forEach((route) => {
    // ROOT 角色直接添加，不做过滤
    if (isRoot || hasPermission(roles, route) || !route.meta?.roles) {
      asyncRoutes.push(tmpRoute);
    }
  });
};
```

### 按钮权限指令

```typescript
// directive/permission/index.ts
export const hasPerm: Directive = {
  mounted(el, binding) {
    const { roles, perms } = useUserStoreHook().user;
    // ROOT 角色直接通过
    if (roles.includes("ROOT")) {
      return true;
    }
    // 其他角色验证 perms
    // ...
  },
};
```

## 数据库

### 用户表字段

```sql
-- user 表核心权限字段
user_type TINYINT NOT NULL DEFAULT 1 COMMENT '用户类型: 1-普通 2-官方 3-管理员'
status TINYINT NOT NULL DEFAULT 1 COMMENT '账号状态: 0-禁用 1-正常 2-待审核'
```

### 创建管理员

```sql
-- 方式1：设置现有用户为超级管理员
UPDATE user SET user_type = 3 WHERE username = 'admin';

-- 方式2：创建新管理员（密码使用SHA256加密）
INSERT INTO user (username, nickname, email, password, user_type, status)
VALUES ('admin', '超级管理员', 'admin@zhizhi.com', SHA2('AdminPassword123!', 256), 3, 1);
```

## 相关文件

### 后端

| 文件 | 说明 |
|------|------|
| `SysLoginController.java` | 后台登录接口 |
| `SysUserController.java` | 用户信息接口（含权限） |
| `WebConfig.java` | 接口白名单配置 |

### 前端

| 文件 | 说明 |
|------|------|
| `store/modules/user.ts` | 用户状态管理 |
| `store/modules/permission.ts` | 权限过滤 |
| `directive/permission/index.ts` | 权限指令 |

### SQL脚本

| 文件 | 说明 |
|------|------|
| `01_schema.sql` | 完整表结构（包含权限表） |
| `02_data.sql` | 初始化数据（管理员+角色+菜单） |
| `menu.sql` | 完整菜单数据 |

## 注意事项

1. **首次部署**：执行 `01_schema.sql` + `02_data.sql` 初始化
2. **密码加密**：统一使用 SHA256 加密（`SHA2(password, 256)`）
3. **Token 格式**：前端请求需携带 `Authorization: Bearer {token}`
4. **会话有效期**：默认 30 天，配置在 `application-dev.yml`
5. **默认密码**：所有初始账号密码为 `AdminPassword123!`
