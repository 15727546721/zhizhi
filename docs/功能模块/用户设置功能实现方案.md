# 用户设置功能实现方案

## 一、功能分析

### 前端设置页面功能清单

| 功能模块 | 功能项 | 前端状态 | 后端状态 | 优先级 |
|---------|--------|---------|---------|--------|
| **安全设置** | 修改密码 | ✅ 已实现 | ✅ 已实现 | - |
| | 邮箱验证 | ⚠️ TODO | ❌ 未实现 | P1 |
| **隐私设置** | 个人资料可见性 | ⚠️ 有UI无保存 | ❌ 未实现 | P1 |
| | 活动状态 | ⚠️ 有UI无保存 | ❌ 未实现 | P2 |
| **通知设置** | 邮件通知 | ⚠️ 有UI无保存 | ❌ 未实现 | P1 |
| | 浏览器通知 | ⚠️ 有UI无保存 | ❌ 未实现 | P2 |
| | 消息提示音 | ⚠️ 有UI无保存 | ❌ 未实现 | P3 |
| **私信设置** | 允许陌生人私信 | ✅ 已实现 | ✅ 已实现 | - |
| | 允许非互相关注用户私信 | ✅ 已实现 | ✅ 已实现 | - |
| | 私信通知 | ✅ 已实现 | ✅ 已实现 | - |
| **账户操作** | 注销账户 | ⚠️ TODO | ⚠️ 有接口但需优化 | P1 |

## 二、数据库设计

### 2.1 用户设置表（user_settings）

```sql
CREATE TABLE `user_settings` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '设置ID',
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  
  -- 隐私设置
  `profile_visibility` TINYINT NOT NULL DEFAULT 1 COMMENT '个人资料可见性: 1-公开 2-仅关注者可见 3-私密',
  `show_online_status` TINYINT NOT NULL DEFAULT 1 COMMENT '是否显示在线状态: 0-不显示 1-显示',
  
  -- 通知设置
  `email_notification` TINYINT NOT NULL DEFAULT 1 COMMENT '邮件通知: 0-关闭 1-开启',
  `browser_notification` TINYINT NOT NULL DEFAULT 1 COMMENT '浏览器通知: 0-关闭 1-开启',
  `sound_notification` TINYINT NOT NULL DEFAULT 0 COMMENT '消息提示音: 0-关闭 1-开启',
  
  -- 邮箱验证
  `email_verified` TINYINT NOT NULL DEFAULT 0 COMMENT '邮箱是否已验证: 0-未验证 1-已验证',
  `email_verify_token` VARCHAR(100) DEFAULT NULL COMMENT '邮箱验证令牌',
  `email_verify_expire_time` DATETIME DEFAULT NULL COMMENT '邮箱验证令牌过期时间',
  
  -- 时间戳
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_id` (`user_id`) COMMENT '用户ID唯一索引',
  KEY `idx_email_verify_token` (`email_verify_token`) COMMENT '邮箱验证令牌索引'
) ENGINE=InnoDB 
  DEFAULT CHARSET=utf8mb4 
  COLLATE=utf8mb4_unicode_ci 
  COMMENT='用户设置表';
```

## 三、后端实现方案

### 3.1 目录结构

```
zhizhi-backend/src/main/java/cn/xu/
├── infrastructure/persistent/
│   ├── po/UserSettings.java                    # 用户设置PO
│   ├── dao/UserSettingsMapper.java            # MyBatis Mapper接口
│   ├── repository/UserSettingsRepository.java # 仓储接口
│   └── repository/UserSettingsRepositoryImpl.java # 仓储实现
├── domain/user/settings/
│   ├── model/entity/UserSettingsEntity.java    # 领域实体
│   └── service/UserSettingsDomainService.java # 领域服务
├── api/web/
│   ├── controller/UserSettingsController.java  # 控制器
│   ├── model/dto/
│   │   ├── UpdatePrivacySettingsRequest.java # 更新隐私设置请求
│   │   ├── UpdateNotificationSettingsRequest.java # 更新通知设置请求
│   │   ├── SendEmailVerifyRequest.java        # 发送邮箱验证请求
│   │   └── VerifyEmailRequest.java            # 验证邮箱请求
│   └── model/vo/
│       └── UserSettingsVO.java                # 用户设置VO
└── domain/user/service/
    └── UserService.java                        # 添加注销账户方法
```

### 3.2 API接口设计

#### 3.2.1 获取用户设置
```
GET /api/user/settings
响应: {
  "code": 20000,
  "data": {
    "privacySettings": {
      "profileVisibility": 1,
      "showOnlineStatus": true
    },
    "notificationSettings": {
      "emailNotification": true,
      "browserNotification": true,
      "soundNotification": false
    },
    "emailVerified": false
  }
}
```

#### 3.2.2 更新隐私设置
```
PUT /api/user/settings/privacy
请求体: {
  "profileVisibility": 2,  // 1-公开 2-仅关注者 3-私密
  "showOnlineStatus": true
}
```

#### 3.2.3 更新通知设置
```
PUT /api/user/settings/notification
请求体: {
  "emailNotification": true,
  "browserNotification": true,
  "soundNotification": false
}
```

#### 3.2.4 发送邮箱验证邮件
```
POST /api/user/settings/email/send-verify
请求体: {
  "email": "user@example.com"
}
```

#### 3.2.5 验证邮箱
```
POST /api/user/settings/email/verify
请求体: {
  "token": "验证令牌"
}
```

#### 3.2.6 用户注销账户
```
POST /api/user/delete-account
请求体: {
  "password": "用户密码"
}
```

## 四、前端实现方案

### 4.1 API接口（src/api/user.js）

```javascript
// 获取用户设置
export function getUserSettings() {
  return request({
    url: '/user/settings',
    method: 'get'
  })
}

// 更新隐私设置
export function updatePrivacySettings(settings) {
  return request({
    url: '/user/settings/privacy',
    method: 'put',
    data: settings
  })
}

// 更新通知设置
export function updateNotificationSettings(settings) {
  return request({
    url: '/user/settings/notification',
    method: 'put',
    data: settings
  })
}

// 发送邮箱验证邮件
export function sendEmailVerify(email) {
  return request({
    url: '/user/settings/email/send-verify',
    method: 'post',
    data: { email }
  })
}

// 验证邮箱
export function verifyEmail(token) {
  return request({
    url: '/user/settings/email/verify',
    method: 'post',
    data: { token }
  })
}

// 注销账户
export function deleteAccount(password) {
  return request({
    url: '/user/delete-account',
    method: 'post',
    data: { password }
  })
}
```

### 4.2 前端页面修改（Settings.vue）

1. **加载用户设置**：在 `onMounted` 中调用 `getUserSettings()` 加载所有设置
2. **隐私设置保存**：为 `profileVisibility` 和 `showOnlineStatus` 添加 `@change` 事件，调用 `updatePrivacySettings()`
3. **通知设置保存**：为所有通知开关添加 `@change` 事件，调用 `updateNotificationSettings()`（带防抖）
4. **邮箱验证**：实现 `verifyEmail()` 方法，调用 `sendEmailVerify()`
5. **注销账户**：实现 `handleDeleteAccount()` 方法，调用 `deleteAccount()`

## 五、实现步骤

### 阶段一：数据库和基础结构（1-2小时）
1. ✅ 创建 `user_settings` 表
2. ✅ 创建 PO、Mapper、Repository
3. ✅ 创建 Entity、DomainService

### 阶段二：隐私和通知设置（2-3小时）
1. ✅ 实现获取用户设置接口
2. ✅ 实现更新隐私设置接口
3. ✅ 实现更新通知设置接口
4. ✅ 前端对接接口，实现保存逻辑

### 阶段三：邮箱验证（2-3小时）
1. ✅ 实现发送验证邮件接口
2. ✅ 实现验证邮箱接口
3. ✅ 前端对接接口

### 阶段四：注销账户（1-2小时）
1. ✅ 实现用户注销账户接口（验证密码、软删除）
2. ✅ 前端对接接口

## 六、注意事项

1. **数据初始化**：用户注册时自动创建默认设置记录
2. **隐私设置应用**：在查询用户信息时，根据 `profileVisibility` 过滤可见信息
3. **邮箱验证**：验证令牌有效期24小时，使用后立即失效
4. **注销账户**：使用软删除，保留数据用于审计，但用户无法再登录
5. **防抖处理**：通知设置使用防抖，避免频繁请求
6. **错误处理**：所有接口都要有完善的错误处理和提示

## 七、测试要点

1. ✅ 隐私设置保存和加载
2. ✅ 通知设置保存和加载
3. ✅ 邮箱验证流程（发送邮件、验证令牌）
4. ✅ 注销账户流程（密码验证、软删除、退出登录）
5. ✅ 数据初始化（新用户注册时自动创建设置）

