# 私信系统用户隐私和系统设置实现说明

## 概述

本文档说明私信系统的用户隐私设置和系统设置功能的实现，包括数据库设计、领域模型、API接口等。

## 功能特性

### 1. 用户隐私设置

用户可以通过隐私设置控制谁可以给自己发送私信：

- **允许陌生人私信**：控制是否允许陌生人（非互相关注用户）发送私信
- **允许非互相关注用户私信**：控制是否允许非互相关注用户发送私信
- **私信通知开关**：控制是否接收私信通知（预留功能）

### 2. 系统设置

系统管理员可以通过系统配置控制私信功能：

- **私信功能开关**：全局开启/关闭私信功能
- **允许陌生人私信（系统默认）**：系统级别的默认设置
- **私信最大长度**：限制单条私信的最大字符数
- **发送频率限制**：限制用户发送私信的频率（预留功能）

## 数据库设计

### 1. 用户私信设置表 (user_message_settings)

```sql
CREATE TABLE `user_message_settings` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '设置ID',
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  `allow_stranger_message` TINYINT NOT NULL DEFAULT 1 COMMENT '是否允许陌生人私信：0-不允许 1-允许',
  `allow_non_mutual_follow_message` TINYINT NOT NULL DEFAULT 1 COMMENT '是否允许非互相关注用户私信：0-不允许 1-允许',
  `message_notification_enabled` TINYINT NOT NULL DEFAULT 1 COMMENT '是否开启私信通知：0-关闭 1-开启',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_id` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户私信设置表';
```

### 2. 系统配置表 (system_config)

```sql
CREATE TABLE `system_config` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '配置ID',
  `config_key` VARCHAR(100) NOT NULL COMMENT '配置键',
  `config_value` VARCHAR(500) NOT NULL COMMENT '配置值',
  `config_desc` VARCHAR(200) DEFAULT NULL COMMENT '配置描述',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_config_key` (`config_key`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='系统配置表';
```

### 3. 默认系统配置

系统初始化时会插入以下默认配置：

- `private_message.enabled`: `1` - 私信功能开关
- `private_message.allow_stranger`: `1` - 是否允许陌生人私信（系统默认）
- `private_message.max_message_length`: `1000` - 私信最大长度
- `private_message.rate_limit`: `10` - 私信发送频率限制（条/分钟）

## 领域模型

### 1. UserMessageSettingsEntity

用户私信设置领域实体，包含：
- `userId`: 用户ID
- `allowStrangerMessage`: 是否允许陌生人私信
- `allowNonMutualFollowMessage`: 是否允许非互相关注用户私信
- `messageNotificationEnabled`: 是否开启私信通知

### 2. SystemConfigEntity

系统配置领域实体，包含：
- `configKey`: 配置键
- `configValue`: 配置值
- `configDesc`: 配置描述

## 业务逻辑

### 私信发送权限检查顺序

1. **系统私信功能开关检查**：检查系统是否开启了私信功能
2. **消息内容验证**：检查消息内容是否为空，长度是否超过限制
3. **发送者状态检查**：检查发送者账号是否被封禁、待审核
4. **接收者状态检查**：检查接收者账号是否被封禁、待审核
5. **屏蔽关系检查**：检查接收者是否屏蔽了发送者
6. **关注关系判断**：判断发送者和接收者是否互相关注
7. **用户隐私设置检查**（仅在非互相关注时）：
   - 检查接收者是否允许陌生人私信
   - 检查接收者是否允许非互相关注用户私信
8. **发送私信**：根据关注关系和对话关系发送私信

### 用户隐私设置逻辑

- **互相关注用户**：不受隐私设置限制，可以自由发送私信
- **非互相关注用户**：需要检查接收者的隐私设置
  - 如果 `allowStrangerMessage = false`，则不允许发送
  - 如果 `allowNonMutualFollowMessage = false`，则不允许发送

## API接口

### 用户私信设置接口

#### 1. 获取用户私信设置

```
GET /api/private-messages/settings
```

**响应示例**：
```json
{
  "code": 20000,
  "data": {
    "userId": 1,
    "allowStrangerMessage": true,
    "allowNonMutualFollowMessage": true,
    "messageNotificationEnabled": true
  }
}
```

#### 2. 更新用户私信设置

```
PUT /api/private-messages/settings
```

**请求体**：
```json
{
  "allowStrangerMessage": false,
  "allowNonMutualFollowMessage": false,
  "messageNotificationEnabled": true
}
```

### 系统配置接口

#### 1. 获取私信相关系统配置

```
GET /api/private-messages/system-configs
```

**响应示例**：
```json
{
  "code": 20000,
  "data": [
    {
      "id": 1,
      "configKey": "private_message.enabled",
      "configValue": "1",
      "configDesc": "私信功能开关：0-关闭 1-开启"
    },
    {
      "id": 2,
      "configKey": "private_message.max_message_length",
      "configValue": "1000",
      "configDesc": "私信最大长度（字符数）"
    }
  ]
}
```

#### 2. 更新系统配置（管理员功能）

```
PUT /api/private-messages/system-configs
```

**请求体**：
```json
{
  "configKey": "private_message.enabled",
  "configValue": "0"
}
```

## 使用示例

### 用户设置隐私

用户可以通过以下方式设置隐私：

1. **只允许互相关注用户私信**：
   ```json
   {
     "allowStrangerMessage": false,
     "allowNonMutualFollowMessage": false
   }
   ```

2. **允许所有人私信**（默认）：
   ```json
   {
     "allowStrangerMessage": true,
     "allowNonMutualFollowMessage": true
   }
   ```

### 系统管理员设置

系统管理员可以通过以下方式控制私信功能：

1. **关闭私信功能**：
   ```json
   {
     "configKey": "private_message.enabled",
     "configValue": "0"
   }
   ```

2. **修改私信最大长度**：
   ```json
   {
     "configKey": "private_message.max_message_length",
     "configValue": "2000"
   }
   ```

## 注意事项

1. **默认设置**：用户首次访问时，系统会自动创建默认设置（允许所有人私信）
2. **互相关注用户**：互相关注用户的私信不受隐私设置限制
3. **系统设置优先级**：系统设置优先级高于用户设置（如系统关闭私信功能，所有用户都无法发送私信）
4. **管理员权限**：更新系统配置需要管理员权限（目前TODO，需要添加权限检查）

## 文件清单

### 后端文件

1. **数据库表结构**：
   - `zhizhi-backend/src/main/resources/sql/user_message_settings_tables.sql`

2. **领域实体**：
   - `zhizhi-backend/src/main/java/cn/xu/domain/message/model/entity/UserMessageSettingsEntity.java`
   - `zhizhi-backend/src/main/java/cn/xu/domain/message/model/entity/SystemConfigEntity.java`

3. **持久化对象**：
   - `zhizhi-backend/src/main/java/cn/xu/infrastructure/persistent/po/UserMessageSettings.java`
   - `zhizhi-backend/src/main/java/cn/xu/infrastructure/persistent/po/SystemConfig.java`

4. **Mapper接口和XML**：
   - `zhizhi-backend/src/main/java/cn/xu/infrastructure/persistent/dao/UserMessageSettingsMapper.java`
   - `zhizhi-backend/src/main/java/cn/xu/infrastructure/persistent/dao/SystemConfigMapper.java`
   - `zhizhi-backend/src/main/resources/mybatis/mapper/UserMessageSettingsMapper.xml`
   - `zhizhi-backend/src/main/resources/mybatis/mapper/SystemConfigMapper.xml`

5. **转换器**：
   - `zhizhi-backend/src/main/java/cn/xu/infrastructure/persistent/converter/UserMessageSettingsConverter.java`
   - `zhizhi-backend/src/main/java/cn/xu/infrastructure/persistent/converter/SystemConfigConverter.java`

6. **仓储实现**：
   - `zhizhi-backend/src/main/java/cn/xu/infrastructure/persistent/repository/UserMessageSettingsRepositoryImpl.java`
   - `zhizhi-backend/src/main/java/cn/xu/infrastructure/persistent/repository/SystemConfigRepositoryImpl.java`

7. **领域服务**：
   - `zhizhi-backend/src/main/java/cn/xu/domain/message/service/UserMessageSettingsDomainService.java`
   - `zhizhi-backend/src/main/java/cn/xu/domain/message/service/SystemConfigDomainService.java`

8. **应用服务**：
   - `zhizhi-backend/src/main/java/cn/xu/application/service/PrivateMessageApplicationService.java`（已更新）

9. **API控制器**：
   - `zhizhi-backend/src/main/java/cn/xu/api/web/controller/PrivateMessageController.java`（已更新）

10. **DTO和VO**：
    - `zhizhi-backend/src/main/java/cn/xu/api/web/model/dto/UpdateUserMessageSettingsDTO.java`
    - `zhizhi-backend/src/main/java/cn/xu/api/web/model/dto/UpdateSystemConfigDTO.java`
    - `zhizhi-backend/src/main/java/cn/xu/api/web/model/vo/UserMessageSettingsVO.java`
    - `zhizhi-backend/src/main/java/cn/xu/api/web/model/vo/SystemConfigVO.java`

### 前端文件

1. **API接口**：
   - `zhizhi-front-vue3/src/api/message.js`（已更新）

## 部署步骤

1. **执行SQL脚本**：
   ```bash
   # 执行用户私信设置和系统配置表创建脚本
   mysql -u用户名 -p数据库名 < zhizhi-backend/src/main/resources/sql/user_message_settings_tables.sql
   ```

2. **重启后端服务**：
   ```bash
   # 重新编译并启动后端服务
   ```

3. **验证功能**：
   - 测试用户私信设置接口
   - 测试系统配置接口
   - 测试私信发送时的权限检查

## 测试建议

1. **用户隐私设置测试**：
   - 测试设置"不允许陌生人私信"后，陌生人无法发送私信
   - 测试设置"只允许互相关注用户私信"后，非互相关注用户无法发送私信
   - 测试互相关注用户不受隐私设置限制

2. **系统设置测试**：
   - 测试关闭私信功能后，所有用户无法发送私信
   - 测试修改私信最大长度后，超过长度的消息无法发送

3. **权限检查测试**：
   - 测试被封禁用户无法发送私信
   - 测试被屏蔽用户无法发送私信
   - 测试各种权限组合情况

## 后续优化建议

1. **频率限制**：实现基于Redis的发送频率限制
2. **内容审核**：集成敏感词过滤和内容审核
3. **管理员权限**：添加管理员权限检查
4. **前端界面**：实现用户隐私设置的前端界面
5. **系统配置管理界面**：实现系统配置的管理界面

