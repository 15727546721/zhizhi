<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.xu.infrastructure.persistent.dao.NotificationDao">
    <insert id="insert" parameterType="cn.xu.infrastructure.persistent.po.NotificationPO">
        INSERT INTO notification (
            type, sender_id, sender_type, receiver_id, title, content,
            business_type, business_id, extra_info, is_read, status,
            created_time, updated_time
        ) VALUES (
            #{type}, #{senderId}, #{senderType}, #{receiverId}, #{title}, #{content},
            #{businessType}, #{businessId}, #{extraInfo}, #{read}, #{status},
            #{createdTime}, #{updatedTime}
        )
    </insert>

    <update id="update" parameterType="cn.xu.infrastructure.persistent.po.NotificationPO">
        UPDATE notification
        SET type = #{type},
            sender_id = #{senderId},
            sender_type = #{senderType},
            receiver_id = #{receiverId},
            title = #{title},
            content = #{content},
            business_type = #{businessType},
            business_id = #{businessId},
            extra_info = #{extraInfo},
            is_read = #{read},
            status = #{status},
            updated_time = #{updatedTime}
        WHERE id = #{id}
    </update>

    <select id="findById" resultType="cn.xu.infrastructure.persistent.po.NotificationPO">
        SELECT * FROM notification WHERE id = #{id}
    </select>

    <select id="findByReceiverIdOrderByCreatedTimeDesc" resultType="cn.xu.infrastructure.persistent.po.NotificationPO">
        SELECT * FROM notification 
        WHERE receiver_id = #{receiverId}
        ORDER BY created_time DESC
        LIMIT #{offset}, #{limit}
    </select>

    <select id="countByReceiverIdAndReadFalse" resultType="java.lang.Long">
        SELECT COUNT(*) FROM notification 
        WHERE receiver_id = #{receiverId} AND is_read = false
    </select>

    <update id="markAllAsRead">
        UPDATE notification 
        SET is_read = true 
        WHERE receiver_id = #{userId} AND is_read = false
    </update>
</mapper> 