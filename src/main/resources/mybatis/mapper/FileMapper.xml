<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.xu.infrastructure.persistent.dao.FileMapper">
    
    <resultMap id="fileMap" type="cn.xu.infrastructure.persistent.po.File">
        <id column="file_id" property="fileId"/>
        <result column="original_name" property="originalName"/>
        <result column="system_name" property="systemName"/>
        <result column="file_url" property="fileUrl"/>
        <result column="storage_path" property="storagePath"/>
        <result column="file_size" property="fileSize"/>
        <result column="mime_type" property="mimeType"/>
        <result column="file_extension" property="fileExtension"/>
        <result column="status" property="status"/>
        <result column="upload_user_id" property="uploadUserId"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>

    <sql id="Base_Column_List">
        file_id, original_name, system_name, file_url, storage_path, file_size,
        mime_type, file_extension, status, upload_user_id, create_time, update_time
    </sql>

    <!-- 插入文件记录 -->
    <insert id="insert" parameterType="cn.xu.infrastructure.persistent.po.File">
        INSERT INTO file (
            file_id, original_name, system_name, file_url, storage_path, 
            file_size, mime_type, file_extension, status, upload_user_id,
            create_time, update_time
        ) VALUES (
            #{fileId}, #{originalName}, #{systemName}, #{fileUrl}, #{storagePath},
            #{fileSize}, #{mimeType}, #{fileExtension}, #{status}, #{uploadUserId},
            #{createTime}, #{updateTime}
        )
    </insert>

    <!-- 批量插入文件记录 -->
    <insert id="batchInsert" parameterType="list">
        INSERT INTO file (
            file_id, original_name, system_name, file_url, storage_path, 
            file_size, mime_type, file_extension, status, upload_user_id,
            create_time, update_time
        ) VALUES
        <foreach collection="files" item="file" separator=",">
            (
                #{file.fileId}, #{file.originalName}, #{file.systemName}, #{file.fileUrl}, #{file.storagePath},
                #{file.fileSize}, #{file.mimeType}, #{file.fileExtension}, #{file.status}, #{file.uploadUserId},
                #{file.createTime}, #{file.updateTime}
            )
        </foreach>
    </insert>

    <!-- 更新文件记录 -->
    <update id="update" parameterType="cn.xu.infrastructure.persistent.po.File">
        UPDATE file
        <set>
            <if test="originalName != null">original_name = #{originalName},</if>
            <if test="systemName != null">system_name = #{systemName},</if>
            <if test="fileUrl != null">file_url = #{fileUrl},</if>
            <if test="storagePath != null">storage_path = #{storagePath},</if>
            <if test="fileSize != null">file_size = #{fileSize},</if>
            <if test="mimeType != null">mime_type = #{mimeType},</if>
            <if test="fileExtension != null">file_extension = #{fileExtension},</if>
            <if test="status != null">status = #{status},</if>
            <if test="uploadUserId != null">upload_user_id = #{uploadUserId},</if>
            update_time = #{updateTime}
        </set>
        WHERE file_id = #{fileId}
    </update>

    <!-- 根据文件ID查询 -->
    <select id="selectById" resultMap="fileMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM file
        WHERE file_id = #{fileId}
    </select>

    <!-- 根据文件URL查询 -->
    <select id="selectByUrl" resultMap="fileMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM file
        WHERE file_url = #{fileUrl}
    </select>

    <!-- 根据用户ID和状态查询文件列表 -->
    <select id="selectByUserIdAndStatus" resultMap="fileMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM file
        WHERE upload_user_id = #{userId}
        <if test="status != null">
            AND status = #{status}
        </if>
        ORDER BY create_time DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 查询过期的临时文件 -->
    <select id="selectExpiredTemporaryFiles" resultMap="fileMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM file
        WHERE status = 'TEMPORARY'
        AND create_time &lt; #{expirationTime}
        ORDER BY create_time ASC
    </select>

    <!-- 统计用户文件数量 -->
    <select id="countByUserIdAndStatus" resultType="long">
        SELECT COUNT(*)
        FROM file
        WHERE upload_user_id = #{userId}
        <if test="status != null">
            AND status = #{status}
        </if>
    </select>

    <!-- 统计用户文件总大小 -->
    <select id="sumFileSizeByUserIdAndStatus" resultType="long">
        SELECT COALESCE(SUM(file_size), 0)
        FROM file
        WHERE upload_user_id = #{userId}
        <if test="status != null">
            AND status = #{status}
        </if>
    </select>

    <!-- 根据文件状态和时间删除文件 -->
    <delete id="deleteByStatusAndTime">
        DELETE FROM file
        WHERE status = #{status}
        AND create_time &lt; #{beforeTime}
    </delete>

</mapper>