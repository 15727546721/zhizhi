<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.xu.infrastructure.persistent.dao.PostMapper">

    <resultMap id="BaseResultMap" type="cn.xu.infrastructure.persistent.po.Post">
        <id property="id" column="id" jdbcType="BIGINT"/>
        <result property="userId" column="user_id" jdbcType="BIGINT"/>
        <result property="categoryId" column="category_id" jdbcType="BIGINT"/>
        <result property="type" column="type" jdbcType="VARCHAR"/>
        <result property="status" column="status" jdbcType="TINYINT"/>
        <result property="title" column="title" jdbcType="VARCHAR"/>
        <result property="content" column="content" jdbcType="VARCHAR"/>
        <result property="coverUrl" column="cover_url" jdbcType="VARCHAR"/>
        <result property="viewCount" column="view_count" jdbcType="BIGINT"/>
        <result property="likeCount" column="like_count" jdbcType="BIGINT"/>
        <result property="commentCount" column="comment_count" jdbcType="BIGINT"/>
        <result property="favoriteCount" column="favorite_count" jdbcType="BIGINT"/>
        <result property="isFeatured" column="is_featured" jdbcType="TINYINT"/>
        <result property="acceptedAnswerId" column="accepted_answer_id" jdbcType="BIGINT"/>
        <result property="publishTime" column="publish_time" jdbcType="TIMESTAMP"/>
        <result property="createTime" column="create_time" jdbcType="TIMESTAMP"/>
        <result property="updateTime" column="update_time" jdbcType="TIMESTAMP"/>
    </resultMap>

    <sql id="Base_Column_List">
        id, user_id, category_id, type, status, title, content, cover_url, view_count, like_count, 
        comment_count, favorite_count, is_featured, accepted_answer_id, publish_time, create_time, update_time
    </sql>
    
    <insert id="insert" parameterType="cn.xu.infrastructure.persistent.po.Post" useGeneratedKeys="true"
            keyProperty="id">
        INSERT INTO post (user_id, category_id, type, status, title, content, cover_url, view_count, 
                         like_count, comment_count, favorite_count, is_featured, accepted_answer_id, publish_time, 
                         create_time, update_time)
        VALUES (#{userId}, #{categoryId}, #{type}, #{status}, #{title}, #{content}, #{coverUrl},
                #{viewCount}, #{likeCount}, #{commentCount}, #{favoriteCount}, #{isFeatured}, #{acceptedAnswerId},
                #{publishTime}, now(), now())
    </insert>
    
    <update id="update">
        UPDATE post
        SET user_id = #{userId},
            category_id = #{categoryId},
            type = #{type},
            status = #{status},
            title = #{title},
            content = #{content},
            cover_url = #{coverUrl},
            view_count = #{viewCount},
            like_count = #{likeCount},
            comment_count = #{commentCount},
            favorite_count = #{favoriteCount},
            is_featured = #{isFeatured},
            accepted_answer_id = #{acceptedAnswerId},
            publish_time = #{publishTime},
            update_time = now()
        WHERE id = #{id}
    </update>
    
    <update id="updateStatus">
        UPDATE post
        SET status = #{status},
            update_time = now()
        WHERE id = #{id}
    </update>
    
    <update id="updateViewCount">
        UPDATE post
        SET view_count = #{viewCount}
        WHERE id = #{postId}
    </update>
    
    <update id="updateLikeCount" parameterType="java.util.Map">
        UPDATE post
        SET like_count = like_count + #{count, jdbcType=BIGINT}
        WHERE id = #{postId, jdbcType=BIGINT}
    </update>
    
    <update id="updateCommentCount">
        UPDATE post
        SET comment_count = comment_count + #{count}
        WHERE id = #{postId}
    </update>
    
    <update id="updateFavoriteCount">
        UPDATE post
        SET favorite_count = favorite_count + #{count, jdbcType=BIGINT}
        WHERE id = #{postId, jdbcType=BIGINT}
    </update>

    <delete id="deleteByIds">
        DELETE FROM post WHERE id IN
        <foreach collection="postIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <select id="findById" resultType="cn.xu.infrastructure.persistent.po.Post" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM post
        WHERE id = #{id}
    </select>
    
    <select id="findAllPublishedPosts" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM post
        WHERE status = 1
        ORDER BY create_time DESC
    </select>

    <select id="findAll" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM post
        ORDER BY create_time DESC
    </select>
    
    <select id="findPostByPage" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM post
        WHERE status = 1
        ORDER BY create_time DESC
        LIMIT #{page}, #{size}
    </select>
    
    <!-- 查询草稿状态的帖子列表 -->
    <select id="findDraftPostListByUserId" parameterType="java.lang.Long" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM post
        WHERE status = 0
          AND user_id = #{userId}
        ORDER BY create_time DESC
    </select>
    
    <!-- 分页查询帖子列表 -->
    <select id="getPostPageList" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM post
        WHERE status = 1
        ORDER BY create_time DESC
        LIMIT #{offset}, #{size}
    </select>
    
    <!-- 分页查询帖子列表（支持排序） -->
    <select id="getPostPageListWithSort" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM post
        WHERE status = 1
        ORDER BY
        <choose>
            <when test='sortBy == "newest"'>
                create_time DESC
            </when>
            <when test='sortBy == "most_commented"'>
                comment_count DESC, create_time DESC
            </when>
            <when test='sortBy == "most_bookmarked"'>
                favorite_count DESC, create_time DESC
            </when>
            <when test='sortBy == "most_liked"'>
                like_count DESC, create_time DESC
            </when>
            <when test='sortBy == "popular"'>
                view_count DESC, create_time DESC
            </when>
            <otherwise>
                (like_count + comment_count * 2) DESC, create_time DESC
            </otherwise>
        </choose>
        LIMIT #{offset}, #{limit}
    </select>
    
    <!-- 检查帖子是否存在 -->
    <select id="existsById" resultType="java.lang.Boolean">
        SELECT COUNT(1) > 0
        FROM post
        WHERE id = #{id}
    </select>
    
    <!-- 统计用户已发布帖子数量 -->
    <select id="countPublishedByUserId" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM post
        WHERE user_id = #{userId} AND status = 1
    </select>
    
    <!-- 获取已发布帖子列表（分页） -->
    <select id="getPublishedPostPageList" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM post
        WHERE status = 1
        ORDER BY create_time DESC
        LIMIT #{offset}, #{limit}
    </select>
    
    <!-- 根据分类ID查询帖子列表 -->
    <select id="getPostPageByCategory" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM post
        WHERE status = 1
          AND category_id = #{categoryId}
        ORDER BY create_time DESC
        LIMIT #{offset}, #{size}
    </select>
    
    <!-- 统计分类下的帖子数量 -->
    <select id="countByCategoryId" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM post
        WHERE status = 1
          AND category_id = #{categoryId}
    </select>
    
    <!-- 查询热门帖子 -->
    <select id="findHotPosts" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM post
        WHERE status = 1
        ORDER BY (like_count + comment_count * 2 + favorite_count * 3) DESC, create_time DESC
        LIMIT #{offset}, #{limit}
    </select>
    
    <!-- 统计热门帖子数量 -->
    <select id="countHotPosts" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM post
        WHERE status = 1
    </select>
    
    <!-- 查询用户发布的帖子 -->
    <select id="findPostsByUserId" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM post
        WHERE user_id = #{userId}
          AND status IN (0, 1)
        ORDER BY create_time DESC
    </select>
    
    <!-- 根据用户ID和帖子状态分页查询帖子列表 -->
    <select id="findPostsByUserIdAndStatus" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM post
        WHERE user_id = #{userId}
        <choose>
            <when test="status != null and status == 'PUBLISHED'">
                AND status = 1
            </when>
            <when test="status != null and status == 'DRAFT'">
                AND status = 0
            </when>
            <when test="status != null and status == 'DELETED'">
                AND status = 2
            </when>
            <when test="status != null and status == 'ARCHIVED'">
                AND status = 3
            </when>
            <when test="status != null and status != ''">
                <!-- 如果是数字字符串，直接使用 -->
                AND status = CAST(#{status} AS UNSIGNED)
            </when>
            <otherwise>
                <!-- 如果没有指定状态，默认查询已发布和草稿 -->
                AND status IN (0, 1)
            </otherwise>
        </choose>
        ORDER BY create_time DESC
        LIMIT #{offset}, #{limit}
    </select>
    
    <!-- 搜索帖子（优化：仅搜索title和description，不搜索content以提高性能） -->
    <select id="searchPosts" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM post
        WHERE status = 1
          AND (title LIKE CONCAT('%', #{keyword}, '%') 
               OR description LIKE CONCAT('%', #{keyword}, '%'))
        ORDER BY create_time DESC
        LIMIT #{offset}, #{limit}
    </select>
    
    <!-- 统计搜索结果数量（优化：仅搜索title和description） -->
    <select id="countSearchResults" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM post
        WHERE status = 1
          AND (title LIKE CONCAT('%', #{keyword}, '%') 
               OR description LIKE CONCAT('%', #{keyword}, '%'))
    </select>
    
    <!-- 支持筛选的搜索帖子（数据库层面筛选，性能优化） -->
    <select id="searchPostsWithFilters" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM post
        WHERE status = 1
          AND (title LIKE CONCAT('%', #{keyword}, '%') 
               OR description LIKE CONCAT('%', #{keyword}, '%'))
          <if test="types != null and types.size() > 0">
              AND type IN
              <foreach collection="types" item="type" open="(" separator="," close=")">
                  #{type}
              </foreach>
          </if>
          <if test="startTime != null">
              AND create_time >= #{startTime}
          </if>
          <if test="endTime != null">
              AND create_time &lt;= #{endTime}
          </if>
          <choose>
              <when test="sortBy == 'hot'">
                  <!-- 热度排序：使用与PostHotScorePolicy相同的权重计算基础热度值 -->
                  <!-- 权重：like=3.0, comment=5.0, view=0.5, favorite=4.0 -->
                  <!-- 注意：数据库层面无法精确实现时间衰减，这里使用基础热度值，时间衰减在ES中实现 -->
                  ORDER BY (like_count * 3.0 + comment_count * 5.0 + view_count * 0.5 + favorite_count * 4.0) DESC, create_time DESC
              </when>
              <when test="sortBy == 'comment'">
                  ORDER BY comment_count DESC, create_time DESC
              </when>
              <when test="sortBy == 'like'">
                  ORDER BY like_count DESC, create_time DESC
              </when>
              <otherwise>
                  ORDER BY create_time DESC
              </otherwise>
          </choose>
        LIMIT #{offset}, #{limit}
    </select>
    
    <!-- 统计支持筛选的搜索结果数量 -->
    <select id="countSearchResultsWithFilters" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM post
        WHERE status = 1
          AND (title LIKE CONCAT('%', #{keyword}, '%') 
               OR description LIKE CONCAT('%', #{keyword}, '%'))
          <if test="types != null and types.size() > 0">
              AND type IN
              <foreach collection="types" item="type" open="(" separator="," close=")">
                  #{type}
              </foreach>
          </if>
          <if test="startTime != null">
              AND create_time >= #{startTime}
          </if>
          <if test="endTime != null">
              AND create_time &lt;= #{endTime}
          </if>
    </select>
    
    <!-- 查询加精帖子 -->
    <select id="findFeaturedPosts" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM post
        WHERE status = 1
          AND is_featured = 1
        ORDER BY create_time DESC
        LIMIT #{offset}, #{limit}
    </select>
    
    <!-- 统计加精帖子数量 -->
    <select id="countFeaturedPosts" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM post
        WHERE status = 1
          AND is_featured = 1
    </select>
    
    <!-- 根据用户ID列表查询帖子列表 -->
    <select id="findPostsByUserIds" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM post
        WHERE status = 1
          AND user_id IN
        <foreach collection="userIds" item="userId" open="(" separator="," close=")">
            #{userId}
        </foreach>
        ORDER BY create_time DESC
        LIMIT #{offset}, #{limit}
    </select>
    
    <!-- 根据用户ID列表分页查询帖子列表 -->
    <select id="getPostPageListByUserIds" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM post
        WHERE status = 1
          AND user_id IN
        <foreach collection="userIds" item="userId" open="(" separator="," close=")">
            #{userId}
        </foreach>
        ORDER BY create_time DESC
        LIMIT #{offset}, #{limit}
    </select>
    
    <!-- 统计指定用户的帖子数量 -->
    <select id="countPostsByUserIds" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM post
        WHERE status = 1
          AND user_id IN
        <foreach collection="userIds" item="userId" open="(" separator="," close=")">
            #{userId}
        </foreach>
    </select>
    
    <!-- 根据帖子类型查询帖子列表 -->
    <select id="findPostsByType" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM post
        WHERE status = 1
          AND type = #{type}
        ORDER BY create_time DESC
        LIMIT #{offset}, #{limit}
    </select>
    
    <!-- 统计指定类型的帖子数量 -->
    <select id="countPostsByType" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM post
        WHERE status = 1
          AND type = #{type}
    </select>
    
    <!-- 根据标签ID查询帖子列表 -->
    <select id="findPostsByTagId" resultMap="BaseResultMap">
        SELECT p.id, p.user_id, p.category_id, p.type, p.status, p.title, p.content, p.cover_url, 
               p.view_count, p.like_count, p.comment_count, p.favorite_count, p.is_featured, 
               p.accepted_answer_id, p.publish_time, p.create_time, p.update_time
        FROM post p
        INNER JOIN post_tag pt ON p.id = pt.post_id
        WHERE p.status = 1
          AND pt.tag_id = #{tagId}
        ORDER BY p.create_time DESC
        LIMIT #{offset}, #{limit}
    </select>
    
    <!-- 统计指定标签的帖子数量 -->
    <select id="countPostsByTagId" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM post p
        INNER JOIN post_tag pt ON p.id = pt.post_id
        WHERE p.status = 1
          AND pt.tag_id = #{tagId}
    </select>
    
    <!-- 根据问题ID查询回答列表 -->
    <select id="findAnswersByQuestionId" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM post
        WHERE status = 1
          AND (type = 'POST' OR type = 'ANSWER')
          AND accepted_answer_id = #{questionId}
        ORDER BY create_time DESC
        LIMIT #{offset}, #{limit}
    </select>
    
    <!-- 统计所有帖子数量 -->
    <select id="countAll" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM post
        WHERE status = 1
    </select>
    
    <!-- 根据帖子类型查找相关帖子（排除指定帖子） -->
    <select id="findRelatedPostsByType" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM post
        WHERE status = 1
          AND type = #{type}
          AND id != #{excludePostId}
        ORDER BY create_time DESC
        LIMIT #{limit}
    </select>
    
    <!-- 根据ID列表查询帖子列表 -->
    <select id="findPostsByIds" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM post
        WHERE id IN
        <foreach collection="postIds" item="postId" open="(" separator="," close=")">
            #{postId}
        </foreach>
        ORDER BY create_time DESC
    </select>
</mapper>