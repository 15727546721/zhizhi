<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.xu.repository.mapper.PostMapper">

    <resultMap id="BaseResultMap" type="cn.xu.model.entity.Post">
        <id property="id" column="id" jdbcType="BIGINT"/>
        <result property="userId" column="user_id" jdbcType="BIGINT"/>
        <result property="status" column="status" jdbcType="TINYINT"/>
        <result property="title" column="title" jdbcType="VARCHAR"/>
        <result property="description" column="description" jdbcType="VARCHAR"/>
        <result property="content" column="content" jdbcType="VARCHAR"/>
        <result property="coverUrl" column="cover_url" jdbcType="VARCHAR"/>
        <result property="viewCount" column="view_count" jdbcType="BIGINT"/>
        <result property="likeCount" column="like_count" jdbcType="BIGINT"/>
        <result property="commentCount" column="comment_count" jdbcType="BIGINT"/>
        <result property="favoriteCount" column="favorite_count" jdbcType="BIGINT"/>
        <result property="shareCount" column="share_count" jdbcType="BIGINT"/>
        <result property="isFeatured" column="is_featured" jdbcType="TINYINT"/>
        <result property="createTime" column="create_time" jdbcType="TIMESTAMP"/>
        <result property="updateTime" column="update_time" jdbcType="TIMESTAMP"/>
    </resultMap>

    <sql id="Base_Column_List">
        id, user_id, status, title, description, content, cover_url, view_count, like_count, 
        comment_count, favorite_count, share_count, is_featured, create_time, update_time
    </sql>
    
    <!-- 带表别名的列列表，用于JOIN查询 -->
    <sql id="Post_Column_List">
        p.id, p.user_id, p.status, p.title, p.description, p.content, p.cover_url, p.view_count, p.like_count, 
        p.comment_count, p.favorite_count, p.share_count, p.is_featured, p.create_time, p.update_time
    </sql>
    
    <insert id="insert" parameterType="cn.xu.model.entity.Post" useGeneratedKeys="true"
            keyProperty="id">
        INSERT INTO post (user_id, status, title, description, content, cover_url, view_count, 
                         like_count, comment_count, favorite_count, share_count, is_featured, 
                         create_time)
        VALUES (#{userId}, #{status}, #{title}, #{description}, #{content}, #{coverUrl},
                #{viewCount}, #{likeCount}, #{commentCount}, #{favoriteCount}, #{shareCount}, #{isFeatured},
                #{createTime})
    </insert>
    
    <update id="update">
        UPDATE post
        SET user_id = #{userId},
            status = #{status},
            title = #{title},
            description = #{description},
            content = #{content},
            cover_url = #{coverUrl},
            view_count = #{viewCount},
            like_count = #{likeCount},
            comment_count = #{commentCount},
            favorite_count = #{favoriteCount},
            share_count = #{shareCount},
            is_featured = #{isFeatured},
            update_time = now()
        WHERE id = #{id}
    </update>
    
    <update id="updateStatus">
        UPDATE post
        SET status = #{status},
            update_time = now()
        WHERE id = #{id}
    </update>
    
    <update id="updateFeatured">
        UPDATE post
        SET is_featured = #{isFeatured},
            update_time = now()
        WHERE id = #{id}
    </update>
    
    <update id="updateViewCount">
        UPDATE post
        SET view_count = #{viewCount}
        WHERE id = #{postId}
    </update>
    
    <update id="updateLikeCount" parameterType="java.util.Map">
        UPDATE post
        SET like_count = COALESCE(like_count, 0) + #{count, jdbcType=BIGINT},
            update_time = NOW()
        WHERE id = #{postId, jdbcType=BIGINT}
    </update>
    
    <update id="updateCommentCount">
        UPDATE post
        SET comment_count = COALESCE(comment_count, 0) + #{count},
            update_time = NOW()
        WHERE id = #{postId}
    </update>
    
    <update id="updateFavoriteCount">
        UPDATE post
        SET favorite_count = COALESCE(favorite_count, 0) + #{count, jdbcType=BIGINT},
            update_time = NOW()
        WHERE id = #{postId, jdbcType=BIGINT}
    </update>
    
    <update id="increaseFavoriteCount">
        UPDATE post
        SET favorite_count = COALESCE(favorite_count, 0) + 1
        WHERE id = #{postId}
    </update>
    
    <update id="decreaseFavoriteCount">
        UPDATE post
        SET favorite_count = GREATEST(COALESCE(favorite_count, 0) - 1, 0)
        WHERE id = #{postId}
    </update>

    <delete id="deleteByIds">
        DELETE FROM post WHERE id IN
        <foreach collection="postIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <select id="findById" resultType="cn.xu.model.entity.Post" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM post
        WHERE id = #{id}
    </select>
    
    <select id="findByIds" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM post
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>
    
    <select id="findAllPublishedPosts" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM post
        WHERE status = 1
        ORDER BY create_time DESC
    </select>
    
    <select id="findAll" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM post
        ORDER BY create_time DESC
    </select>
    
    <select id="findPostByPage" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM post
        WHERE status = 1
        ORDER BY create_time DESC
        LIMIT #{page}, #{size}
    </select>
    
    <!-- 查询草稿状态的帖子列表 -->
    <select id="findDraftPostListByUserId" parameterType="java.lang.Long" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM post
        WHERE status = 0
          AND user_id = #{userId}
        ORDER BY create_time DESC
    </select>
    
    <!-- 分页查询帖子列表 -->
    <select id="getPostPageList" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM post
        WHERE status = 1
        ORDER BY create_time DESC
        LIMIT #{offset}, #{size}
    </select>
    
    <!-- 分页查询帖子列表（支持排序） -->
    <select id="getPostPageListWithSort" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM post
        WHERE status = 1
        ORDER BY
        <choose>
            <when test='sortBy == "newest"'>
                create_time DESC
            </when>
            <when test='sortBy == "most_commented"'>
                comment_count DESC, create_time DESC
            </when>
            <when test='sortBy == "most_bookmarked"'>
                favorite_count DESC, create_time DESC
            </when>
            <when test='sortBy == "most_liked"'>
                like_count DESC, create_time DESC
            </when>
            <when test='sortBy == "popular"'>
                view_count DESC, create_time DESC
            </when>
            <otherwise>
                (like_count + comment_count * 2) DESC, create_time DESC
            </otherwise>
        </choose>
        LIMIT #{offset}, #{limit}
    </select>
    
    <!-- 检查帖子是否存在 -->
    <select id="existsById" resultType="java.lang.Boolean">
        SELECT COUNT(1) > 0
        FROM post
        WHERE id = #{id}
    </select>
    
    <!-- 统计用户已发布帖子数量 -->
    <select id="countPublishedByUserId" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM post
        WHERE user_id = #{userId} AND status = 1
    </select>
    
    <!-- 统计用户草稿数量 -->
    <select id="countDraftsByUserId" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM post
        WHERE user_id = #{userId} AND status = 0
    </select>
    
    <!-- 获取已发布帖子列表（分页） -->
    <select id="getPublishedPostPageList" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM post
        WHERE status = 1
        ORDER BY create_time DESC
        LIMIT #{offset}, #{limit}
    </select>
    
    <!-- 查询热门帖子 -->
    <select id="findHotPosts" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM post
        WHERE status = 1
        ORDER BY (like_count + comment_count * 2 + favorite_count * 3) DESC, create_time DESC
        LIMIT #{offset}, #{limit}
    </select>
    
    <!-- 统计热门帖子数量 -->
    <select id="countHotPosts" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM post
        WHERE status = 1
    </select>
    
    <!-- 按时间范围查询热门帖子（周榜/月榜） -->
    <select id="findHotPostsByTimeRange" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM post
        WHERE status = 1
          AND create_time >= #{startTime}
        ORDER BY (like_count + comment_count * 2 + favorite_count * 3) DESC, create_time DESC
        LIMIT #{offset}, #{limit}
    </select>
    
    <!-- 统计时间范围内的帖子数量 -->
    <select id="countPostsByTimeRange" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM post
        WHERE status = 1
          AND create_time >= #{startTime}
    </select>
    
    <!-- 按排序方式查询帖子（多维度排行榜） -->
    <select id="findPostsBySort" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM post
        WHERE status = 1
        ORDER BY
        <choose>
            <when test="sort == 'hot'">
                (COALESCE(like_count,0) + COALESCE(comment_count,0) * 2 + COALESCE(favorite_count,0) * 3) DESC
            </when>
            <when test="sort == 'likes'">
                COALESCE(like_count, 0) DESC
            </when>
            <when test="sort == 'favorites'">
                COALESCE(favorite_count, 0) DESC
            </when>
            <when test="sort == 'comments'">
                COALESCE(comment_count, 0) DESC
            </when>
            <when test="sort == 'views'">
                COALESCE(view_count, 0) DESC
            </when>
            <when test="sort == 'latest'">
                create_time DESC
            </when>
            <otherwise>
                (COALESCE(like_count,0) + COALESCE(comment_count,0) * 2 + COALESCE(favorite_count,0) * 3) DESC
            </otherwise>
        </choose>
        , create_time DESC
        LIMIT #{offset}, #{limit}
    </select>
    
    <!-- 按时间范围和排序方式查询帖子 -->
    <select id="findPostsByTimeRangeAndSort" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM post
        WHERE status = 1
          AND create_time >= #{startTime}
        ORDER BY
        <choose>
            <when test="sort == 'hot'">
                (COALESCE(like_count,0) + COALESCE(comment_count,0) * 2 + COALESCE(favorite_count,0) * 3) DESC
            </when>
            <when test="sort == 'likes'">
                COALESCE(like_count, 0) DESC
            </when>
            <when test="sort == 'favorites'">
                COALESCE(favorite_count, 0) DESC
            </when>
            <when test="sort == 'comments'">
                COALESCE(comment_count, 0) DESC
            </when>
            <when test="sort == 'views'">
                COALESCE(view_count, 0) DESC
            </when>
            <when test="sort == 'latest'">
                create_time DESC
            </when>
            <otherwise>
                (COALESCE(like_count,0) + COALESCE(comment_count,0) * 2 + COALESCE(favorite_count,0) * 3) DESC
            </otherwise>
        </choose>
        , create_time DESC
        LIMIT #{offset}, #{limit}
    </select>
    
    <!-- 查询热门标签 -->
    <select id="findHotTags" resultType="cn.xu.model.entity.Tag">
        SELECT id, name, description, is_recommended, usage_count, sort, create_time, update_time
        FROM tag
        ORDER BY COALESCE(usage_count, 0) DESC
        LIMIT #{limit}
    </select>
    
    <!-- 查询用户发布的帖子 -->
    <select id="findPostsByUserId" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM post
        WHERE user_id = #{userId}
          AND status IN (0, 1)
        ORDER BY create_time DESC
    </select>
    
    <!-- 根据用户ID和帖子状态分页查询帖子列表 -->
    <select id="findPostsByUserIdAndStatus" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM post
        WHERE user_id = #{userId}
        <choose>
            <when test="status != null and status == 'PUBLISHED'">
                AND status = 1
            </when>
            <when test="status != null and status == 'DRAFT'">
                AND status = 0
            </when>
            <when test="status != null and status == 'DELETED'">
                AND status = 2
            </when>
            <when test="status != null and status == 'ARCHIVED'">
                AND status = 3
            </when>
            <when test="status != null and status != ''">
                <!-- 如果是数字字符串，直接使用 -->
                AND status = CAST(#{status} AS UNSIGNED)
            </when>
            <otherwise>
                <!-- 如果没有指定状态，默认查询已发布和草稿 -->
                AND status IN (0, 1)
            </otherwise>
        </choose>
        ORDER BY create_time DESC
        LIMIT #{offset}, #{limit}
    </select>
    
    <!-- 搜索帖子（优化：仅搜索title和description，不搜索content以提高性能） -->
    <select id="searchPosts" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM post
        WHERE status = 1
          AND (title LIKE CONCAT('%', #{keyword}, '%') 
               OR description LIKE CONCAT('%', #{keyword}, '%'))
        ORDER BY create_time DESC
        LIMIT #{offset}, #{limit}
    </select>
    
    <!-- 统计搜索结果数量（优化：仅搜索title和description） -->
    <select id="countSearchResults" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM post
        WHERE status = 1
          AND (title LIKE CONCAT('%', #{keyword}, '%') 
               OR description LIKE CONCAT('%', #{keyword}, '%'))
    </select>
    
    <!-- 支持筛选的搜索帖子（数据库层面筛选，性能优化） -->
    <select id="searchPostsWithFilters" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM post
        WHERE status = 1
          AND (title LIKE CONCAT('%', #{keyword}, '%') 
               OR description LIKE CONCAT('%', #{keyword}, '%'))
          <if test="startTime != null">
              AND create_time >= #{startTime}
          </if>
          <if test="endTime != null">
              AND create_time &lt;= #{endTime}
          </if>
          <choose>
              <when test="sortBy == 'hot'">
                  <!-- 热度排序：使用与PostHotScorePolicy相同的权重计算基础热度值 -->
                  <!-- 权重：like=3.0, comment=5.0, view=0.5, favorite=4.0 -->
                  <!-- 注意：数据库层面无法精确实现时间衰减，这里使用基础热度值，时间衰减在ES中实现 -->
                  ORDER BY (like_count * 3.0 + comment_count * 5.0 + view_count * 0.5 + favorite_count * 4.0) DESC, create_time DESC
              </when>
              <when test="sortBy == 'comment'">
                  ORDER BY comment_count DESC, create_time DESC
              </when>
              <when test="sortBy == 'like'">
                  ORDER BY like_count DESC, create_time DESC
              </when>
              <otherwise>
                  ORDER BY create_time DESC
              </otherwise>
          </choose>
        LIMIT #{offset}, #{limit}
    </select>
    
    <!-- 统计支持筛选的搜索结果数量 -->
    <select id="countSearchResultsWithFilters" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM post
        WHERE status = 1
          AND (title LIKE CONCAT('%', #{keyword}, '%') 
               OR description LIKE CONCAT('%', #{keyword}, '%'))
          <if test="startTime != null">
              AND create_time >= #{startTime}
          </if>
          <if test="endTime != null">
              AND create_time &lt;= #{endTime}
          </if>
    </select>
    
    <!-- 查询加精帖子 -->
    <select id="findFeaturedPosts" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM post
        WHERE status = 1
          AND is_featured = 1
        ORDER BY create_time DESC
        LIMIT #{offset}, #{limit}
    </select>
    
    <!-- 统计加精帖子数量 -->
    <select id="countFeaturedPosts" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM post
        WHERE status = 1
          AND is_featured = 1
    </select>
    
    <!-- 按标签查询热门帖子 -->
    <select id="findHotPostsByTagId" resultMap="BaseResultMap">
        SELECT 
        <include refid="Post_Column_List"/>
        FROM post p
        INNER JOIN post_tag pt ON p.id = pt.post_id
        WHERE p.status = 1
          AND pt.tag_id = #{tagId}
        ORDER BY (p.like_count * 3.0 + p.comment_count * 5.0 + p.view_count * 0.5 + p.favorite_count * 4.0) DESC, p.create_time DESC
        LIMIT #{offset}, #{limit}
    </select>
    
    <!-- 统计按标签筛选的热门帖子数量 -->
    <select id="countHotPostsByTagId" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM post p
        INNER JOIN post_tag pt ON p.id = pt.post_id
        WHERE p.status = 1
          AND pt.tag_id = #{tagId}
    </select>
    
    <!-- 按标签查询精选帖子 -->
    <select id="findFeaturedPostsByTagId" resultMap="BaseResultMap">
        SELECT 
        <include refid="Post_Column_List"/>
        FROM post p
        INNER JOIN post_tag pt ON p.id = pt.post_id
        WHERE p.status = 1
          AND p.is_featured = 1
          AND pt.tag_id = #{tagId}
        ORDER BY p.create_time DESC
        LIMIT #{offset}, #{limit}
    </select>
    
    <!-- 统计按标签筛选的精选帖子数量 -->
    <select id="countFeaturedPostsByTagId" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM post p
        INNER JOIN post_tag pt ON p.id = pt.post_id
        WHERE p.status = 1
          AND p.is_featured = 1
          AND pt.tag_id = #{tagId}
    </select>
    
    <!-- 按收藏数获取帖子列表 -->
    <select id="findPostsByFavoriteCount" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM post
        WHERE status = 1
        ORDER BY favorite_count DESC, create_time DESC
        LIMIT #{limit}
    </select>
    
    <!-- 根据用户ID列表查询帖子列表 -->
    <select id="findPostsByUserIds" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM post
        WHERE status = 1
          AND user_id IN
        <foreach collection="userIds" item="userId" open="(" separator="," close=")">
            #{userId}
        </foreach>
        ORDER BY create_time DESC
        LIMIT #{offset}, #{limit}
    </select>
    
    <!-- 根据用户ID列表分页查询帖子列表 -->
    <select id="getPostPageListByUserIds" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM post
        WHERE status = 1
          AND user_id IN
        <foreach collection="userIds" item="userId" open="(" separator="," close=")">
            #{userId}
        </foreach>
        ORDER BY create_time DESC
        LIMIT #{offset}, #{limit}
    </select>
    
    <!-- 统计指定用户的帖子数量 -->
    <select id="countPostsByUserIds" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM post
        WHERE status = 1
          AND user_id IN
        <foreach collection="userIds" item="userId" open="(" separator="," close=")">
            #{userId}
        </foreach>
    </select>
    
    <!-- 根据标签ID查询帖子列表 -->
    <select id="findPostsByTagId" resultMap="BaseResultMap">
        SELECT 
        <include refid="Post_Column_List"/>
        FROM post p
        INNER JOIN post_tag pt ON p.id = pt.post_id
        WHERE p.status = 1
          AND pt.tag_id = #{tagId}
        ORDER BY p.create_time DESC
        LIMIT #{offset}, #{limit}
    </select>
    
    <!-- 统计指定标签的帖子数量 -->
    <select id="countPostsByTagId" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM post p
        INNER JOIN post_tag pt ON p.id = pt.post_id
        WHERE p.status = 1
          AND pt.tag_id = #{tagId}
    </select>
    
    <!-- 根据ID列表查询帖子列表 -->
    <select id="findPostsByIds" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM post
        WHERE id IN
        <foreach collection="postIds" item="postId" open="(" separator="," close=")">
            #{postId}
        </foreach>
        ORDER BY create_time DESC
    </select>
    
    <!-- 统计所有已发布帖子数量 -->
    <select id="countAll" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM post
        WHERE status = 1
    </select>

    <!-- 批量更新帖子计数（用于Redis同步） -->
    <update id="updateCounts">
        UPDATE post
        SET view_count = #{viewCount},
            like_count = #{likeCount},
            comment_count = #{commentCount},
            favorite_count = #{favoriteCount},
            update_time = NOW()
        WHERE id = #{postId}
    </update>

    <!-- 分页查询所有帖子（用于批量索引） -->
    <select id="findAllWithPagination" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM post
        WHERE status = 1
        ORDER BY id ASC
        LIMIT #{offset}, #{limit}
    </select>
    
    <!-- 按状态统计帖子数 -->
    <select id="countByStatus" resultType="java.lang.Long">
        SELECT COUNT(*) FROM post WHERE status = #{status}
    </select>
    
    <!-- 统计加精帖子数 -->
    <select id="countFeatured" resultType="java.lang.Long">
        SELECT COUNT(*) FROM post WHERE is_featured = 1 AND status = 1
    </select>

    <!-- ============================================== -->
    <!-- 后台管理专用查询（不查询content字段，优化性能） -->
    <!-- ============================================== -->
    
    <!-- 后台帖子列表VO映射 -->
    <resultMap id="SysPostListResultMap" type="cn.xu.controller.admin.model.vo.SysPostListVO">
        <id property="id" column="id" jdbcType="BIGINT"/>
        <result property="userId" column="user_id" jdbcType="BIGINT"/>
        <result property="nickname" column="nickname" jdbcType="VARCHAR"/>
        <result property="title" column="title" jdbcType="VARCHAR"/>
        <result property="description" column="description" jdbcType="VARCHAR"/>
        <result property="coverUrl" column="cover_url" jdbcType="VARCHAR"/>
        <result property="status" column="status" jdbcType="TINYINT"/>
        <result property="isFeatured" column="is_featured" jdbcType="TINYINT"/>
        <result property="viewCount" column="view_count" jdbcType="BIGINT"/>
        <result property="likeCount" column="like_count" jdbcType="BIGINT"/>
        <result property="favoriteCount" column="favorite_count" jdbcType="BIGINT"/>
        <result property="commentCount" column="comment_count" jdbcType="BIGINT"/>
        <result property="shareCount" column="share_count" jdbcType="BIGINT"/>
        <result property="tagNames" column="tag_names" jdbcType="VARCHAR"/>
        <result property="createTime" column="create_time" jdbcType="TIMESTAMP"/>
        <result property="updateTime" column="update_time" jdbcType="TIMESTAMP"/>
    </resultMap>
    
    <!-- 后台帖子列表查询（不包含content，联表查询用户和标签） -->
    <select id="findPostListForAdmin" resultMap="SysPostListResultMap">
        SELECT 
            p.id,
            p.user_id,
            u.nickname,
            p.title,
            p.description,
            p.cover_url,
            p.status,
            p.is_featured,
            p.view_count,
            p.like_count,
            p.favorite_count,
            p.comment_count,
            p.share_count,
            GROUP_CONCAT(DISTINCT t.name ORDER BY t.name SEPARATOR ',') AS tag_names,
            p.create_time,
            p.update_time
        FROM post p
        LEFT JOIN `user` u ON p.user_id = u.id
        LEFT JOIN post_tag pt ON p.id = pt.post_id
        LEFT JOIN tag t ON pt.tag_id = t.id
        <where>
            <if test="title != null and title != ''">
                AND p.title LIKE CONCAT('%', #{title}, '%')
            </if>
            <if test="status != null">
                AND p.status = #{status}
            </if>
            <if test="userId != null">
                AND p.user_id = #{userId}
            </if>
            <if test="tagId != null">
                AND pt.tag_id = #{tagId}
            </if>
        </where>
        GROUP BY p.id
        ORDER BY p.create_time DESC
        LIMIT #{offset}, #{pageSize}
    </select>
    
    <!-- 后台帖子总数统计（支持筛选条件） -->
    <select id="countPostsForAdmin" resultType="java.lang.Long">
        SELECT COUNT(DISTINCT p.id)
        FROM post p
        <if test="tagId != null">
            LEFT JOIN post_tag pt ON p.id = pt.post_id
        </if>
        <where>
            <if test="title != null and title != ''">
                AND p.title LIKE CONCAT('%', #{title}, '%')
            </if>
            <if test="status != null">
                AND p.status = #{status}
            </if>
            <if test="userId != null">
                AND p.user_id = #{userId}
            </if>
            <if test="tagId != null">
                AND pt.tag_id = #{tagId}
            </if>
        </where>
    </select>
    
    <!-- 获取帖子点赞数 -->
    <select id="getLikeCount" resultType="java.lang.Long">
        SELECT COALESCE(like_count, 0) FROM post WHERE id = #{postId}
    </select>
    
    <!-- 获取帖子收藏数 -->
    <select id="getFavoriteCount" resultType="java.lang.Long">
        SELECT COALESCE(favorite_count, 0) FROM post WHERE id = #{postId}
    </select>
    
    <!-- 获取帖子作者ID -->
    <select id="getAuthorId" resultType="java.lang.Long">
        SELECT user_id FROM post WHERE id = #{postId}
    </select>

</mapper>