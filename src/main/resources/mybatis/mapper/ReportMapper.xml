<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.xu.infrastructure.persistent.repository.ReportRepository">

    <!-- 举报结果映射 -->
    <resultMap id="reportMap" type="cn.xu.infrastructure.persistent.po.Report">
        <id column="id" property="id"/>
        <result column="target_type" property="targetType"/>
        <result column="target_id" property="targetId"/>
        <result column="reporter_id" property="reporterId"/>
        <result column="reason" property="reason"/>
        <result column="detail" property="detail"/>
        <result column="status" property="status"/>
        <result column="create_time" property="createTime"/>
        <result column="handle_time" property="handleTime"/>
        <result column="handler_id" property="handlerId"/>
        <result column="handle_result" property="handleResult"/>
    </resultMap>

    <!-- 举报原因配置结果映射 -->
    <resultMap id="reportReasonConfigMap" type="cn.xu.infrastructure.persistent.po.ReportReasonConfig">
        <id column="id" property="id"/>
        <result column="reason_code" property="reasonCode"/>
        <result column="reason_name" property="reasonName"/>
        <result column="target_type" property="targetType"/>
        <result column="sort_order" property="sortOrder"/>
        <result column="is_enabled" property="isEnabled"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>

    <!-- 保存举报 -->
    <insert id="insert" parameterType="cn.xu.infrastructure.persistent.po.Report" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO report (target_type, target_id, reporter_id, reason, detail, status, create_time)
        VALUES (#{targetType}, #{targetId}, #{reporterId}, #{reason}, #{detail}, #{status}, #{createTime})
    </insert>

    <!-- 更新举报 -->
    <update id="update" parameterType="cn.xu.infrastructure.persistent.po.Report">
        UPDATE report
        <set>
            <if test="targetType != null">target_type = #{targetType},</if>
            <if test="targetId != null">target_id = #{targetId},</if>
            <if test="reporterId != null">reporter_id = #{reporterId},</if>
            <if test="reason != null and reason != ''">reason = #{reason},</if>
            <if test="detail != null">detail = #{detail},</if>
            <if test="status != null">status = #{status},</if>
            <if test="handleTime != null">handle_time = #{handleTime},</if>
            <if test="handlerId != null">handler_id = #{handlerId},</if>
            <if test="handleResult != null">handle_result = #{handleResult},</if>
        </set>
        WHERE id = #{id}
    </update>

    <!-- 根据ID查询举报 -->
    <select id="selectById" parameterType="long" resultMap="reportMap">
        SELECT * FROM report WHERE id = #{id}
    </select>

    <!-- 根据目标类型和目标ID查询举报 -->
    <select id="selectByTarget" resultMap="reportMap">
        SELECT * FROM report 
        WHERE target_type = #{targetType} AND target_id = #{targetId}
        ORDER BY create_time DESC
    </select>

    <!-- 根据举报人ID查询举报 -->
    <select id="selectByReporterId" parameterType="long" resultMap="reportMap">
        SELECT * FROM report 
        WHERE reporter_id = #{reporterId}
        ORDER BY create_time DESC
    </select>

    <!-- 分页查询举报 -->
    <select id="selectByPage" resultMap="reportMap">
        SELECT * FROM report
        ORDER BY create_time DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 根据状态查询举报 -->
    <select id="selectByStatus" parameterType="int" resultMap="reportMap">
        SELECT * FROM report 
        WHERE status = #{status}
        ORDER BY create_time DESC
    </select>

    <!-- 统计未处理举报数量 -->
    <select id="countPendingReports" resultType="long">
        SELECT COUNT(*) FROM report WHERE status = 0
    </select>

    <!-- 删除举报 -->
    <delete id="deleteById" parameterType="long">
        DELETE FROM report WHERE id = #{id}
    </delete>

    <!-- 查询所有启用的举报原因 -->
    <select id="selectAllEnabledReasons" resultMap="reportReasonConfigMap">
        SELECT * FROM report_reason_config 
        WHERE is_enabled = 1
        ORDER BY target_type, sort_order
    </select>

    <!-- 根据目标类型查询举报原因 -->
    <select id="selectReasonsByTargetType" resultMap="reportReasonConfigMap">
        SELECT * FROM report_reason_config 
        WHERE is_enabled = 1 AND (target_type = 0 OR target_type = #{targetType})
        ORDER BY target_type DESC, sort_order
    </select>

</mapper>