<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.xu.repository.mapper.FavoriteFolderMapper">

    <resultMap id="BaseResultMap" type="cn.xu.model.entity.FavoriteFolder">
        <id column="id" property="id"/>
        <result column="user_id" property="userId"/>
        <result column="name" property="name"/>
        <result column="description" property="description"/>
        <result column="is_public" property="isPublic"/>
        <result column="is_default" property="isDefault"/>
        <result column="item_count" property="itemCount"/>
        <result column="cover_url" property="coverUrl"/>
        <result column="sort" property="sort"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>

    <sql id="Base_Column_List">
        id, user_id, name, description, is_public, is_default, item_count, cover_url, sort, create_time, update_time
    </sql>

    <insert id="insert" parameterType="cn.xu.model.entity.FavoriteFolder" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO favorite_folder (user_id, name, description, is_public, is_default, item_count, cover_url, sort, create_time, update_time)
        VALUES (#{userId}, #{name}, #{description}, #{isPublic}, #{isDefault}, #{itemCount}, #{coverUrl}, #{sort}, #{createTime}, #{updateTime})
    </insert>

    <update id="update" parameterType="cn.xu.model.entity.FavoriteFolder">
        UPDATE favorite_folder
        <set>
            <if test="name != null">name = #{name},</if>
            <if test="description != null">description = #{description},</if>
            <if test="isPublic != null">is_public = #{isPublic},</if>
            <if test="coverUrl != null">cover_url = #{coverUrl},</if>
            <if test="sort != null">sort = #{sort},</if>
            update_time = NOW()
        </set>
        WHERE id = #{id}
    </update>

    <select id="selectById" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM favorite_folder
        WHERE id = #{id}
    </select>

    <select id="selectByUserId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM favorite_folder
        WHERE user_id = #{userId}
        ORDER BY is_default DESC, sort ASC, create_time DESC
    </select>

    <select id="selectDefaultByUserId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM favorite_folder
        WHERE user_id = #{userId} AND is_default = 1
        LIMIT 1
    </select>

    <delete id="deleteById">
        DELETE FROM favorite_folder WHERE id = #{id} AND is_default = 0
    </delete>

    <update id="incrementItemCount">
        UPDATE favorite_folder SET item_count = item_count + 1, update_time = NOW() WHERE id = #{id}
    </update>

    <update id="decrementItemCount">
        UPDATE favorite_folder SET item_count = GREATEST(0, item_count - 1), update_time = NOW() WHERE id = #{id}
    </update>

    <update id="updateItemCount">
        UPDATE favorite_folder SET item_count = #{count}, update_time = NOW() WHERE id = #{id}
    </update>

    <select id="countByUserId" resultType="int">
        SELECT COUNT(*) FROM favorite_folder WHERE user_id = #{userId}
    </select>

    <select id="selectPublicByUserId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM favorite_folder
        WHERE user_id = #{userId} AND is_public = 1
        ORDER BY is_default DESC, sort ASC, create_time DESC
    </select>

</mapper>
