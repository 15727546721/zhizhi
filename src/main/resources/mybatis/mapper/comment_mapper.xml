<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.xu.infrastructure.persistent.dao.ICommentDao">
    <resultMap id="BaseResultMap" type="cn.xu.infrastructure.persistent.po.Comment">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="target_type" property="targetType" jdbcType="INTEGER"/>
        <result column="target_id" property="targetId" jdbcType="BIGINT"/>
        <result column="parent_id" property="parentId" jdbcType="BIGINT"/>
        <result column="user_id" property="userId" jdbcType="BIGINT"/>
        <result column="reply_user_id" property="replyUserId" jdbcType="BIGINT"/>
        <result column="content" property="content" jdbcType="VARCHAR"/>
        <result column="like_count" property="likeCount" jdbcType="BIGINT"/>
        <result column="reply_count" property="replyCount" jdbcType="BIGINT"/>
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="update_time" property="updateTime" jdbcType="TIMESTAMP"/>
    </resultMap>

    <resultMap id="CommentWithUserAndReplyMap" type="cn.xu.api.web.model.dto.comment.FindChildCommentItemVO">
        <!-- 评论表字段映射 -->
        <id column="id" property="id"/>
        <result column="content" property="content"/>
        <result column="like_count" property="likeCount"/>
        <result column="create_time" property="createTime"/>

        <!-- 评论用户信息映射 -->
        <association property="user" javaType="cn.xu.domain.user.model.entity.UserEntity">
            <id column="user_id" property="id"/>
            <result column="user_username" property="username"/>
            <result column="user_nickname" property="nickname"/>
            <result column="user_avatar" property="avatar"/>
            <result column="user_gender" property="gender"/>
            <result column="user_region" property="region"/>
            <result column="user_description" property="description"/>
            <result column="user_follow_count" property="followCount"/>
            <result column="user_fans_count" property="fansCount"/>
            <result column="user_like_count" property="likeCount"/>
        </association>

        <!-- 被回复用户信息映射 -->
        <association property="replyUser" javaType="cn.xu.domain.user.model.entity.UserEntity">
            <id column="reply_id" property="id"/>
            <result column="reply_user_username" property="username"/>
            <result column="reply_user_nickname" property="nickname"/>
            <result column="reply_user_avatar" property="avatar"/>
            <result column="reply_user_gender" property="gender"/>
            <result column="reply_user_region" property="region"/>
            <result column="reply_user_description" property="description"/>
            <result column="reply_user_follow_count" property="followCount"/>
            <result column="reply_user_fans_count" property="fansCount"/>
            <result column="reply_user_like_count" property="likeCount"/>
        </association>
    </resultMap>

    <resultMap id="CommentWithUserMap" type="cn.xu.api.web.model.dto.comment.FindCommentItemVO">
        <!-- 评论表字段映射 -->
        <id column="id" property="id"/>
        <result column="content" property="content"/>
        <result column="like_count" property="likeCount"/>
        <result column="reply_count" property="replyCount"/>
        <result column="create_time" property="createTime"/>

        <!-- 评论用户信息映射 -->
        <association property="user" javaType="cn.xu.domain.user.model.entity.UserEntity">
            <id column="user_id" property="id"/>
            <result column="user_username" property="username"/>
            <result column="user_nickname" property="nickname"/>
            <result column="user_avatar" property="avatar"/>
            <result column="user_gender" property="gender"/>
            <result column="user_region" property="region"/>
            <result column="user_description" property="description"/>
            <result column="user_follow_count" property="followCount"/>
            <result column="user_fans_count" property="fansCount"/>
            <result column="user_like_count" property="likeCount"/>
        </association>
    </resultMap>
    <sql id="Base_Column_List">
        id
        , target_type, target_id, parent_id, user_id, reply_user_id, `content`, like_count, reply_count, create_time, update_time
    </sql>

    <insert id="insert" parameterType="cn.xu.infrastructure.persistent.po.Comment" useGeneratedKeys="true"
            keyProperty="id">
        insert into comment (target_type, target_id, parent_id, user_id, reply_user_id, content, create_time,
                             update_time)
        values (#{targetType}, #{targetId}, #{parentId}, #{userId}, #{replyUserId}, #{content}, #{createTime},
                #{updateTime})
    </insert>
    <update id="updateLikeCount">
        UPDATE comment
        SET like_count = like_count + #{count}
        WHERE target_id = #{targetId}
    </update>
    <update id="updateCommentCount">
        UPDATE comment
        SET reply_count = reply_count + #{count}
        WHERE id = #{commentId}
    </update>

    <delete id="deleteById">
        delete
        from comment
        where id = #{id}
    </delete>

    <select id="findById" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from comment
        where id = #{id}
    </select>

    <select id="findByTypeAndTargetId" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM comment
        WHERE target_type = #{targetType}
        AND target_id = #{targetId}
        ORDER BY create_time DESC
    </select>

    <select id="findByParentId" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM comment
        WHERE parent_id = #{parentId}
        ORDER BY create_time DESC
    </select>

    <!-- 批量删除评论 -->
    <delete id="batchDelete" parameterType="java.util.List">
        DELETE FROM comment
        WHERE id IN
        <foreach collection="commentIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <delete id="deleteByTypeAndTargetId" parameterType="map">
        DELETE
        FROM comment
        WHERE target_type = #{targetType}
          AND target_id = #{targetId}
    </delete>

    <!-- 查询一级评论列表 -->
    <select id="findRootComments" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM comment
        WHERE target_id = #{targetId}
        AND parent_id IS NULL
        <if test="target_type != null">
            AND target_type = #{targetType}
        </if>
        ORDER BY create_time DESC
    </select>

    <!-- 分页查询二级评论列表 -->
    <select id="findRepliesByPage" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM comment
        WHERE parent_id = #{parentId}
        ORDER BY create_time DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 分页查询一级评论列表 -->
    <select id="findRootCommentsByPage" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM comment
        WHERE parent_id IS NULL
        <if test="targetType != null">
            AND target_type = #{targetType}
        </if>
        <if test="targetId != null">
            AND target_id = #{targetId}
        </if>
        ORDER BY create_time DESC
        LIMIT #{offset}, #{limit}
    </select>


    <!-- 根据ID查询评论 -->
    <select id="selectById" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM comment
        WHERE id = #{id}
    </select>

    <!-- 根据父评论ID删除所有子评论 -->
    <delete id="deleteByParentId">
        DELETE
        FROM comment
        WHERE parent_id = #{parentId}
    </delete>

    <!-- 根据父评论ID列表批量查询子评论 -->
    <select id="findByParentIds" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM comment
        WHERE parent_id IN
        <foreach collection="parentIds" item="parentId" open="(" separator="," close=")">
            #{parentId}
        </foreach>
        ORDER BY create_time ASC
    </select>

    <select id="findByTargetWithSort" resultMap="CommentWithUserAndReplyMap">
        SELECT
        c.id, c.target_type, c.target_id, c.parent_id,
        c.user_id, c.reply_user_id, c.content,
        c.like_count, c.create_time,
        u.id as user_id, u.username as user_username, u.nickname as user_nickname, u.avatar as user_avatar,
        u.gender as user_gender, u.region as user_region, u.description as user_description,
        u.follow_count as user_follow_count, u.fans_count as user_fans_count, u.like_count as user_like_count,
        ru.id as reply_user_id, ru.username as reply_user_username, ru.nickname as reply_user_nickname, ru.avatar as
        reply_user_avatar,
        ru.gender as reply_user_gender, ru.region as reply_user_region, ru.description as reply_user_description,
        ru.follow_count as reply_user_follow_count, ru.fans_count as reply_user_fans_count, ru.like_count as
        reply_user_like_count
        FROM comment c
        LEFT JOIN user u ON c.user_id = u.id
        LEFT JOIN user ru ON c.reply_user_id = ru.id
        WHERE c.target_type = #{targetType}
        AND c.target_id = #{targetId}
        <choose>
            <when test="sortType.name() == 'HOT'">
                ORDER BY c.like_count DESC, c.create_time DESC
            </when>
            <otherwise>
                ORDER BY c.create_time DESC
            </otherwise>
        </choose>
    </select>
    <select id="selectRootComments" parameterType="cn.xu.api.web.model.dto.comment.CommentQueryRequest"
            resultType="cn.xu.domain.comment.model.entity.CommentEntity">
        SELECT
        c.*
        FROM comment c
        WHERE c.target_type = #{targetType}
        AND c.target_id = #{targetId}
        AND c.parent_id IS NULL
        <choose>
            <when test="sortType.name() == 'HOT'">
                ORDER BY c.like_count DESC, c.create_time DESC
            </when>
            <otherwise>
                ORDER BY c.create_time DESC
            </otherwise>
        </choose>
        LIMIT #{pageSize} OFFSET (#{pageNo} - 1) * #{pageSize};
    </select>

    <select id="selectChildComments" resultType="cn.xu.domain.comment.model.entity.CommentEntity">
        SELECT
        c.*
        FROM comment c
        WHERE c.parent_id = #{parentId}
        <choose>
            <when test="sortType.name() == 'HOT'">
                ORDER BY c.like_count DESC, c.create_time DESC
            </when>
            <otherwise>
                ORDER BY c.create_time DESC
            </otherwise>
        </choose>
        LIMIT #{pageSize} OFFSET (#{pageNo} - 1) * #{pageSize};
    </select>

    <!-- 分页查询一级评论（包含用户信息） -->
    <select id="findRootCommentsWithUser" resultMap="CommentWithUserAndReplyMap">
        SELECT
        c.*,
        u.id as user_id, u.username as user_username, u.nickname as user_nickname, u.avatar as user_avatar,
        u.gender as user_gender, u.region as user_region, u.description as user_description,
        u.follow_count as user_follow_count, u.fans_count as user_fans_count, u.like_count as user_like_count
        FROM comment c
        LEFT JOIN user u ON c.user_id = u.id
        WHERE c.target_type = #{targetType}
        AND c.target_id = #{targetId}
        AND c.parent_id IS NULL
        <choose>
            <when test="sortType.name() == 'HOT'">
                ORDER BY c.like_count DESC, c.create_time DESC
            </when>
            <otherwise>
                ORDER BY c.create_time DESC
            </otherwise>
        </choose>
        LIMIT #{pageSize} OFFSET (#{pageNo} - 1) * #{pageSize}
    </select>

    <!-- 查询一级评论下的子评论（包含用户信息） -->
    <select id="findChildCommentsWithUser" resultMap="CommentWithUserAndReplyMap">
        SELECT
        c.*,
        u.id as user_id, u.username as user_username, u.nickname as user_nickname, u.avatar as user_avatar,
        u.gender as user_gender, u.region as user_region, u.description as user_description,
        u.follow_count as user_follow_count, u.fans_count as user_fans_count, u.like_count as user_like_count,
        ru.id as reply_user_id, ru.username as reply_user_username, ru.nickname as reply_user_nickname,
        ru.avatar as reply_user_avatar, ru.gender as reply_user_gender, ru.region as reply_user_region,
        ru.description as reply_user_description, ru.follow_count as reply_user_follow_count,
        ru.fans_count as reply_user_fans_count, ru.like_count as reply_user_like_count
        FROM comment c
        LEFT JOIN user u ON c.user_id = u.id
        LEFT JOIN user ru ON c.reply_user_id = ru.id
        WHERE c.parent_id IN
        <foreach collection="parentIds" item="parentId" open="(" separator="," close=")">
            #{parentId}
        </foreach>
        ORDER BY c.create_time ASC
        LIMIT #{limit}
    </select>

    <!-- 统计一级评论总数 -->
    <select id="countRootComments" resultType="long">
        SELECT COUNT(*)
        FROM comment
        WHERE target_type = #{targetType}
          AND target_id = #{targetId}
          AND parent_id IS NULL
    </select>

    <!-- 统计子评论总数 -->
    <select id="countChildComments" resultType="long">
        SELECT COUNT(*)
        FROM comment
        WHERE parent_id = #{parentId}
    </select>
    <select id="findRootCommentList" parameterType="cn.xu.api.web.model.dto.comment.CommentQueryRequest"
            resultType="cn.xu.infrastructure.persistent.po.Comment">
        SELECT
        <include refid="Base_Column_List"/>
        FROM comment
        WHERE parent_id IS NULL
        AND target_type = #{targetType}
        AND target_id = #{targetId}
        <if test="sortType == 'HOT'">
            ORDER BY like_count DESC, create_time DESC
        </if>
        <if test="sortType == 'NEW'">
            ORDER BY create_time DESC
        </if>
        LIMIT 10 OFFSET 0;
    </select>

    <select id="findReplyListByPage" resultType="cn.xu.infrastructure.persistent.po.Comment">
        SELECT
        <include refid="Base_Column_List"/>
        FROM comment
        WHERE parent_id IN
        <foreach collection="parentIds" item="parentId" open="(" separator="," close=")">
            #{parentId}
        </foreach>
        <if test="sortType.name() == 'HOT'">
            ORDER BY like_count DESC, create_time DESC
        </if>
        <if test="sortType.name() == 'NEW'">
            ORDER BY create_time DESC
        </if>
        LIMIT 10 OFFSET 0;
    </select>
    <select id="findCommentWithUserById" resultMap="CommentWithUserAndReplyMap">
        SELECT
        c.*,
        u.*
        FROM comment c
        LEFT JOIN user u ON c.user_id = u.id
        WHERE c.id = #{id}
    </select>
    <select id="findRootCommentWithUser" resultMap="CommentWithUserMap">
        SELECT
            c.*,
            u.id as user_id, u.username as user_username, u.nickname as user_nickname, u.avatar as user_avatar,
            u.gender as user_gender, u.region as user_region, u.description as user_description,
            u.follow_count as user_follow_count, u.fans_count as user_fans_count, u.like_count as user_like_count
        FROM comment c
        JOIN user u ON c.user_id = u.id
        WHERE c.parent_id IS NULL
        AND c.target_type = #{targetType}
        AND c.target_id = #{targetId}
        ORDER BY c.create_time DESC
        LIMIT #{size} OFFSET #{offset};
    </select>

    <select id="findReplyPageWithUserByParentId" resultMap="CommentWithUserAndReplyMap">
        SELECT c.*, u.id as user_id, u.username as user_username, u.nickname as user_nickname, u.avatar as user_avatar,
        u.gender as user_gender, u.region as user_region, u.description as user_description,
        u.follow_count as user_follow_count, u.fans_count as user_fans_count, u.like_count as user_like_count,
        ru.id as reply_user_id, ru.username as reply_user_username, ru.nickname as reply_user_nickname,
        ru.avatar as reply_user_avatar, ru.gender as reply_user_gender, ru.region as reply_user_region,
        ru.description as reply_user_description, ru.follow_count as reply_user_follow_count,
        ru.fans_count as reply_user_fans_count, ru.like_count as reply_user_like_count
        FROM comment c
        LEFT JOIN user u ON c.user_id = u.id
        LEFT JOIN user ru ON c.reply_user_id = ru.id
        WHERE c.parent_id = #{parentId}
        ORDER BY c.create_time ASC
        LIMIT #{size} OFFSET #{offset};
    </select>

    <!-- 批量更新评论点赞数 -->
    <update id="batchUpdateLikeCount">
        <foreach collection="list" item="item" separator=";">
            UPDATE comment
            SET like_count = #{item.likeCount}
            WHERE id = #{item.id}
        </foreach>
    </update>

    <!-- 批量更新评论回复数 -->
    <update id="batchUpdateReplyCount">
        <foreach collection="list" item="item" separator=";">
            UPDATE comment
            SET reply_count = #{item.replyCount}
            WHERE id = #{item.id}
        </foreach>
    </update>

</mapper>
