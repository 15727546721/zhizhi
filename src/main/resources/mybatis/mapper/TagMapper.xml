<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.xu.infrastructure.persistent.dao.TagMapper">

    <resultMap id="BaseResultMap" type="cn.xu.infrastructure.persistent.po.Tag">
        <id property="id" column="id" jdbcType="BIGINT"/>
        <result property="name" column="name" jdbcType="VARCHAR"/>
        <result property="createTime" column="create_time" jdbcType="TIMESTAMP"/>
        <result property="updateTime" column="update_time" jdbcType="TIMESTAMP"/>
    </resultMap>

    <resultMap id="PostAndTagAggMap" type="cn.xu.domain.post.model.aggregate.PostAndTagAgg">
        <result property="postId" column="postId" jdbcType="BIGINT"/>
        <result property="tags" column="tags" jdbcType="VARCHAR"/>
    </resultMap>

    <sql id="Base_Column_List">
        id, name, create_time, update_time
    </sql>

    <insert id="addTag">
        INSERT INTO tags (name, create_time, update_time)
        VALUES (#{name}, NOW(), NOW())
    </insert>

    <select id="getTagNamesByPostId" resultType="java.lang.String">
        SELECT t.name
        FROM tags t
        INNER JOIN post_tag ptr ON t.id = ptr.tag_id
        WHERE ptr.post_id = #{postId}
    </select>

    <select id="selectByPostIds" resultMap="PostAndTagAggMap">
        SELECT
        ptr.post_id AS postId,
        SUBSTRING_INDEX(
        GROUP_CONCAT(t.name ORDER BY t.id SEPARATOR ','),
        ',', 3
        ) AS tags
        FROM post_tag ptr
        JOIN tags t ON ptr.tag_id = t.id
        <if test="postIds != null and postIds.size() > 0">
            WHERE ptr.post_id IN
            <foreach item="id" collection="postIds" open="(" separator="," close=")">
                #{id}
            </foreach>
        </if>
        GROUP BY ptr.post_id
    </select>
    
    <select id="searchTags" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM tags
        WHERE name LIKE CONCAT('%', #{keyword}, '%')
        ORDER BY create_time DESC
    </select>
    
    <select id="getHotTags" resultMap="BaseResultMap">
        SELECT 
        t.id,
        t.name,
        t.create_time,
        t.update_time
        FROM tags t
        LEFT JOIN post_tag pt ON t.id = pt.tag_id
        GROUP BY t.id, t.name, t.create_time, t.update_time
        ORDER BY COUNT(pt.tag_id) DESC
        LIMIT #{limit}
    </select>
    
    <select id="getAllTags" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM tags
        ORDER BY create_time DESC
    </select>
</mapper>