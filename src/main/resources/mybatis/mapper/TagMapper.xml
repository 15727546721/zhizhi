<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.xu.infrastructure.persistent.dao.TagMapper">

    <resultMap id="BaseResultMap" type="cn.xu.infrastructure.persistent.po.Tag">
        <id property="id" column="id" jdbcType="BIGINT"/>
        <result property="name" column="name" jdbcType="VARCHAR"/>
        <result property="createTime" column="create_time" jdbcType="TIMESTAMP"/>
        <result property="updateTime" column="update_time" jdbcType="TIMESTAMP"/>
    </resultMap>

    <resultMap id="PostAndTagAggMap" type="cn.xu.domain.post.model.aggregate.PostAndTagAgg">
        <result property="postId" column="postId" jdbcType="BIGINT"/>
        <result property="tags" column="tags" jdbcType="VARCHAR"/>
    </resultMap>

    <sql id="Base_Column_List">
        id, name, create_time, update_time
    </sql>

    <insert id="addTag">
        INSERT INTO tags (name, create_time, update_time)
        VALUES (#{name}, NOW(), NOW())
    </insert>

    <select id="getTagNamesByPostId" resultType="java.lang.String">
        SELECT t.name
        FROM tags t
        INNER JOIN post_tag ptr ON t.id = ptr.tag_id
        WHERE ptr.post_id = #{postId}
    </select>

    <select id="selectByPostIds" resultMap="PostAndTagAggMap">
        SELECT
        ptr.post_id AS postId,
        SUBSTRING_INDEX(
        GROUP_CONCAT(t.name ORDER BY t.id SEPARATOR ','),
        ',', 3
        ) AS tags
        FROM post_tag ptr
        JOIN tags t ON ptr.tag_id = t.id
        <if test="postIds != null and postIds.size() > 0">
            WHERE ptr.post_id IN
            <foreach item="id" collection="postIds" open="(" separator="," close=")">
                #{id}
            </foreach>
        </if>
        GROUP BY ptr.post_id
    </select>
    
    <select id="searchTags" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM tags
        WHERE name LIKE CONCAT('%', #{keyword}, '%')
        ORDER BY create_time DESC
    </select>
    
    <select id="getHotTags" resultMap="BaseResultMap">
        SELECT 
        t.id,
        t.name,
        t.create_time,
        t.update_time
        FROM tags t
        LEFT JOIN post_tag pt ON t.id = pt.tag_id
        LEFT JOIN post p ON pt.post_id = p.id AND p.status = 1
        GROUP BY t.id, t.name, t.create_time, t.update_time
        HAVING COUNT(pt.tag_id) > 0
        ORDER BY 
            -- 综合热度分数计算：
            -- 1. 使用频率（30%权重）：总使用次数
            COUNT(pt.tag_id) * 0.3 +
            -- 2. 时间衰减（30%权重）：最近7天使用次数加权
            SUM(CASE WHEN p.create_time >= DATE_SUB(NOW(), INTERVAL 7 DAY) THEN 10 ELSE 0 END) * 0.3 +
            -- 3. 帖子质量（40%权重）：平均帖子热度
            AVG(
                COALESCE(p.like_count, 0) * 3 + 
                COALESCE(p.comment_count, 0) * 5 + 
                COALESCE(p.view_count, 0) * 0.5 + 
                COALESCE(p.favorite_count, 0) * 4
            ) * 0.4
        DESC
        LIMIT #{limit}
    </select>
    
    <select id="getHotTagsByTimeRange" resultMap="BaseResultMap">
        SELECT 
        t.id,
        t.name,
        t.create_time,
        t.update_time
        FROM tags t
        LEFT JOIN post_tag pt ON t.id = pt.tag_id
        LEFT JOIN post p ON pt.post_id = p.id AND p.status = 1
        <where>
            <choose>
                <when test="timeRange == 'today'">
                    AND p.create_time >= DATE_FORMAT(NOW(), '%Y-%m-%d 00:00:00')
                </when>
                <when test="timeRange == 'week'">
                    AND p.create_time >= DATE_SUB(NOW(), INTERVAL 7 DAY)
                </when>
                <when test="timeRange == 'month'">
                    AND p.create_time >= DATE_SUB(NOW(), INTERVAL 30 DAY)
                </when>
                <!-- all: 不添加时间限制，统计全部 -->
            </choose>
        </where>
        GROUP BY t.id, t.name, t.create_time, t.update_time
        HAVING COUNT(pt.tag_id) > 0
        ORDER BY 
            -- 综合热度分数计算：
            -- 1. 使用频率（30%权重）：总使用次数
            COUNT(pt.tag_id) * 0.3 +
            -- 2. 时间衰减（30%权重）：最近7天使用次数加权
            SUM(CASE WHEN p.create_time >= DATE_SUB(NOW(), INTERVAL 7 DAY) THEN 10 ELSE 0 END) * 0.3 +
            -- 3. 帖子质量（40%权重）：平均帖子热度
            AVG(
                COALESCE(p.like_count, 0) * 3 + 
                COALESCE(p.comment_count, 0) * 5 + 
                COALESCE(p.view_count, 0) * 0.5 + 
                COALESCE(p.favorite_count, 0) * 4
            ) * 0.4
        DESC
        LIMIT #{limit}
    </select>
    
    <select id="getAllTags" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM tags
        ORDER BY create_time DESC
    </select>
    
    <select id="getTagById" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM tags
        WHERE id = #{id}
    </select>
    
    <update id="updateTag">
        UPDATE tags
        SET name = #{name},
            update_time = NOW()
        WHERE id = #{id}
    </update>
    
    <delete id="deleteTag">
        DELETE FROM tags
        WHERE id = #{id}
    </delete>
</mapper>