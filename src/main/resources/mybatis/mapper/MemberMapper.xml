<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.xu.infrastructure.persistent.dao.MemberMapper">

    <resultMap id="memberMap" type="cn.xu.infrastructure.persistent.po.Member">
        <id column="id" property="id"/>
        <result column="user_id" property="userId"/>
        <result column="current_points" property="currentPoints"/>
        <result column="total_earned_points" property="totalEarnedPoints"/>
        <result column="level" property="level"/>
        <result column="level_name" property="levelName"/>
        <result column="current_exp" property="currentExp"/>
        <result column="next_level_exp" property="nextLevelExp"/>
        <result column="status" property="status"/>
        <result column="level_updated_at" property="levelUpdatedAt"/>
        <result column="last_earned_at" property="lastEarnedAt"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>

    <insert id="insert" parameterType="cn.xu.infrastructure.persistent.po.Member" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO member (
            user_id,
            current_points,
            total_earned_points,
            level,
            level_name,
            current_exp,
            next_level_exp,
            status,
            level_updated_at,
            last_earned_at,
            create_time,
            update_time
        ) VALUES (
            #{userId},
            #{currentPoints},
            #{totalEarnedPoints},
            #{level},
            #{levelName},
            #{currentExp},
            #{nextLevelExp},
            #{status},
            #{levelUpdatedAt},
            #{lastEarnedAt},
            NOW(),
            NOW()
        )
    </insert>

    <update id="update" parameterType="cn.xu.infrastructure.persistent.po.Member">
        UPDATE member
        SET
            current_points = #{currentPoints},
            total_earned_points = #{totalEarnedPoints},
            level = #{level},
            level_name = #{levelName},
            current_exp = #{currentExp},
            next_level_exp = #{nextLevelExp},
            status = #{status},
            level_updated_at = #{levelUpdatedAt},
            last_earned_at = #{lastEarnedAt},
            update_time = NOW()
        WHERE id = #{id}
    </update>

    <select id="findByUserId" resultMap="memberMap">
        SELECT *
        FROM member
        WHERE user_id = #{userId}
    </select>

    <select id="findPointsRanking" resultMap="memberMap">
        SELECT *
        FROM member
        WHERE status = 1
        ORDER BY current_points DESC
        LIMIT #{limit}
    </select>

    <select id="findLevelRanking" resultMap="memberMap">
        SELECT *
        FROM member
        WHERE status = 1
        ORDER BY level DESC, current_exp DESC
        LIMIT #{limit}
    </select>

</mapper>