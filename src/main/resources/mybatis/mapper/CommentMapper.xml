<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.xu.repository.mapper.CommentMapper">
  <resultMap id="BaseResultMap" type="cn.xu.model.entity.Comment">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="target_type" jdbcType="INTEGER" property="targetType" />
    <result column="target_id" jdbcType="BIGINT" property="targetId" />
    <result column="parent_id" jdbcType="BIGINT" property="parentId" />
    <result column="user_id" jdbcType="BIGINT" property="userId" />
    <result column="reply_user_id" jdbcType="BIGINT" property="replyUserId" />
    <result column="content" jdbcType="VARCHAR" property="content" />
    <result column="image_url" jdbcType="VARCHAR" property="imageUrl" />
    <result column="like_count" jdbcType="BIGINT" property="likeCount" />
    <result column="reply_count" jdbcType="BIGINT" property="replyCount" />
    <result column="hot_score" jdbcType="DECIMAL" property="hotScore" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    <result column="update_time" jdbcType="TIMESTAMP" property="updateTime" />
  </resultMap>
  
  <!-- 添加缺失的CommentWithUserAndReplyMap结果映射 -->
  <resultMap id="CommentWithUserAndReplyMap" type="cn.xu.model.entity.Comment">
    <id column="id" property="id"/>
    <result column="target_type" property="targetType"/>
    <result column="target_id" property="targetId"/>
    <result column="parent_id" property="parentId"/>
    <result column="user_id" property="userId"/>
    <result column="reply_user_id" property="replyUserId"/>
    <result column="content" property="content"/>
    <result column="image_url" property="imageUrl"/>
    <result column="like_count" property="likeCount"/>
    <result column="reply_count" property="replyCount"/>
    <result column="hot_score" jdbcType="DECIMAL" property="hotScore"/>
    <result column="create_time" property="createTime"/>
    <result column="update_time" property="updateTime"/>
  </resultMap>
  
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    id, target_type, target_id, parent_id, user_id, reply_user_id, content, image_url, like_count, 
    reply_count, hot_score, create_time, update_time
  </sql>
  <insert id="saveComment" parameterType="cn.xu.model.entity.Comment" useGeneratedKeys="true"
          keyProperty="id">
    insert into comment (target_type, target_id, parent_id, user_id, reply_user_id, content, image_url, like_count, reply_count, hot_score, create_time,
                         update_time)
    values (#{targetType}, #{targetId}, #{parentId}, #{userId}, #{replyUserId}, #{content}, #{imageUrl}, #{likeCount}, #{replyCount}, #{hotScore}, #{createTime},
            #{updateTime})
  </insert>
  <insert id="saveImages">
    INSERT INTO comment_image (comment_id, image_url, sort_order)
    VALUES (#{commentId}, #{imageUrl}, #{sortOrder})
  </insert>
  <update id="updateLikeCount">
    UPDATE comment
    SET like_count = COALESCE(like_count, 0) + #{count},
        update_time = NOW()
    WHERE id = #{commentId}
  </update>
  <update id="updateCommentCount">
    UPDATE comment
    SET reply_count = COALESCE(reply_count, 0) + #{count},
        update_time = NOW()
    WHERE id = #{commentId}
  </update>
  <delete id="deleteById">
    delete
    from comment
    where id = #{id}
  </delete>
  <!-- 按热度查询一级评论 -->
  <select id="findRootCommentsByHot" resultMap="BaseResultMap">
    SELECT c.*
    FROM comment c
    WHERE c.target_type = #{targetType}
      AND c.target_id = #{targetId}
      AND (c.parent_id IS NULL OR c.parent_id = 0)
    ORDER BY hot_score DESC
        LIMIT #{offset}, #{pageSize}
  </select>
  <!-- 按时间查询一级评论 -->
  <select id="findRootCommentsByTime" resultMap="BaseResultMap">
    SELECT
    c.*,
    0 AS hot_score <!-- 兼容字段 -->
    FROM comment c
    WHERE
    c.target_type = #{targetType}
    AND c.target_id = #{targetId}
    AND (c.parent_id IS NULL OR c.parent_id = 0)
    ORDER BY c.create_time DESC
    LIMIT #{offset}, #{pageSize}
  </select>
  <!-- 预览回复查询（使用窗口函数实现分组取前N条） -->
  <select id="selectPreviewRepliesByParentIds" resultMap="BaseResultMap">
    SELECT ranked.* FROM (
    SELECT
    c.id, c.parent_id, c.target_type, c.target_id, c.user_id,
    c.content, c.like_count, c.reply_count, c.status,
    c.create_time, c.update_time,
    0 AS hot_score, <!-- 兼容字段 -->
    ROW_NUMBER() OVER (
    PARTITION BY c.parent_id
    ORDER BY c.create_time DESC
    ) AS rn
    FROM comment c
    WHERE
    c.parent_id IN
    <foreach item="parentId" collection="parentIds"
             open="(" separator="," close=")">
        #{parentId}
    </foreach>
    ) AS ranked
    WHERE rn &lt;= #{previewSize}
  </select>
  <select id="findByTypeAndTargetId" resultMap="BaseResultMap">
    SELECT
    <include refid="Base_Column_List"/>
    FROM comment
    WHERE target_type = #{targetType}
    AND target_id = #{targetId}
    ORDER BY create_time DESC
  </select>
  <!-- 批量删除评论 -->
  <delete id="batchDelete" parameterType="java.util.List">
    DELETE FROM comment
    WHERE id IN
    <foreach collection="commentIds" item="id" open="(" separator="," close=")">
        #{id}
    </foreach>
  </delete>
  <delete id="deleteByTypeAndTargetId" parameterType="map">
    DELETE
    FROM comment
    WHERE target_type = #{targetType}
      AND target_id = #{targetId}
  </delete>
  <!-- 分页查询二级评论列表 -->
  <select id="findRepliesByPage" resultMap="BaseResultMap">
    SELECT
    <include refid="Base_Column_List"/>
    FROM comment
    WHERE parent_id = #{parentId}
    ORDER BY create_time DESC
    LIMIT #{offset}, #{limit}
  </select>
  <!-- 分页查询一级评论列表 -->
  <select id="findRootCommentsByPage" resultMap="BaseResultMap">
    SELECT
    <include refid="Base_Column_List"/>
    FROM comment
    WHERE (parent_id IS NULL OR parent_id = 0)
    <if test="targetType != null">
        AND target_type = #{targetType}
    </if>
    <if test="targetId != null">
        AND target_id = #{targetId}
    </if>
    <if test="userId != null">
        AND user_id = #{userId}
    </if>
    ORDER BY create_time DESC
    LIMIT #{offset}, #{limit}
  </select>
  <!-- 根据ID查询评论 -->
  <select id="selectById" resultMap="BaseResultMap">
    SELECT
    <include refid="Base_Column_List"/>
    FROM comment
    WHERE id = #{id}
  </select>
  <!-- 根据父评论ID删除所有子评论 -->
  <delete id="deleteByParentId">
    DELETE
    FROM comment
    WHERE parent_id = #{parentId}
  </delete>
  <!-- 根据父评论ID列表批量查询子评论 -->
  <select id="findByParentIds" resultMap="BaseResultMap">
    SELECT
    <include refid="Base_Column_List"/>
    FROM comment
    WHERE parent_id IN
    <foreach collection="parentIds" item="parentId" open="(" separator="," close=")">
        #{parentId}
    </foreach>
    ORDER BY create_time ASC
  </select>
  <select id="findByTargetWithSort" resultMap="CommentWithUserAndReplyMap">
    SELECT
    c.id, c.target_type, c.target_id, c.parent_id,
    c.user_id, c.reply_user_id, c.content,
    c.like_count, c.create_time,
    u.id as user_id, u.username as user_username, u.nickname as user_nickname, u.avatar as user_avatar,
    u.gender as user_gender, u.region as user_region, u.description as user_description,
    u.follow_count as user_follow_count, u.fans_count as user_fans_count, u.like_count as user_like_count,
    ru.id as reply_user_id, ru.username as reply_user_username, ru.nickname as reply_user_nickname, ru.avatar as
    reply_user_avatar,
    ru.gender as reply_user_gender, ru.region as reply_user_region, ru.description as reply_user_description,
    ru.follow_count as reply_user_follow_count, ru.fans_count as reply_user_fans_count, ru.like_count as
    reply_user_like_count
    FROM comment c
    LEFT JOIN user u ON c.user_id = u.id
    LEFT JOIN user ru ON c.reply_user_id = ru.id
    WHERE c.target_type = #{targetType} AND c.target_id = #{targetId} AND c.parent_id IS NULL
    ORDER BY
    <choose>
      <when test="sortType == 'HOT'">
        c.hot_score DESC
      </when>
      <otherwise>
        c.create_time DESC
      </otherwise>
    </choose>
    LIMIT #{offset}, #{limit}
  </select>
  <!-- 按热度查询每个parent的前N条回复（使用窗口函数） -->
  <select id="findRepliesByParentIdsByHot" resultMap="BaseResultMap">
    SELECT id, target_type, target_id, parent_id, user_id, reply_user_id, 
           content, like_count, reply_count, hot_score, create_time, update_time
    FROM (
      SELECT c.*, ROW_NUMBER() OVER (PARTITION BY c.parent_id ORDER BY c.hot_score DESC, c.create_time DESC) AS rn
      FROM comment c
      WHERE c.parent_id IN
      <foreach collection="parentIds" item="parentId" open="(" separator="," close=")">
        #{parentId}
      </foreach>
    ) AS ranked
    WHERE rn &lt;= #{size}
  </select>
  <!-- 按时间查询每个parent的前N条回复（使用窗口函数） -->
  <select id="findRepliesByParentIdsByTime" resultMap="BaseResultMap">
    SELECT id, target_type, target_id, parent_id, user_id, reply_user_id,
           content, like_count, reply_count, hot_score, create_time, update_time
    FROM (
      SELECT c.*, ROW_NUMBER() OVER (PARTITION BY c.parent_id ORDER BY c.create_time DESC) AS rn
      FROM comment c
      WHERE c.parent_id IN
      <foreach collection="parentIds" item="parentId" open="(" separator="," close=")">
        #{parentId}
      </foreach>
    ) AS ranked
    WHERE rn &lt;= #{size}
  </select>

  <select id="findRepliesByParentIdByHot" resultMap="BaseResultMap">
    SELECT
    c.*,
    0 AS hot_score <!-- 兼容字段 -->
    FROM comment c
    WHERE c.parent_id = #{parentId}
    ORDER BY c.hot_score DESC, c.create_time DESC
    LIMIT #{offset}, #{size}
  </select>

  <select id="findRepliesByParentIdByTime" resultMap="BaseResultMap">
    SELECT
    c.*,
    0 AS hot_score <!-- 兼容字段 -->
    FROM comment c
    WHERE c.parent_id = #{parentId}
    ORDER BY c.create_time DESC
    LIMIT #{offset}, #{size}
  </select>

  <select id="selectCommentsByIds" resultMap="BaseResultMap">
    SELECT
    <include refid="Base_Column_List"/>
    FROM comment
    WHERE id IN
    <foreach collection="commentIdList" item="id" open="(" separator="," close=")">
      #{id}
    </foreach>
  </select>
  
  <!-- 根据目标类型和目标ID统计评论数 -->
  <select id="countByTargetTypeAndTargetId" resultType="java.lang.Long">
    SELECT COUNT(*)
    FROM comment
    WHERE target_type = #{targetType} AND target_id = #{targetId}
  </select>
  
  <!-- 统计用户的评论数 -->
  <select id="countByUserId" resultType="java.lang.Long">
    SELECT COUNT(*)
    FROM comment
    WHERE user_id = #{userId}
  </select>
  
  <!-- 统计父评论的子评论数 -->
  <select id="countByParentId" resultType="java.lang.Long">
    SELECT COUNT(*)
    FROM comment
    WHERE parent_id = #{parentId}
  </select>
  
  <!-- 统计一级评论数（支持多条件过滤） -->
  <select id="countRootComments" resultType="java.lang.Long">
    SELECT COUNT(*)
    FROM comment
    WHERE (parent_id IS NULL OR parent_id = 0)
    <if test="targetType != null">
        AND target_type = #{targetType}
    </if>
    <if test="targetId != null">
        AND target_id = #{targetId}
    </if>
    <if test="userId != null">
        AND user_id = #{userId}
    </if>
  </select>
  
  <!-- 根据用户ID查询评论列表（分页） -->
  <select id="findByUserId" resultMap="BaseResultMap">
    SELECT
    <include refid="Base_Column_List"/>
    FROM comment
    WHERE user_id = #{userId}
    ORDER BY create_time DESC
    LIMIT #{offset}, #{limit}
  </select>
  
  <!-- 批量统计目标的评论数 -->
  <select id="batchCountByTargetIds" resultType="cn.xu.model.dto.comment.CommentCountResult">
    SELECT target_id as targetId, COUNT(*) as count
    FROM comment
    WHERE target_type = #{targetType} AND target_id IN
    <foreach collection="targetIds" item="targetId" open="(" separator="," close=")">
      #{targetId}
    </foreach>
    GROUP BY target_id
  </select>

  <!-- 根据父评论ID查询子评论列表 -->
  <select id="findByParentId" resultMap="BaseResultMap">
    SELECT
    <include refid="Base_Column_List"/>
    FROM comment
    WHERE parent_id = #{parentId}
    ORDER BY create_time ASC
  </select>
  
  <!-- 批量查询评论（用于缓存预热） -->
  <select id="findCommentsBatch" resultMap="BaseResultMap">
    SELECT
    <include refid="Base_Column_List"/>
    FROM comment
    ORDER BY id
    LIMIT #{offset}, #{batchSize}
  </select>
  
  <!-- 更新评论（全字段更新，慎用） -->
  <update id="updateComment" parameterType="cn.xu.model.entity.Comment">
    UPDATE comment
    SET 
      content = #{content},
      like_count = #{likeCount},
      reply_count = #{replyCount},
      hot_score = #{hotScore},
      update_time = #{updateTime}
    WHERE id = #{id}
  </update>
  
  <!-- 只更新 reply_count（安全方法） -->
  <update id="updateReplyCount">
    UPDATE comment
    SET reply_count = #{replyCount}, update_time = NOW()
    WHERE id = #{commentId}
  </update>
  
  <!-- 增加 reply_count -->
  <update id="incrementReplyCount">
    UPDATE comment
    SET reply_count = COALESCE(reply_count, 0) + 1, update_time = NOW()
    WHERE id = #{commentId}
  </update>
  
  <!-- 减少 reply_count -->
  <update id="decrementReplyCount">
    UPDATE comment
    SET reply_count = GREATEST(COALESCE(reply_count, 0) - 1, 0), update_time = NOW()
    WHERE id = #{commentId}
  </update>
  
  <!-- 统计所有评论数 -->
  <select id="countAll" resultType="java.lang.Long">
    SELECT COUNT(*) FROM comment
  </select>
  
  <!-- 获取评论点赞数 -->
  <select id="getLikeCount" resultType="java.lang.Integer">
    SELECT COALESCE(like_count, 0) FROM comment WHERE id = #{commentId}
  </select>
  
  <!-- 获取评论作者ID -->
  <select id="getAuthorId" resultType="java.lang.Long">
    SELECT user_id FROM comment WHERE id = #{commentId}
  </select>
  
  <!-- 查询所有根评论（管理后台用） -->
  <select id="findAllRootComments" resultMap="BaseResultMap">
    SELECT
    <include refid="Base_Column_List"/>
    FROM comment
    WHERE (parent_id IS NULL OR parent_id = 0)
    <if test="targetType != null">
        AND target_type = #{targetType}
    </if>
    <if test="targetId != null">
        AND target_id = #{targetId}
    </if>
    ORDER BY create_time DESC
    LIMIT #{offset}, #{limit}
  </select>
  
  <!-- 统计根评论数量（管理后台用） -->
  <select id="countAllRootComments" resultType="java.lang.Long">
    SELECT COUNT(*)
    FROM comment
    WHERE (parent_id IS NULL OR parent_id = 0)
    <if test="targetType != null">
        AND target_type = #{targetType}
    </if>
    <if test="targetId != null">
        AND target_id = #{targetId}
    </if>
  </select>
  
  <!-- ==================== 统计相关SQL ==================== -->
  
  <!-- 统计指定时间之后创建的评论数 -->
  <select id="countByCreateTimeAfter" resultType="java.lang.Long">
    SELECT COUNT(*) FROM comment WHERE create_time >= #{createTime}
  </select>
  
  <!-- 统计指定时间范围内创建的评论数 -->
  <select id="countByCreateTimeBetween" resultType="java.lang.Long">
    SELECT COUNT(*) FROM comment WHERE create_time >= #{startTime} AND create_time &lt; #{endTime}
  </select>
</mapper>