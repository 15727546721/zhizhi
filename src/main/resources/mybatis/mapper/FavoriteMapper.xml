<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.xu.repository.mapper.FavoriteMapper">

    <!-- 插入或更新收藏记录 -->
    <insert id="insertOrUpdate" parameterType="cn.xu.model.entity.Favorite">
        INSERT INTO favorite (
            id, user_id, target_id, target_type, status, create_time, update_time
        ) VALUES (
            #{id},
            #{userId},
            #{targetId},
            #{targetType},
            #{status},
            #{createTime},
            #{updateTime}
        ) ON DUPLICATE KEY UPDATE
            status = VALUES(status),
            update_time = VALUES(update_time)
    </insert>

    <!-- 根据用户ID和内容ID查找收藏记录 -->
    <select id="selectByUserIdAndTargetId" resultType="cn.xu.model.entity.Favorite">
        SELECT
            id,
            user_id AS userId,
            target_id AS targetId,
            target_type AS targetType,
            status,
            create_time AS createTime,
            update_time AS updateTime
        FROM favorite
        WHERE user_id = #{userId}
        AND target_id = #{targetId}
        AND target_type = #{targetType}
    </select>

    <!-- 删除收藏记录 -->
    <delete id="deleteByUserIdAndTargetId">
        DELETE FROM favorite
        WHERE user_id = #{userId}
        AND target_id = #{targetId}
        AND target_type = #{targetType}
    </delete>

    <!-- 获取用户收藏的内容ID列表 -->
    <select id="selectFavoritedTargetIdsByUserId" resultType="java.lang.Long">
        SELECT target_id
        FROM favorite
        WHERE user_id = #{userId}
        AND target_type = #{targetType}
        AND status = 1
        ORDER BY create_time DESC
    </select>

    <!-- 分页获取用户收藏的内容ID列表 -->
    <select id="selectFavoritedTargetIdsByUserIdWithPage" resultType="java.lang.Long">
        SELECT target_id
        FROM favorite
        WHERE user_id = #{userId}
        AND target_type = #{targetType}
        AND status = 1
        ORDER BY create_time DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 统计用户收藏的内容数量 -->
    <select id="countFavoritedItemsByUserId" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM favorite
        WHERE user_id = #{userId}
        AND target_type = #{targetType}
        AND status = 1
    </select>
    
    <!-- 统计特定目标的收藏数量（所有用户） -->
    <select id="countFavoritedItemsByTarget" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM favorite
        WHERE target_id = #{targetId}
        AND target_type = #{targetType}
        AND status = 1
    </select>

    <!-- 获取收藏某个目标的用户ID列表 -->
    <select id="selectUserIdsByTarget" resultType="java.lang.Long">
        SELECT user_id
        FROM favorite
        WHERE target_id = #{targetId}
        AND target_type = #{targetType}
        AND status = 1
    </select>
    
    <!-- 统计所有收藏数 -->
    <select id="countAll" resultType="java.lang.Long">
        SELECT COUNT(*) FROM favorite WHERE status = 1
    </select>
    
    <!-- 统计用户收藏总数 -->
    <select id="countByUserId" resultType="java.lang.Long">
        SELECT COUNT(*) FROM favorite WHERE user_id = #{userId} AND status = 1
    </select>

</mapper>