<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.xu.repository.mapper.PrivateMessageMapper">

    <!-- 通用字段映射 -->
    <resultMap id="BaseResultMap" type="cn.xu.model.entity.PrivateMessage">
        <id column="id" property="id"/>
        <result column="sender_id" property="senderId"/>
        <result column="receiver_id" property="receiverId"/>
        <result column="content" property="content"/>
        <result column="is_read" property="isRead"/>
        <result column="status" property="status"/>
        <result column="read_time" property="readTime"/>
        <result column="create_time" property="createTime"/>
    </resultMap>
    
    <!-- 未读消息统计结果映射 -->
    <resultMap id="UnreadCountResultMap" type="cn.xu.repository.impl.PrivateMessageRepository$UnreadCountDto">
        <result column="other_user_id" property="otherUserId"/>
        <result column="unread_count" property="unreadCount"/>
    </resultMap>

    <!-- 插入私信 -->
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO private_message (sender_id, receiver_id, content, is_read, status, create_time)
        VALUES (#{senderId}, #{receiverId}, #{content}, #{isRead}, #{status}, #{createTime})
    </insert>

    <!-- 更新私信 -->
    <update id="update">
        UPDATE private_message
        SET is_read = #{isRead},
            status = #{status}
        WHERE id = #{id}
    </update>

    <!-- 根据ID查询 -->
    <select id="selectById" resultMap="BaseResultMap">
        SELECT id, sender_id, receiver_id, content, is_read, status, read_time, create_time
        FROM private_message
        WHERE id = #{id}
    </select>

    <!-- 查询两个用户之间的私信（双向） -->
    <select id="selectPrivateMessagesBetweenUsers" resultMap="BaseResultMap">
        SELECT id, sender_id, receiver_id, content, is_read, status, read_time, create_time
        FROM private_message
        WHERE ((sender_id = #{userId1} AND receiver_id = #{userId2})
           OR (sender_id = #{userId2} AND receiver_id = #{userId1}))
        ORDER BY create_time DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 查询接收者收到的私信（只显示指定状态的） -->
    <select id="selectPrivateMessagesByReceiver" resultMap="BaseResultMap">
        SELECT id, sender_id, receiver_id, content, is_read, status, read_time, create_time
        FROM private_message
        WHERE receiver_id = #{receiverId}
          AND sender_id = #{senderId}
          AND status = #{status}
        ORDER BY create_time DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 查询发送者发送的私信 -->
    <select id="selectPrivateMessagesBySender" resultMap="BaseResultMap">
        SELECT id, sender_id, receiver_id, content, is_read, status, read_time, create_time
        FROM private_message
        WHERE sender_id = #{senderId}
          AND receiver_id = #{receiverId}
        ORDER BY create_time DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 查询用户的最近私信列表 -->
    <select id="selectLastPrivateMessagesByUser" resultMap="BaseResultMap">
        SELECT m.id, m.sender_id, m.receiver_id, m.content, m.is_read, m.status, m.read_time, m.create_time
        FROM private_message m
        INNER JOIN (
            SELECT 
                CASE WHEN sender_id = #{userId} THEN receiver_id ELSE sender_id END as other_user_id,
                MAX(id) as max_id
            FROM private_message
            WHERE sender_id = #{userId} OR receiver_id = #{userId}
            GROUP BY other_user_id
        ) latest ON m.id = latest.max_id
        ORDER BY m.create_time DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 统计未读私信数量 -->
    <select id="countUnreadPrivateMessages" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM private_message
        WHERE receiver_id = #{receiverId}
          AND sender_id = #{senderId}
          AND is_read = 0
          AND status = 1
    </select>

    <!-- 标记单条消息为已读 -->
    <update id="markAsRead">
        UPDATE private_message
        SET is_read = 1, read_time = NOW()
        WHERE id = #{messageId}
    </update>

    <!-- 批量标记私信为已读 -->
    <update id="markPrivateMessagesAsRead">
        UPDATE private_message
        SET is_read = 1, read_time = NOW()
        WHERE receiver_id = #{receiverId}
          AND sender_id = #{senderId}
          AND is_read = 0
    </update>

    <!-- 更新消息状态 -->
    <update id="updateMessageStatus">
        UPDATE private_message
        SET status = #{newStatus}
        WHERE sender_id = #{senderId}
          AND receiver_id = #{receiverId}
          AND status = #{oldStatus}
    </update>

    <!-- 批量查询对话的最后一条消息 -->
    <select id="selectLastMessagesForConversations" resultMap="BaseResultMap">
        SELECT m.id, m.sender_id, m.receiver_id, m.content, m.is_read, m.status, m.read_time, m.create_time
        FROM private_message m
        INNER JOIN (
            SELECT 
                CASE WHEN sender_id = #{currentUserId} THEN receiver_id ELSE sender_id END as other_user_id,
                MAX(id) as max_id
            FROM private_message
            WHERE (sender_id = #{currentUserId} OR receiver_id = #{currentUserId})
              AND (
                  (sender_id = #{currentUserId} AND receiver_id IN 
                    <foreach collection="otherUserIds" item="id" open="(" separator="," close=")">#{id}</foreach>)
                  OR
                  (receiver_id = #{currentUserId} AND sender_id IN 
                    <foreach collection="otherUserIds" item="id" open="(" separator="," close=")">#{id}</foreach>)
              )
            GROUP BY other_user_id
        ) latest ON m.id = latest.max_id
    </select>

    <!-- 批量统计未读消息数 -->
    <select id="countUnreadMessagesForConversations" resultMap="UnreadCountResultMap">
        SELECT sender_id as other_user_id, COUNT(*) as unread_count
        FROM private_message
        WHERE receiver_id = #{currentUserId}
          AND sender_id IN 
            <foreach collection="otherUserIds" item="id" open="(" separator="," close=")">#{id}</foreach>
          AND is_read = 0
          AND status = 1
        GROUP BY sender_id
    </select>

</mapper>
